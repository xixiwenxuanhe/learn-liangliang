<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="09 应用发布：部署实际项目" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>09 应用发布：部署实际项目 </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/01%20%20%e5%bc%80%e7%af%87%ef%bc%9a%20Kubernetes%20%e6%98%af%e4%bb%80%e4%b9%88%e4%bb%a5%e5%8f%8a%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%ae%83.md.html" id="01  开篇： Kubernetes 是什么以及为什么需要它.md.html">01  开篇： Kubernetes 是什么以及为什么需要它.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/02%20%e5%88%9d%e6%ad%a5%e8%ae%a4%e8%af%86%ef%bc%9aKubernetes%20%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5.md.html" id="02 初步认识：Kubernetes 基础概念.md.html">02 初步认识：Kubernetes 基础概念.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/03%20%e5%ae%8f%e8%a7%82%e8%ae%a4%e8%af%86%ef%bc%9a%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84.md.html" id="03 宏观认识：整体架构.md.html">03 宏观认识：整体架构.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/04%20%e6%90%ad%e5%bb%ba%20Kubernetes%20%e9%9b%86%e7%be%a4%20-%20%e6%9c%ac%e5%9c%b0%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba.md.html" id="04 搭建 Kubernetes 集群 - 本地快速搭建.md.html">04 搭建 Kubernetes 集群 - 本地快速搭建.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/05%20%e5%8a%a8%e6%89%8b%e5%ae%9e%e8%b7%b5%ef%bc%9a%e6%90%ad%e5%bb%ba%e4%b8%80%e4%b8%aa%20Kubernetes%20%e9%9b%86%e7%be%a4%20-%20%e7%94%9f%e4%ba%a7%e5%8f%af%e7%94%a8.md.html" id="05 动手实践：搭建一个 Kubernetes 集群 - 生产可用.md.html">05 动手实践：搭建一个 Kubernetes 集群 - 生产可用.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/06%20%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86%ef%bc%9a%e5%88%9d%e8%af%86%20kubectl.md.html" id="06 集群管理：初识 kubectl.md.html">06 集群管理：初识 kubectl.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/07%20%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86%ef%bc%9a%e4%bb%a5%20Redis%20%e4%b8%ba%e4%be%8b-%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%ae%bf%e9%97%ae.md.html" id="07 集群管理：以 Redis 为例-部署及访问.md.html">07 集群管理：以 Redis 为例-部署及访问.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/08%20%e5%ae%89%e5%85%a8%e9%87%8d%e7%82%b9%20%e8%ae%a4%e8%af%81%e5%92%8c%e6%8e%88%e6%9d%83.md.html" id="08 安全重点 认证和授权.md.html">08 安全重点 认证和授权.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/09%20%e5%ba%94%e7%94%a8%e5%8f%91%e5%b8%83%ef%bc%9a%e9%83%a8%e7%bd%b2%e5%ae%9e%e9%99%85%e9%a1%b9%e7%9b%ae.md.html" id="09 应用发布：部署实际项目.md.html">09 应用发布：部署实际项目.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/10%20%e5%ba%94%e7%94%a8%e7%ae%a1%e7%90%86%ef%bc%9a%e5%88%9d%e8%af%86%20Helm.md.html" id="10 应用管理：初识 Helm.md.html">10 应用管理：初识 Helm.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/11%20%e9%83%a8%e7%bd%b2%e5%ae%9e%e8%b7%b5%ef%bc%9a%e4%bb%a5%20Helm%20%e9%83%a8%e7%bd%b2%e9%a1%b9%e7%9b%ae.md.html" id="11 部署实践：以 Helm 部署项目.md.html">11 部署实践：以 Helm 部署项目.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/12%20%e5%ba%96%e4%b8%81%e8%a7%a3%e7%89%9b%ef%bc%9akube-apiserver.md.html" id="12 庖丁解牛：kube-apiserver.md.html">12 庖丁解牛：kube-apiserver.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/13%20%e5%ba%96%e4%b8%81%e8%a7%a3%e7%89%9b%ef%bc%9aetcd.md.html" id="13 庖丁解牛：etcd.md.html">13 庖丁解牛：etcd.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/14%20%e5%ba%96%e4%b8%81%e8%a7%a3%e7%89%9b%ef%bc%9acontroller-manager.md.html" id="14 庖丁解牛：controller-manager.md.html">14 庖丁解牛：controller-manager.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/15%20%e5%ba%96%e4%b8%81%e8%a7%a3%e7%89%9b%ef%bc%9akube-scheduler.md.html" id="15 庖丁解牛：kube-scheduler.md.html">15 庖丁解牛：kube-scheduler.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/16%20%e5%ba%96%e4%b8%81%e8%a7%a3%e7%89%9b%ef%bc%9akubelet.md.html" id="16 庖丁解牛：kubelet.md.html">16 庖丁解牛：kubelet.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/17%20%e5%ba%96%e4%b8%81%e8%a7%a3%e7%89%9b%ef%bc%9akube-proxy.md.html" id="17 庖丁解牛：kube-proxy.md.html">17 庖丁解牛：kube-proxy.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/18%20%20%e5%ba%96%e4%b8%81%e8%a7%a3%e7%89%9b%ef%bc%9aContainer%20Runtime%20%ef%bc%88Docker%ef%bc%89.md.html" id="18  庖丁解牛：Container Runtime （Docker）.md.html">18  庖丁解牛：Container Runtime （Docker）.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/19%20Troubleshoot.md.html" id="19 Troubleshoot.md.html">19 Troubleshoot.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/20%20%e6%89%a9%e5%b1%95%e5%a2%9e%e5%bc%ba%ef%bc%9aDashboard.md.html" id="20 扩展增强：Dashboard.md.html">20 扩展增强：Dashboard.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/21%20%e6%89%a9%e5%b1%95%e5%a2%9e%e5%bc%ba%ef%bc%9aCoreDNS.md.html" id="21 扩展增强：CoreDNS.md.html">21 扩展增强：CoreDNS.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/22%20%e6%9c%8d%e5%8a%a1%e5%a2%9e%e5%bc%ba%ef%bc%9aIngress.md.html" id="22 服务增强：Ingress.md.html">22 服务增强：Ingress.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/23%20%e7%9b%91%e6%8e%a7%e5%ae%9e%e8%b7%b5%ef%bc%9a%e5%af%b9%20K8S%20%e9%9b%86%e7%be%a4%e8%bf%9b%e8%a1%8c%e7%9b%91%e6%8e%a7.md.html" id="23 监控实践：对 K8S 集群进行监控.md.html">23 监控实践：对 K8S 集群进行监控.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%20%e4%bb%8e%e4%b8%8a%e6%89%8b%e5%88%b0%e5%ae%9e%e8%b7%b5/24%20%e6%80%bb%e7%bb%93.md.html" id="24 总结.md.html">24 总结.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="09 应用发布：部署实际项目" id="title">09 应用发布：部署实际项目</h1>
<div><p>本节我们开始学习如何将实际项目部署至 K8S 中，开启生产实践之路。</p>
<h2 id="整体概览">整体概览</h2>
<p>本节所用示例项目是一个混合了 Go，NodeJS，Python 等语言的项目，灵感来自于知名程序员 <a href="https://github.com/kennethreitz" target="_blank">Kenneth Reitz</a> 的 <a href="https://saythanks.io/" target="_blank">Say Thanks</a> 项目。本项目实现的功能主要有两个：1. 用户通过前端发送感谢消息 2. 有个工作进程会持续的计算收到感谢消息的排行榜。项目代码可在 <a href="https://github.com/tao12345666333/saythx" target="_blank">GitHub 上获得</a>。接下来几节中如果需要用到此项目我会统一称之为 saythx 项目。</p>
<p>saythx 项目的基础结构如下图：</p>
<p><img alt="img" src="assets/16722d23f282fa8b"/></p>
<h2 id="构建镜像">构建镜像</h2>
<h3 id="前端">前端</h3>
<p>我们使用了前端框架 <a href="https://vuejs.org/" target="_blank">Vue</a>，所以在做生产部署时，需要先在 <a href="http://nodejs.org/" target="_blank">Node JS</a> 的环境下进行打包构建。包管理器使用的是 <a href="https://yarnpkg.com/" target="_blank">Yarn</a>。然后使用 <a href="http://nginx.com/" target="_blank">Nginx</a> 提供服务，并进行反向代理，将请求正确的代理至后端。</p>
<pre><code>FROM node:10.13 as builder

WORKDIR /app
COPY . /app

RUN yarn install \
        &amp;&amp; yarn build

FROM nginx:1.15

COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/dist /usr/share/nginx/html/

EXPOSE 80
</code></pre>
<p>Nginx 的配置文件如下：</p>
<pre><code>upstream backend-up {
    server saythx-backend:8080;
}
server {
    listen       80;
    server_name  localhost;

    charset     utf-8;

    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    location ~ ^/(api) {
        proxy_pass   http://backend-up;
    }
}
</code></pre>
<p>将 API 的请求反向代理到后端服务上。其余请求全部留给前端进行处理。</p>
<h3 id="后端">后端</h3>
<p>后端是使用 <a href="https://golang.org/" target="_blank">Golang</a> 编写的 API 服务，对请求进行相应处理，并将数据存储至 <a href="http://redis.io/" target="_blank">Redis</a> 当中。依赖管理使用的是 <a href="https://github.com/golang/dep" target="_blank">dep</a>。由于 Golang 是编译型语言，编译完成后会生成一个二进制文件，为了让镜像尽可能小，所以 Dockerfile 和前端的差不多，都使用了<a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank">多阶段构建</a>的特性。</p>
<pre><code>FROM golang:1.11.1 as builder

WORKDIR /go/src/be
COPY . /go/src/be
RUN go get -u github.com/golang/dep/cmd/dep \
        &amp;&amp; dep ensure \
        &amp;&amp; go build

FROM debian:stretch-slim
COPY --from=builder /go/src/be/be /usr/bin/be
ENTRYPOINT ["/usr/bin/be"]
EXPOSE 8080
</code></pre>
<p>注意这里会暴露出来后端服务所监听的端口。</p>
<h3 id="work">Work</h3>
<p>Work 端使用的是 <a href="https://python.org/" target="_blank">Python</a>，用于计算已经存储至 Redis 当中的数据，并生成排行榜。依赖使用 <a href="https://github.com/pypa/pip" target="_blank">pip</a> 进行安装。对于 Python 的镜像选择，我做了一组<a href="http://moelove.info/docker-python-perf/" target="_blank">性能对比的测试</a> 有兴趣可以了解下。</p>
<pre><code>FROM python:3.7-slim

WORKDIR /app
COPY . /app
RUN pip install -r requirements.txt

ENTRYPOINT ["python", "work.py"]
</code></pre>
<h3 id="构建发布">构建发布</h3>
<p>接下来，我们只要在对应项目目录中，执行 <code>docker build [OPTIONS] PATH</code> 即可。一般我们会使用 <code>-t name:tag</code> 的方式打 tag。</p>
<pre><code># 以下分别是在各模块自己的目录内
➜  be docker build -t  taobeier/saythx-be .
➜  fe docker build -t  taobeier/saythx-fe .
➜  work docker build -t  taobeier/saythx-work .
</code></pre>
<p>需要注意的是，前端项目由于目录内包含开发时的 <code>node_modules</code> 等文件，需要注意添加 <code>.dockerignore</code> 文件，忽略一些非预期的文件。关于 Docker 的 build 原理，有想深入理解的，可参考我之前写的 <a href="http://moelove.info/2018/09/04/Docker-深入篇之-Build-原理/" target="_blank">Docker 深入篇之 Build 原理</a> 。 当镜像构建完成后，我们需要将它们发布至镜像仓库。这里我们直接使用官方的 <a href="http://hub.docker.com/" target="_blank">Docker Hub</a>，执行 <code>docker login</code> 输入用户名密码验证成功后便可进行发布（需要先去 Docker Hub 注册帐号）。</p>
<p>登录成功后，默认情况下在 <code>$HOME/.docker/config.json</code> 中会存储用户相关凭证。</p>
<p>接下来进行发布只需要执行 <code>docker push</code> 即可。</p>
<pre><code>➜  ~ docker push taobeier/saythx-be
➜  ~ docker push taobeier/saythx-fe
➜  ~ docker push taobeier/saythx-work
</code></pre>
<h2 id="容器编排-docker-compose">容器编排 Docker Compose</h2>
<p><a href="https://docs.docker.com/compose/overview/" target="_blank">Docker Compose</a> 是一种较为简单的可进行容器编排的技术，需要创建一个配置文件，通常情况下为 <code>docker-compose.yml</code> 。在 saythx 项目的根目录下我已经创建好了 <code>docker-compose.yml</code> 的配置文件。</p>
<pre><code>version: '3'

services:
  saythx-frontend:
    build:
      context: fe/.
    image: taobeier/saythx-fe
    ports:
      - "8088:80"
    depends_on:
      - saythx-backend
    networks:
      - saythx

  saythx-backend:
    build:
      context: be/.
    image: taobeier/saythx-be
    depends_on:
      - saythx-redis
    networks:
      - saythx
    environment:
      - REDIS_HOST=saythx-redis
    
  saythx-work:
    build:
      context: work/.
    image: taobeier/saythx-work
    depends_on:
      - saythx-redis
    networks:
      - saythx
    environment:
      - REDIS_HOST=saythx-redis
      - REDIS_PORT=6379

  saythx-redis:
    image: "redis:5"
    networks:
      - saythx

networks:
  saythx:
</code></pre>
<p>在项目的根目录下执行 <code>docker-compose up</code> 即可启动该项目。在浏览器中访问 <a href="http://127.0.0.1:8088/" target="_blank">http://127.0.0.1:8088/</a> 即可看到项目的前端界面。如下图：</p>
<p><img alt="img" src='data:image/svg+xml;utf8,&lt;?xml version="1.0"?&gt;&lt;svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="628"&gt;&lt;/svg'/></p>
<p>打开另外的终端，进入项目根目录内，执行 <code>docker-compose ps</code> 命令即可看到当前的服务情况。</p>
<pre><code>➜  saythx git:(master) ✗ docker-compose ps

          Name                        Command               State          Ports
----------------------------------------------------------------------------------------
saythx_saythx-backend_1    /usr/bin/be                      Up      8080/tcp
saythx_saythx-frontend_1   nginx -g daemon off;             Up      0.0.0.0:8088-&gt;80/tcp
saythx_saythx-redis_1      docker-entrypoint.sh redis ...   Up      6379/tcp
saythx_saythx-work_1       python work.py                   Up
</code></pre>
<p>可以看到各组件均是 <code>Up</code> 的状态，相关端口也已经暴露出来。</p>
<p>可在浏览器直接访问体验。由于 <code>Docker Compose</code> 并非本册的重点，故不做太多介绍，可参考官方文档进行学习。接下来进入本节的重点内容，将项目部署至 K8S 中。</p>
<h2 id="编写配置文件并部署">编写配置文件并部署</h2>
<p>在 K8S 中进行部署或者说与 K8S 交互的方式主要有三种：</p>
<ul>
<li>命令式</li>
<li>命令式对象配置</li>
<li>声明式对象配置</li>
</ul>
<p>第 7 节介绍过的 <code>kubectl run redis --image='redis:alpine'</code> 这种方式便是命令式，这种方式很简单，但是可重用性低。毕竟你的命令执行完后，其他人也并不清楚到底发生了什么。</p>
<p>命令式对象配置，主要是编写配置文件，但是通过类似 <code>kubectl create</code> 之类命令式的方式进行操作。</p>
<p>再有一种便是声明式对象配置，主要也是通过编写配置文件，但是使用 <code>kubectl apply</code> 之类的放好似进行操作。与第二种命令式对象配置的区别主要在于对对象的操作将会得到保留。但同时这种方式有时候也并不好进行调试。</p>
<p>接下来，为 saythx 项目编写配置文件，让它可以部署至 K8S 中。当然，这里我们已经创建过了 <code>docker-compose.yml</code> 的配置文件，并且也验证了其可用性，可以直接使用 <a href="https://github.com/kubernetes/kompose" target="_blank">Kompose</a> 工具将 <code>docker-compose.yml</code> 的配置文件进行转换。</p>
<p>但这里采用直接编写的方式。同时，我们部署至一个新的名为 <code>work</code> 的 <code>Namespace</code> 中。</p>
<h3 id="namespace">Namespace</h3>
<pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: work
</code></pre>
<p>指定了 <code>Namespace</code> name 为 <code>work</code>。然后进行部署</p>
<pre><code>➜  conf git:(master) ✗ kubectl apply -f namespace.yaml 
namespace/work created
</code></pre>
<h3 id="redis-资源">Redis 资源</h3>
<p>从前面的 <code>docker-compose.yml</code> 中也能发现，saythx 中各个组件，只有 Redis 是无任何依赖的。我们先对它进行部署。</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: redis
  name: saythx-redis
  namespace: work
spec:
  selector:
    matchLabels:
      app: redis
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - image: redis:5
        name: redis
        ports:
        - containerPort: 6379
</code></pre>
<p>由于这是本册内第一次出现完整的 <code>Deployment</code> 配置文件，故而进行重点介绍。</p>
<ul>
<li><code>apiVersion</code> ：指定了 API 的版本号，当前我们使用的 K8S 中， <code>Deployment</code> 的版本号为 <code>apps/v1</code>，而在 1.9 之前使用的版本则为 <code>apps/v1beta2</code>，在 1.8 之前的版本使用的版本为 <code>extensions/v1beta1</code>。在编写配置文件时需要格外注意。</li>
<li><code>kind</code> ：指定了资源的类型。这里指定为 <code>Deployment</code> 说明是一次部署。</li>
<li><code>metadata</code> ：指定了资源的元信息。例如其中的 <code>name</code> 和 <code>namespace</code> 分别表示资源名称和所归属的 <code>Namespace</code>。</li>
<li><code>spec</code> ：指定了对资源的配置信息。例如其中的 <code>replicas</code> 指定了副本数当前指定为 1 。<code>template.spec</code> 则指定了 <code>Pod</code> 中容器的配置信息，这里的 <code>Pod</code> 中只部署了一个容器。</li>
</ul>
<p>配置文件已经生产，现在对它进行部署。</p>
<pre><code>➜  conf git:(master) ✗ kubectl -n work get all
No resources found.
➜  conf git:(master) ✗ kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
➜  conf git:(master) ✗ kubectl -n work get all
NAME                                READY     STATUS    RESTARTS   AGE
pod/saythx-redis-79d8f9864d-x8fp9   1/1       Running   0          4s

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   1         1         1            1           4s

NAME                                      DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-redis-79d8f9864d   1         1         1         4s
</code></pre>
<p>可以看到 <code>Pod</code> 已经在正常运行了。我们进入 <code>Pod</code> 内进行测试。</p>
<pre><code>➜  conf git:(master) ✗ kubectl -n work exec -it saythx-redis-79d8f9864d-x8fp9 bash
root@saythx-redis-79d8f9864d-x8fp9:/data# redis-cli
127.0.0.1:6379&gt; ping
PONG
</code></pre>
<p>响应正常。</p>
<h3 id="redis-service">Redis service</h3>
<p>由于 <code>Redis</code> 是后端服务的依赖，我们将它作为 <code>Service</code> 暴露出来。</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: redis
  name: saythx-redis
  namespace: work
spec:
  ports:
  - protocol: TCP
    port: 6379
    targetPort: 6379
  selector:
    app: redis
  type: NodePort
</code></pre>
<p>关于 <code>Service</code> 的内容，可参考第 7 节，我们详细做过解释。这里直接使用配置文件进行部署。</p>
<pre><code>➜  conf git:(master) ✗ kubectl apply -f redis-service.yaml
service/saythx-redis created
➜  conf git:(master) ✗ kubectl get svc -n work
NAME           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
saythx-redis   NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   1m
</code></pre>
<h3 id="后端服务">后端服务</h3>
<p>接下来，我们对后端服务进行部署。</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: backend
  name: saythx-backend
  namespace: work
spec:
  selector:
    matchLabels:
      app: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - env:
        - name: REDIS_HOST
          value: saythx-redis
        image: taobeier/saythx-be
        name: backend
        ports:
        - containerPort: 8080
</code></pre>
<p>可以看到这里通过环境变量的方式，将 <code>REDIS_HOST</code> 传递给了后端服务。</p>
<pre><code>➜  conf git:(master) ✗ kubectl apply -f backend-deployment.yaml
deployment.apps/saythx-backend created
➜  conf git:(master) ✗ kubectl -n work get all
NAME                                 READY     STATUS              RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn   0/1       ContainerCreating   0          5s
pod/saythx-redis-8558c7d7d-kcmzk     1/1       Running             0          17m

NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   1m

NAME                             DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend   1         1         1            0           5s
deployment.apps/saythx-redis     1         1         1            1           17m

NAME                                       DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95   1         1         0         5s
replicaset.apps/saythx-redis-8558c7d7d     1         1         1         17m
</code></pre>
<h3 id="后端-service">后端 Service</h3>
<p>后端服务是前端项目的依赖，故而我们也将其作为 <code>Service</code> 暴露出来。</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: backend
  name: saythx-backend
  namespace: work
spec:
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  selector:
    app: backend
  type: NodePort
</code></pre>
<p>通过配置文件进行部署。</p>
<pre><code>➜  conf git:(master) ✗ kubectl apply -f backend-service.yaml
service/saythx-backend created
➜  conf git:(master) ✗ kubectl get svc -n work
NAME                     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-backend   NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   8s
service/saythx-redis     NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   3m
</code></pre>
<p>我们同样使用 <code>NodePort</code> 将其暴露出来，并在本地进行测试。</p>
<pre><code>➜  conf git:(master) ✗ curl http://127.0.0.1:32051/api/v1/list
{"HonorDatas":null}
</code></pre>
<p>服务可正常响应。</p>
<h3 id="前端-1">前端</h3>
<p>接下来我们编写前端的配置文件。</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: frontend
  name: saythx-frontend
  namespace: work
spec:
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - image: taobeier/saythx-fe
        name: frontend
        ports:
        - containerPort: 80
</code></pre>
<p>需要注意的是，我们必须在后端 <code>Service</code> 暴露出来后才能进行前端的部署，因为前端镜像中 Nginx 的反向代理配置中会去检查后端是否可达。使用配置文件进行部署。</p>
<pre><code>➜  conf git:(master) ✗ kubectl apply -f frontend-deployment.yaml
deployment.apps/saythx-frontend created
➜  conf git:(master) ✗ kubectl -n work get all
NAME                                   READY     STATUS    RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn     1/1       Running   0          16m
pod/saythx-frontend-678d544b86-wp9gr   1/1       Running   0          30s
pod/saythx-redis-8558c7d7d-kcmzk       1/1       Running   0          34m

NAME                     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-backend   NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   15m
service/saythx-redis     NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   18m

NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend    1         1         1            1           16m
deployment.apps/saythx-frontend   1         1         1            1           30s
deployment.apps/saythx-redis      1         1         1            1           34m

NAME                                         DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95     1         1         1         16m
replicaset.apps/saythx-frontend-678d544b86   1         1         1         30s
replicaset.apps/saythx-redis-8558c7d7d       1         1         1         34m
</code></pre>
<h3 id="前端-service">前端 Service</h3>
<p>接下来，我们需要让前端可以被直接访问到，同样的需要将它以 <code>Service</code> 的形式暴露出来。</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: frontend
  name: saythx-frontend
  namespace: work
spec:
  ports:
  - name: "80"
    port: 80
    targetPort: 80
  selector:
    app: frontend
  type: NodePort
</code></pre>
<p>创建 <code>Service</code> 。</p>
<pre><code>➜  conf git:(master) ✗ kubectl apply -f frontend-service.yaml
service/saythx-frontend created
➜  conf git:(master) ✗ kubectl -n work get svc
NAME              TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
saythx-backend    NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   17m
saythx-frontend   NodePort   10.96.221.71    &lt;none&gt;        80:32682/TCP     11s
saythx-redis      NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   20m
</code></pre>
<p>我们可以直接通过 Node 的 32682 端口进行访问。</p>
<h3 id="work-1">Work</h3>
<p>最后，是我们的 Work 组件，为它编写配置文件。</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: work
  name: saythx-work
  namespace: work
spec:
  selector:
    matchLabels:
      app: work
  replicas: 1
  template:
    metadata:
      labels:
        app: work
    spec:
      containers:
      - env:
        - name: REDIS_HOST
          value: saythx-redis
        - name: REDIS_PORT
          value: "6379"
        image: taobeier/saythx-work
        name: work
</code></pre>
<p>同样的，我们通过环境变量的方式传递了 Redis 相关的配置进去。</p>
<pre><code>➜  conf git:(master) ✗ kubectl apply -f work-deployment.yaml
deployment.apps/saythx-work created
➜  conf git:(master) ✗ kubectl -n work get all
NAME                                   READY     STATUS              RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn     1/1       Running             0          22m
pod/saythx-frontend-678d544b86-wp9gr   1/1       Running             0          5m
pod/saythx-redis-8558c7d7d-kcmzk       1/1       Running             0          39m
pod/saythx-work-6b9958dc47-hh9td       0/1       ContainerCreating   0          7s

NAME                      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-backend    NodePort   10.104.0.47     &lt;none&gt;        8080:32051/TCP   20m
service/saythx-frontend   NodePort   10.96.221.71    &lt;none&gt;        80:32682/TCP     3m
service/saythx-redis      NodePort   10.107.31.242   &lt;none&gt;        6379:31467/TCP   23m

NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend    1         1         1            1           22m
deployment.apps/saythx-frontend   1         1         1            1           5m
deployment.apps/saythx-redis      1         1         1            1           39m
deployment.apps/saythx-work       1         1         1            0           7s

NAME                                         DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95     1         1         1         22m
replicaset.apps/saythx-frontend-678d544b86   1         1         1         5m
replicaset.apps/saythx-redis-8558c7d7d       1         1         1         39m
replicaset.apps/saythx-work-6b9958dc47       1         1         0         7s
</code></pre>
<p>现在均已经部署完成。并且可直接通过 Node 端口进行访问。</p>
<h2 id="扩缩容">扩缩容</h2>
<p>如果我们觉得排行榜生成效率较低，则可通过扩容 Work 来得到解决。具体做法是可修改 work 的 <code>Deployment</code> 配置文件，将 <code>spec.replicas</code> 设置为预期的数值，之后执行 <code>kubectl -f work-deployment.yaml</code> 即可。</p>
<p>或者可直接通过命令行进行操作</p>
<pre><code>➜  conf git:(master) ✗ kubectl -n work scale --replicas=2  deployment/saythx-work
</code></pre>
<p>上面的命令是将 <code>saythx-work</code> 的部署副本数设置为 2 。缩容也差不多是类似的操作。</p>
<h2 id="总结">总结</h2>
<p>通过本节的学习，我们已经学习到了如何将项目实际部署至 K8S 中，可以手动编写配置也可以利用一些工具进行辅助。同时也了解到了如何应对应用的扩缩容。</p>
<p>但如果应用需要进行升级的话，则需要去更改配置文件中相关的配置，这个过程会较为繁琐，并且整体项目线上的版本管理也是个问题：比如组件的个人升级，回滚之间如果有依赖的话，会比较麻烦。我们在接下来的两节来学习如何解决这个问题。</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#1f737373262b2e2e2f285f78727e7673317c7072" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93579051b92f43da',t:'MTc0NTUxODI5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>