<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="协议专栏特别福利 答疑解惑3期" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>协议专栏特别福利 答疑解惑3期 </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%e6%83%b3%e6%88%90%e4%b8%ba%e6%8a%80%e6%9c%af%e7%89%9b%e4%ba%ba%ef%bc%9f%e5%85%88%e6%90%9e%e5%ae%9a%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%ef%bc%81.md.html" id="00 开篇词 想成为技术牛人？先搞定网络协议！.md.html">00 开篇词 想成为技术牛人？先搞定网络协议！.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/01%20%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e5%ad%a6%e4%b9%a0%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%ef%bc%9f.md.html" id="01 为什么要学习网络协议？.md.html">01 为什么要学习网络协议？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/02%20%e7%bd%91%e7%bb%9c%e5%88%86%e5%b1%82%e7%9a%84%e7%9c%9f%e5%ae%9e%e5%90%ab%e4%b9%89%e6%98%af%e4%bb%80%e4%b9%88%ef%bc%9f.md.html" id="02 网络分层的真实含义是什么？.md.html">02 网络分层的真实含义是什么？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/03%20ifconfig%ef%bc%9a%e6%9c%80%e7%86%9f%e6%82%89%e5%8f%88%e9%99%8c%e7%94%9f%e7%9a%84%e5%91%bd%e4%bb%a4%e8%a1%8c.md.html" id="03 ifconfig：最熟悉又陌生的命令行.md.html">03 ifconfig：最熟悉又陌生的命令行.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/04%20DHCP%e4%b8%8ePXE%ef%bc%9aIP%e6%98%af%e6%80%8e%e4%b9%88%e6%9d%a5%e7%9a%84%ef%bc%8c%e5%8f%88%e6%98%af%e6%80%8e%e4%b9%88%e6%b2%a1%e7%9a%84%ef%bc%9f.md.html" id="04 DHCP与PXE：IP是怎么来的，又是怎么没的？.md.html">04 DHCP与PXE：IP是怎么来的，又是怎么没的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/05%20%e4%bb%8e%e7%89%a9%e7%90%86%e5%b1%82%e5%88%b0MAC%e5%b1%82%ef%bc%9a%e5%a6%82%e4%bd%95%e5%9c%a8%e5%ae%bf%e8%88%8d%e9%87%8c%e8%87%aa%e5%b7%b1%e7%bb%84%e7%bd%91%e7%8e%a9%e8%81%94%e6%9c%ba%e6%b8%b8%e6%88%8f%ef%bc%9f.md.html" id="05 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？.md.html">05 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/06%20%e4%ba%a4%e6%8d%a2%e6%9c%ba%e4%b8%8eVLAN%ef%bc%9a%e5%8a%9e%e5%85%ac%e5%ae%a4%e5%a4%aa%e5%a4%8d%e6%9d%82%ef%bc%8c%e6%88%91%e8%a6%81%e5%9b%9e%e5%ad%a6%e6%a0%a1.md.html" id="06 交换机与VLAN：办公室太复杂，我要回学校.md.html">06 交换机与VLAN：办公室太复杂，我要回学校.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/07%20ICMP%e4%b8%8eping%ef%bc%9a%e6%8a%95%e7%9f%b3%e9%97%ae%e8%b7%af%e7%9a%84%e4%be%a6%e5%af%9f%e5%85%b5.md.html" id="07 ICMP与ping：投石问路的侦察兵.md.html">07 ICMP与ping：投石问路的侦察兵.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/08%20%e4%b8%96%e7%95%8c%e8%bf%99%e4%b9%88%e5%a4%a7%ef%bc%8c%e6%88%91%e6%83%b3%e5%87%ba%e7%bd%91%e5%85%b3%ef%bc%9a%e6%ac%a7%e6%b4%b2%e5%8d%81%e5%9b%bd%e6%b8%b8%e4%b8%8e%e7%8e%84%e5%a5%98%e8%a5%bf%e8%a1%8c.md.html" id="08 世界这么大，我想出网关：欧洲十国游与玄奘西行.md.html">08 世界这么大，我想出网关：欧洲十国游与玄奘西行.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/09%20%e8%b7%af%e7%94%b1%e5%8d%8f%e8%ae%ae%ef%bc%9a%e8%a5%bf%e5%87%ba%e7%bd%91%e5%85%b3%e6%97%a0%e6%95%85%e4%ba%ba%ef%bc%8c%e6%95%a2%e9%97%ae%e8%b7%af%e5%9c%a8%e4%bd%95%e6%96%b9.md.html" id="09 路由协议：西出网关无故人，敢问路在何方.md.html">09 路由协议：西出网关无故人，敢问路在何方.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/10%20UDP%e5%8d%8f%e8%ae%ae%ef%bc%9a%e5%9b%a0%e6%80%a7%e5%96%84%e8%80%8c%e7%ae%80%e5%8d%95%ef%bc%8c%e9%9a%be%e5%85%8d%e7%a2%b0%e5%88%b0%e2%80%9c%e5%9f%8e%e4%bc%9a%e7%8e%a9%e2%80%9d.md.html" id="10 UDP协议：因性善而简单，难免碰到“城会玩”.md.html">10 UDP协议：因性善而简单，难免碰到“城会玩”.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/11%20TCP%e5%8d%8f%e8%ae%ae%ef%bc%88%e4%b8%8a%ef%bc%89%ef%bc%9a%e5%9b%a0%e6%80%a7%e6%81%b6%e8%80%8c%e5%a4%8d%e6%9d%82%ef%bc%8c%e5%85%88%e6%81%b6%e5%90%8e%e5%96%84%e5%8f%8d%e8%bd%bb%e6%9d%be.md.html" id="11 TCP协议（上）：因性恶而复杂，先恶后善反轻松.md.html">11 TCP协议（上）：因性恶而复杂，先恶后善反轻松.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/12%20TCP%e5%8d%8f%e8%ae%ae%ef%bc%88%e4%b8%8b%ef%bc%89%ef%bc%9a%e8%a5%bf%e8%a1%8c%e5%bf%85%e5%ae%9a%e5%a4%9a%e5%a6%96%e5%ad%bd%ef%bc%8c%e6%81%92%e5%bf%83%e6%99%ba%e6%85%a7%e6%b6%88%e7%a3%a8%e9%9a%be.md.html" id="12 TCP协议（下）：西行必定多妖孽，恒心智慧消磨难.md.html">12 TCP协议（下）：西行必定多妖孽，恒心智慧消磨难.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/13%20%e5%a5%97%e6%8e%a5%e5%ad%97Socket%ef%bc%9aTalk%20is%20cheap,%20show%20me%20the%20code.md.html" id="13 套接字Socket：Talk is cheap, show me the code.md.html">13 套接字Socket：Talk is cheap, show me the code.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/14%20HTTP%e5%8d%8f%e8%ae%ae%ef%bc%9a%e7%9c%8b%e4%b8%aa%e6%96%b0%e9%97%bb%e5%8e%9f%e6%9d%a5%e8%bf%99%e4%b9%88%e9%ba%bb%e7%83%a6.md.html" id="14 HTTP协议：看个新闻原来这么麻烦.md.html">14 HTTP协议：看个新闻原来这么麻烦.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/15%20HTTPS%e5%8d%8f%e8%ae%ae%ef%bc%9a%e7%82%b9%e5%a4%96%e5%8d%96%e7%9a%84%e8%bf%87%e7%a8%8b%e5%8e%9f%e6%9d%a5%e8%bf%99%e4%b9%88%e5%a4%8d%e6%9d%82.md.html" id="15 HTTPS协议：点外卖的过程原来这么复杂.md.html">15 HTTPS协议：点外卖的过程原来这么复杂.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/16%20%e6%b5%81%e5%aa%92%e4%bd%93%e5%8d%8f%e8%ae%ae%ef%bc%9a%e5%a6%82%e4%bd%95%e5%9c%a8%e7%9b%b4%e6%92%ad%e9%87%8c%e7%9c%8b%e5%88%b0%e7%be%8e%e5%a5%b3%e5%b8%85%e5%93%a5%ef%bc%9f.md.html" id="16 流媒体协议：如何在直播里看到美女帅哥？.md.html">16 流媒体协议：如何在直播里看到美女帅哥？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/17%20P2P%e5%8d%8f%e8%ae%ae%ef%bc%9a%e6%88%91%e4%b8%8b%e5%b0%8f%e7%94%b5%e5%bd%b1%ef%bc%8c99%25%e6%80%a5%e6%ad%bb%e4%bd%a0.md.html" id="17 P2P协议：我下小电影，99%急死你.md.html">17 P2P协议：我下小电影，99%急死你.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/18%20DNS%e5%8d%8f%e8%ae%ae%ef%bc%9a%e7%bd%91%e7%bb%9c%e4%b8%96%e7%95%8c%e7%9a%84%e5%9c%b0%e5%9d%80%e7%b0%bf.md.html" id="18 DNS协议：网络世界的地址簿.md.html">18 DNS协议：网络世界的地址簿.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/19%20HttpDNS%ef%bc%9a%e7%bd%91%e7%bb%9c%e4%b8%96%e7%95%8c%e7%9a%84%e5%9c%b0%e5%9d%80%e7%b0%bf%e4%b9%9f%e4%bc%9a%e6%8c%87%e9%94%99%e8%b7%af.md.html" id="19 HttpDNS：网络世界的地址簿也会指错路.md.html">19 HttpDNS：网络世界的地址簿也会指错路.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/20%20CDN%ef%bc%9a%e4%bd%a0%e5%8e%bb%e5%b0%8f%e5%8d%96%e9%83%a8%e5%8f%96%e8%bf%87%e5%bf%ab%e9%80%92%e4%b9%88%ef%bc%9f.md.html" id="20 CDN：你去小卖部取过快递么？.md.html">20 CDN：你去小卖部取过快递么？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/21%20%e6%95%b0%e6%8d%ae%e4%b8%ad%e5%bf%83%ef%bc%9a%e6%88%91%e6%98%af%e5%bc%80%e5%8f%91%e5%95%86%ef%bc%8c%e8%87%aa%e5%b7%b1%e6%8b%bf%e5%9c%b0%e7%9b%96%e5%88%ab%e5%a2%85.md.html" id="21 数据中心：我是开发商，自己拿地盖别墅.md.html">21 数据中心：我是开发商，自己拿地盖别墅.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/22%20VPN%ef%bc%9a%e6%9c%9d%e4%b8%ad%e6%9c%89%e4%ba%ba%e5%a5%bd%e5%81%9a%e5%ae%98.md.html" id="22 VPN：朝中有人好做官.md.html">22 VPN：朝中有人好做官.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/23%20%e7%a7%bb%e5%8a%a8%e7%bd%91%e7%bb%9c%ef%bc%9a%e5%8e%bb%e5%b7%b4%e5%a1%9e%e7%bd%97%e9%82%a3%ef%bc%8c%e6%89%8b%e6%9c%ba%e4%b9%9f%e4%b8%8a%e4%b8%8d%e4%ba%86%e8%84%b8%e4%b9%a6.md.html" id="23 移动网络：去巴塞罗那，手机也上不了脸书.md.html">23 移动网络：去巴塞罗那，手机也上不了脸书.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/24%20%e4%ba%91%e4%b8%ad%e7%bd%91%e7%bb%9c%ef%bc%9a%e8%87%aa%e5%b7%b1%e6%8b%bf%e5%9c%b0%e6%88%90%e6%9c%ac%e9%ab%98%ef%bc%8c%e8%b4%ad%e4%b9%b0%e5%85%ac%e5%af%93%e6%9b%b4%e7%81%b5%e6%b4%bb.md.html" id="24 云中网络：自己拿地成本高，购买公寓更灵活.md.html">24 云中网络：自己拿地成本高，购买公寓更灵活.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/25%20%e8%bd%af%e4%bb%b6%e5%ae%9a%e4%b9%89%e7%bd%91%e7%bb%9c%ef%bc%9a%e5%85%b1%e4%ba%ab%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd%e7%9a%84%e5%b0%8f%e5%8c%ba%e7%89%a9%e4%b8%9a%e7%ae%a1%e7%90%86%e5%8a%9e%e6%b3%95.md.html" id="25 软件定义网络：共享基础设施的小区物业管理办法.md.html">25 软件定义网络：共享基础设施的小区物业管理办法.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/26%20%e4%ba%91%e4%b8%ad%e7%9a%84%e7%bd%91%e7%bb%9c%e5%ae%89%e5%85%a8%ef%bc%9a%e8%99%bd%e7%84%b6%e4%b8%8d%e6%98%af%e5%9c%9f%e8%b1%aa%ef%bc%8c%e4%b9%9f%e9%9c%80%e8%a6%81%e5%9f%ba%e6%9c%ac%e5%ae%89%e5%85%a8%e5%92%8c%e4%bf%9d%e9%9a%9c.md.html" id="26 云中的网络安全：虽然不是土豪，也需要基本安全和保障.md.html">26 云中的网络安全：虽然不是土豪，也需要基本安全和保障.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/27%20%e4%ba%91%e4%b8%ad%e7%9a%84%e7%bd%91%e7%bb%9cQoS%ef%bc%9a%e9%82%bb%e5%b1%85%e7%96%af%e7%8b%82%e4%b8%8b%e7%94%b5%e5%bd%b1%ef%bc%8c%e6%88%91%e8%af%a5%e6%80%8e%e4%b9%88%e5%8a%9e%ef%bc%9f.md.html" id="27 云中的网络QoS：邻居疯狂下电影，我该怎么办？.md.html">27 云中的网络QoS：邻居疯狂下电影，我该怎么办？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/28%20%e4%ba%91%e4%b8%ad%e7%bd%91%e7%bb%9c%e7%9a%84%e9%9a%94%e7%a6%bbGRE%e3%80%81VXLAN%ef%bc%9a%e8%99%bd%e7%84%b6%e4%bd%8f%e4%b8%80%e4%b8%aa%e5%b0%8f%e5%8c%ba%ef%bc%8c%e4%b9%9f%e8%a6%81%e4%bf%9d%e6%8a%a4%e9%9a%90%e7%a7%81.md.html" id="28 云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私.md.html">28 云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/29%20%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9c%ef%bc%9a%e6%9d%a5%e5%8e%bb%e8%87%aa%e7%94%b1%e7%9a%84%e6%97%a5%e5%ad%90%ef%bc%8c%e4%b8%8d%e4%b9%b0%e5%85%ac%e5%af%93%e5%8e%bb%e5%90%88%e7%a7%9f.md.html" id="29 容器网络：来去自由的日子，不买公寓去合租.md.html">29 容器网络：来去自由的日子，不买公寓去合租.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/30%20%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9c%e4%b9%8bFlannel%ef%bc%9a%e6%af%8f%e4%ba%ba%e4%b8%80%e4%ba%a9%e4%b8%89%e5%88%86%e5%9c%b0.md.html" id="30 容器网络之Flannel：每人一亩三分地.md.html">30 容器网络之Flannel：每人一亩三分地.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/31%20%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9c%e4%b9%8bCalico%ef%bc%9a%e4%b8%ba%e9%ab%98%e6%95%88%e8%af%b4%e5%87%ba%e5%96%84%e6%84%8f%e7%9a%84%e8%b0%8e%e8%a8%80.md.html" id="31 容器网络之Calico：为高效说出善意的谎言.md.html">31 容器网络之Calico：为高效说出善意的谎言.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/32%20RPC%e5%8d%8f%e8%ae%ae%e7%bb%bc%e8%bf%b0%ef%bc%9a%e8%bf%9c%e5%9c%a8%e5%a4%a9%e8%be%b9%ef%bc%8c%e8%bf%91%e5%9c%a8%e7%9c%bc%e5%89%8d.md.html" id="32 RPC协议综述：远在天边，近在眼前.md.html">32 RPC协议综述：远在天边，近在眼前.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/33%20%e5%9f%ba%e4%ba%8eXML%e7%9a%84SOAP%e5%8d%8f%e8%ae%ae%ef%bc%9a%e4%b8%8d%e8%a6%81%e8%af%b4NBA%ef%bc%8c%e8%af%b7%e8%af%b4%e7%be%8e%e5%9b%bd%e8%81%8c%e4%b8%9a%e7%af%ae%e7%90%83%e8%81%94%e8%b5%9b.md.html" id="33 基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛.md.html">33 基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/34%20%e5%9f%ba%e4%ba%8eJSON%e7%9a%84RESTful%e6%8e%a5%e5%8f%a3%e5%8d%8f%e8%ae%ae%ef%bc%9a%e6%88%91%e4%b8%8d%e5%85%b3%e5%bf%83%e8%bf%87%e7%a8%8b%ef%bc%8c%e8%af%b7%e7%bb%99%e6%88%91%e7%bb%93%e6%9e%9c.md.html" id="34 基于JSON的RESTful接口协议：我不关心过程，请给我结果.md.html">34 基于JSON的RESTful接口协议：我不关心过程，请给我结果.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/35%20%e4%ba%8c%e8%bf%9b%e5%88%b6%e7%b1%bbRPC%e5%8d%8f%e8%ae%ae%ef%bc%9a%e8%bf%98%e6%98%af%e5%8f%abNBA%e5%90%a7%ef%bc%8c%e6%80%bb%e8%af%b4%e5%85%a8%e7%a7%b0%e5%a4%9a%e8%b4%b9%e5%8a%b2.md.html" id="35 二进制类RPC协议：还是叫NBA吧，总说全称多费劲.md.html">35 二进制类RPC协议：还是叫NBA吧，总说全称多费劲.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/36%20%e8%b7%a8%e8%af%ad%e8%a8%80%e7%b1%bbRPC%e5%8d%8f%e8%ae%ae%ef%bc%9a%e4%ba%a4%e6%b5%81%e4%b9%8b%e5%89%8d%ef%bc%8c%e5%8f%8c%e6%96%b9%e5%85%88%e6%9d%a5%e4%b8%aa%e4%b8%93%e4%b8%9a%e6%9c%af%e8%af%ad%e8%a1%a8.md.html" id="36 跨语言类RPC协议：交流之前，双方先来个专业术语表.md.html">36 跨语言类RPC协议：交流之前，双方先来个专业术语表.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/37%20%e7%9f%a5%e8%af%86%e4%b8%b2%ef%bc%9a%e7%94%a8%e5%8f%8c%e5%8d%81%e4%b8%80%e7%9a%84%e6%95%85%e4%ba%8b%e4%b8%b2%e8%b5%b7%e7%a2%8e%e7%89%87%e7%9a%84%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%ef%bc%88%e4%b8%8a%ef%bc%89.md.html" id="37 知识串：用双十一的故事串起碎片的网络协议（上）.md.html">37 知识串：用双十一的故事串起碎片的网络协议（上）.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/38%20%e7%9f%a5%e8%af%86%e4%b8%b2%ef%bc%9a%e7%94%a8%e5%8f%8c%e5%8d%81%e4%b8%80%e7%9a%84%e6%95%85%e4%ba%8b%e4%b8%b2%e8%b5%b7%e7%a2%8e%e7%89%87%e7%9a%84%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%ef%bc%88%e4%b8%ad%ef%bc%89.md.html" id="38 知识串：用双十一的故事串起碎片的网络协议（中）.md.html">38 知识串：用双十一的故事串起碎片的网络协议（中）.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/39%20%e7%9f%a5%e8%af%86%e4%b8%b2%ef%bc%9a%e7%94%a8%e5%8f%8c%e5%8d%81%e4%b8%80%e7%9a%84%e6%95%85%e4%ba%8b%e4%b8%b2%e8%b5%b7%e7%a2%8e%e7%89%87%e7%9a%84%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%ef%bc%88%e4%b8%8b%ef%bc%89.md.html" id="39 知识串：用双十一的故事串起碎片的网络协议（下）.md.html">39 知识串：用双十一的故事串起碎片的网络协议（下）.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/40%20%e6%90%ad%e5%bb%ba%e4%b8%80%e4%b8%aa%e7%bd%91%e7%bb%9c%e5%ae%9e%e9%aa%8c%e7%8e%af%e5%a2%83%ef%bc%9a%e6%8e%88%e4%ba%ba%e4%bb%a5%e9%b1%bc%e4%b8%8d%e5%a6%82%e6%8e%88%e4%ba%ba%e4%bb%a5%e6%b8%94.md.html" id="40 搭建一个网络实验环境：授人以鱼不如授人以渔.md.html">40 搭建一个网络实验环境：授人以鱼不如授人以渔.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/%e5%8a%a0%e9%a4%901%20%e5%88%9b%e4%bd%9c%e6%95%85%e4%ba%8b%ef%bc%9a%e6%88%91%e6%98%af%e5%a6%82%e4%bd%95%e5%88%9b%e4%bd%9c%e2%80%9c%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%e2%80%9d%e4%b8%93%e6%a0%8f%e7%9a%84%ef%bc%9f.md.html" id="加餐1 创作故事：我是如何创作“趣谈网络协议”专栏的？.md.html">加餐1 创作故事：我是如何创作“趣谈网络协议”专栏的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/%e5%8d%8f%e8%ae%ae%e4%b8%93%e6%a0%8f%e7%89%b9%e5%88%ab%e7%a6%8f%e5%88%a9%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%911%e6%9c%9f.md.html" id="协议专栏特别福利 答疑解惑1期.md.html">协议专栏特别福利 答疑解惑1期.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/%e5%8d%8f%e8%ae%ae%e4%b8%93%e6%a0%8f%e7%89%b9%e5%88%ab%e7%a6%8f%e5%88%a9%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%912%e6%9c%9f.md.html" id="协议专栏特别福利 答疑解惑2期.md.html">协议专栏特别福利 答疑解惑2期.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/%e5%8d%8f%e8%ae%ae%e4%b8%93%e6%a0%8f%e7%89%b9%e5%88%ab%e7%a6%8f%e5%88%a9%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%913%e6%9c%9f.md.html" id="协议专栏特别福利 答疑解惑3期.md.html">协议专栏特别福利 答疑解惑3期.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/%e5%8d%8f%e8%ae%ae%e4%b8%93%e6%a0%8f%e7%89%b9%e5%88%ab%e7%a6%8f%e5%88%a9%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%914%e6%9c%9f.md.html" id="协议专栏特别福利 答疑解惑4期.md.html">协议专栏特别福利 答疑解惑4期.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/%e5%8d%8f%e8%ae%ae%e4%b8%93%e6%a0%8f%e7%89%b9%e5%88%ab%e7%a6%8f%e5%88%a9%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%915%e6%9c%9f.md.html" id="协议专栏特别福利 答疑解惑5期.md.html">协议专栏特别福利 答疑解惑5期.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e8%b6%a3%e8%b0%88%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae/%e7%bb%93%e6%9d%9f%e8%af%ad%20%e6%94%be%e5%bc%83%e5%ae%8c%e7%be%8e%e4%b8%bb%e4%b9%89%ef%bc%8c%e6%89%a7%e8%a1%8c%e5%8a%9b%e5%b0%b1%e6%98%af%e9%99%90%e6%97%b6%e9%99%90%e9%87%8f%e8%ae%a4%e7%9c%9f%e5%ae%8c%e6%88%90.md.html" id="结束语 放弃完美主义，执行力就是限时限量认真完成.md.html">结束语 放弃完美主义，执行力就是限时限量认真完成.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="协议专栏特别福利 答疑解惑3期" id="title">协议专栏特别福利 答疑解惑3期</h1>
<div><p>你好，我是刘超。</p>
<p>第三期答疑涵盖第7讲至第13讲的内容。我依旧对课后思考题和留言中比较有代表性的问题作出回答。你可以点击文章名，回到对应的章节复习，也可以继续在留言区写下你的疑问，我会持续不断地解答。希望对你有帮助。</p>
<h2 id="第7讲-icmp与ping-投石问路的侦察兵">《第7讲 | ICMP与ping：投石问路的侦察兵》</h2>
<h3 id="课后思考题">课后思考题</h3>
<p>当发送的报文出问题的时候，会发送一个ICMP的差错报文来报告错误，但是如果 ICMP 的差错报文也出问题了呢？</p>
<p>我总结了一下，不会导致产生ICMP差错报文的有：</p>
<ul>
<li><p>ICMP差错报文（ICMP查询报文可能会产生ICMP差错报文）；</p></li>
<li><p>目的地址是广播地址或多播地址的IP数据报；</p></li>
<li><p>作为链路层广播的数据报；</p></li>
<li><p>不是IP分片的第一片；</p></li>
<li><p>源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。</p></li>
</ul>
<h3 id="留言问题">留言问题</h3>
<p>1.ping使用的是什么网络编程接口？</p>
<p><img alt="" src="assets/3b2b3f4abaed8a485e8933efbcc304e6.png"/></p>
<p>咱们使用的网络编程接口是Socket，对于ping来讲，使用的是ICMP，创建Socket如下：</p>
<pre><code>socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)
</code></pre>
<p>SOCK_RAW就是基于IP层协议建立通信机制。</p>
<p>如果是TCP，则建立下面的Socket：</p>
<pre><code>socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)
</code></pre>
<p>如果是UDP，则建立下面的Socket：</p>
<pre><code>socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)
</code></pre>
<p>2.ICMP差错报文是谁发送的呢？</p>
<p>我看留言里有很多人对这个问题有疑惑。ICMP包是由内核返回的，在内核中，有一个函数用于发送ICMP的包。</p>
<pre><code>void icmp_send(struct sk_buff *skb_in, int type, int code, __be32 info);
</code></pre>
<p>例如，目标不可达，会调用下面的函数。</p>
<pre><code>icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PROT_UNREACH, 0);
</code></pre>
<p>当IP大小超过MTU的时候，发送需要分片的ICMP。</p>
<pre><code>if (ip_exceeds_mtu(skb, mtu)) {
  icmp_send(skb, ICMP_DEST_UNREACH, ICMP_FRAG_NEEDED, htonl(mtu));
  goto drop;
 }
</code></pre>
<h2 id="第8讲-世界这么大-我想出网关-欧洲十国游与玄奘西行">《第8讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行》</h2>
<h3 id="课后思考题-1">课后思考题</h3>
<p>当在你家里要访问 163 网站的时候，你的包需要 NAT 成为公网 IP，返回的包又要 NAT 成你的私有 IP，返回包怎么知道这是你的请求呢？它怎么能这么智能地 NAT 成了你的 IP 而非别人的 IP 呢？</p>
<p>这是个比较复杂的事情。在讲云中网络安全里的iptables时，我们讲过conntrack功能，它记录了SNAT一去一回的对应关系。</p>
<p>如果编译内核时开启了连接跟踪选项，那么Linux系统就会为它收到的每个数据包维持一个连接状态，用于记录这条数据连接的状态。</p>
<p><img alt="" src="assets/a924ccda5d54bcad6f67fdebe0a6c1fc.jpg"/></p>
<p>根据咱们学过的Netfilter的流程图，我们知道，网络包有三种路径：</p>
<ul>
<li><p>发给我的，从PREROUTING到INPUT，我就接收了；</p></li>
<li><p>我发给别人的，从OUTPUT到POSTROUTING，就发出去的；</p></li>
<li><p>从我这里经过的，从PREROUTING到FORWARD到POSTROUTING。</p></li>
</ul>
<p>如果要跟踪一个网络包，对于每一种路径，都需要设置两个记录点，相当于打两次卡，这样内核才知道这个包的状态。</p>
<p>对于这三种路径，打卡的点是这样设置的：</p>
<ul>
<li><p>发给我的，在PREROUTING调用ipv4_conntrack_in，创建连接跟踪记录；在INPUT调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。为什么不一开始就挂在内核的连接跟踪表里面呢？因为有filter表，一旦把包过滤了，也就是丢弃了，那根本没必要记录这个连接了。</p></li>
<li><p>我发给别人的，在OUTPUT调用ipv4_conntrack_local，创建连接跟踪记录，在POSTROUTING调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。</p></li>
<li><p>从我这里经过的，在PREROUTING调用ipv4_conntrack_in，创建连接跟踪记录，在POSTROUTING调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。</p></li>
</ul>
<p>网关主要做转发，这里主要说的是NAT网关，因而我们重点来看“从我这里经过的”这种场景，再加上要NAT，因而将NAT的过程融入到连接跟踪的过程中来：</p>
<ul>
<li><p>如果是PREROUTING的时候，先调用ipv4_conntrack_in，创建连接跟踪记录；</p></li>
<li><p>如果是PREROUTING的时候，有NAT规则，则调用nf_nat_ipv4_in进行地址转换；</p></li>
<li><p>如果是POSTROUTING的时候，有NAT规则，则调用nf_nat_ipv4_out进行地址转换；</p></li>
<li><p>如果是POSTROUTING的时候，调用ipv4_confirm，将这个连接跟踪记录挂在内核的连接跟踪表里面。</p></li>
</ul>
<p>接下来，我们来看，在这个过程中涉及到的数据结构：连接跟踪记录、连接跟踪表。</p>
<p>在前面讲网络包处理的时候，我们说过，每个网络包都是一个struct sk_buff，它有一个成员变量_nfct指向一个连接跟踪记录struct nf_conn。当然当一个网络包刚刚进来的时候，是不会指向这么一个结构的，但是这个网络包肯定属于某个连接，因而会去连接跟踪表里面去查找，之后赋值给sk_buff的这个成员变量。没找到的话，就说明是一个新的连接，然后会重新创建一个。</p>
<p>连接跟踪记录里面有几个重要的东西：</p>
<ul>
<li><p>nf_conntrack其实才是_nfct变量指向的地址，但是没有关系，学过C++的话应该明白，对于结构体来讲，nf_conn和nf_conntrack的起始地址是一样的；</p></li>
<li><p>tuplehash虽然是数组，但是里面只有两个，IP_CT_DIR_ORIGINAL为下标0，表示连接的发起方向，IP_CT_DIR_REPLY为下标1，表示连接的回复方向。</p>
<p>struct nf_conn {
 ……
 struct nf_conntrack ct_general;
 ……
 struct nf_conntrack_tuple_hash tuplehash[IP_CT_DIR_MAX];
 ……
 unsigned long status;
 ……
}</p></li>
</ul>
<p>在这里面，最重要的是nf_conntrack_tuple_hash的数组。nf_conn是这个网络包对应的一去一回的连接追踪记录，但是这个记录是会放在一个统一的连接追踪表里面的。</p>
<p>连接跟踪表nf_conntrack_hash是一个数组，数组中的每一项都是一个双向链表的头，每一项后面都挂着一个双向链表，链表中的每一项都是这个结构。</p>
<p>这个结构的第一项是链表的链，nf_conntrack_tuple是用来标识是否同一个连接。</p>
<p>从上面可以看出来，连接跟踪表是一个典型的链式哈希表的实现。</p>
<p>每当有一个网络包来了的时候，会将网络包中sk_buff中的数据提取出来，形成nf_conntrack_tuple，并根据里面的内容计算哈希值。然后需要在哈希表中查找，如果找到，则说明这个连接出现过；如果没找到，则生成一个插入哈希表。</p>
<p>通过nf_conntrack_tuple里面的内容，可以唯一地标识一个连接：</p>
<ul>
<li><p>src：包含源IP地址；如果是TCP或者UDP，包含源端口；如果是ICMP，包含的是ID；</p></li>
<li><p>dst：包含目标IP地址；如果是TCP或者UDP，包含目标端口；如果是ICMP，包含的是type, code。</p></li>
</ul>
<p>有了这些数据结构，我们接下来看这一去一回的过程。</p>
<p>当一个包发出去的时候，到达这个NAT网关的时候，首先经过PREROUTING的时候，先调用ipv4_conntrack_in。这个时候进来的包sk_buff为： {源IP：客户端IP，源端口：客户端port，目标IP：服务端IP，目标端口：服务端port}，将这个转换为nf_conntrack_tuple，然后经过哈希运算，在连接跟踪表里面查找，发现没有，说明这是一个新的连接。</p>
<p>于是，创建一个新的连接跟踪记录nf_conn，这里面有两个nf_conntrack_tuple_hash：</p>
<ul>
<li><p>一去：{源IP：客户端IP，源端口：客户端port，目标IP：服务端IP，目标端口：服务端port}；</p></li>
<li><p>一回：{源IP：服务端IP，源端口：服务端port，目标IP：客户端IP，目标端口：客户端port}。</p></li>
</ul>
<p>接下来经过FORWARD过程，假设包没有被filter掉，于是要转发出去，进入POSTROUTING的过程，有NAT规则，则调用nf_nat_ipv4_out进行地址转换。这个时候，源地址要变成NAT网关的IP地址，对于masquerade来讲，会自动选择一个公网IP地址和一个随机端口。</p>
<p>为了让包回来的时候，能找到连接跟踪记录，需要修改两个nf_conntrack_tuple_hash中回来的那一项为：{源IP：服务端IP，源端口：服务端port，目标IP：NAT网关IP，目标端口：随机端口}。</p>
<p>接下来要将网络包真正发出去的时候，除了要修改包里面的源IP和源端口之外，还需要将刚才的一去一回的两个nf_conntrack_tuple_hash放入连接跟踪表这个哈希表中。</p>
<p>当网络包到达服务端，然后回复一个包的时候，这个包sk_buff为：{源IP：服务端IP，源端口：服务端port，目标IP：NAT网关IP，目标端口：随机端口}。</p>
<p>将这个转换为nf_conntrack_tuple后，进行哈希运算，在连接跟踪表里面查找，是能找到相应的记录的，找到nf_conntrack_tuple_hash之后，Linux会提供一个函数。</p>
<pre><code>static inline struct nf_conn *
nf_ct_tuplehash_to_ctrack(const struct nf_conntrack_tuple_hash *hash)
{
 return container_of(hash, struct nf_conn,
       tuplehash[hash-&gt;tuple.dst.dir]);
}
</code></pre>
<p>可以通过nf_conntrack_tuple_hash找到外面的连接跟踪记录nf_conn，通过这个可以找到来方向的那个nf_conntrack_tuple_hash，{源IP：客户端IP，源端口：客户端port，目标IP：服务端IP，目标端口：服务端port}，这样就能够找到客户端的IP和端口，从而可以NAT回去。</p>
<h3 id="留言问题-1">留言问题</h3>
<p>1.NAT能建立多少连接？</p>
<p><img alt="" src="assets/3d9249834f730926c2b2f350aba6e1d6.png"/></p>
<p>SNAT多用于内网访问外网的场景，鉴于conntrack是由{源IP，源端口，目标IP，目标端口}，hash后确定的。</p>
<p>如果内网机器很多，但是访问的是不同的外网，也即目标IP和目标端口很多，这样内网可承载的数量就非常大，可不止65535个。</p>
<p>但是如果内网所有的机器，都一定要访问同一个目标IP和目标端口，这样源IP如果只有一个，这样的情况下，才受65535的端口数目限制，根据原理，一种方法就是多个源IP，另外的方法就是多个NAT网关，来分摊不同的内网机器访问。</p>
<p>如果你使用的是公有云，65535台机器，应该放在一个VPC里面，可以放在多个VPC里面，每个VPC都可以有自己的NAT网关。</p>
<p><img alt="" src="assets/d08e3a727681751037f715c3f5bd398d.png"/></p>
<p>其实SNAT的场景是内网访问外网，存在端口数量的问题，也是所有的机器都访问一个目标地址的情况。</p>
<p>如果是微信这种场景，应该是服务端在数据中心内部，无论多少长连接，作为服务端监听的都是少数几个端口，是DNAT的场景，是没有端口数目问题的，只有一台服务器能不能维护这么多连接，因而在NAT网关后面部署多个nginx来分摊连接即可。</p>
<p>2.公网IP和私网IP需要一一绑定吗？</p>
<p><img alt="" src="assets/2d134e61e8cc945c71969be7391b3ff1.png"/></p>
<p>公网IP是有限的，如果使用公有云，需要花钱去买。但是不是每一个虚拟机都要有一个公网IP的，只有需要对外提供服务的机器，也即接入层的那些nginx需要公网IP，没有公网IP，使用SNAT，大家共享SNAT网关的公网IP地址，也是能够访问的外网的。</p>
<p>我看留言中的困惑点都在于，要区分内主动发起访问外，还是外主动发起访问内，是访问同一个服务端，还是访问一大批服务端。这里就很明白了。</p>
<h2 id="第9讲-路由协议-西出网关无故人-敢问路在何方">《第9讲 | 路由协议：西出网关无故人，敢问路在何方》</h2>
<h3 id="课后思考题-2">课后思考题</h3>
<p>路由协议要在路由器之间交换信息，这些信息的交换还需要走路由吗？不是死锁了吗？</p>
<p><img alt="" src="assets/b5834f4f10c51cb8c91e570bf83f7eda.png"/></p>
<p>OSPF是直接基于IP协议发送的，而且OSPF的包都是发给邻居的，也即只有一跳，不会中间经过路由设备。BGP是基于TCP协议的，在BGP peer之间交换信息。</p>
<h3 id="留言问题-2">留言问题</h3>
<p>1.多线BGP机房是怎么回事儿？</p>
<p><img alt="" src="assets/18040a74506276b23e672d2d818d37cd.png"/></p>
<p>BGP主要用于互联网AS自治系统之间的互联，BGP的最主要功能在于<strong>控制路由的传播</strong>和<strong>选择最好的路由</strong>。各大运营商都具有AS号，全国各大网络运营商多数都是通过BGP协议与自身的AS来实现多线互联的。</p>
<p>使用此方案来实现多线路互联，IDC需要在CNNIC（中国互联网信息中心）或APNIC（亚太网络信息中心）申请自己的IP地址段和AS号，然后通过BGP协议将此段IP地址广播到其它的网络运营商的网络中。</p>
<p>使用BGP协议互联后，网络运营商的所有骨干路由设备将会判断到IDC机房IP段的最佳路由，以保证不同网络运营商用户的高速访问。</p>
<h2 id="第10讲-udp协议-因性善而简单-难免碰到-城会玩">《第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”》</h2>
<h3 id="课后思考题-3">课后思考题</h3>
<p>都说 TCP 是面向连接的，在计算机看来，怎么样才算一个连接呢？</p>
<p>赵强强在留言中回答的是正确的。这是TCP的两端为了维护连接所保持的数据结构。</p>
<p><img alt="" src="assets/3cba74151564c129057b2cd246a332e1.png"/></p>
<p><img alt="" src="assets/9507374c04e0908f29d5a3050d905fe0.png"/></p>
<h2 id="第11讲-tcp协议-上-因性恶而复杂-先恶后善反轻松">《第11讲 | TCP协议（上）：因性恶而复杂，先恶后善反轻松》</h2>
<h3 id="课后思考题-4">课后思考题</h3>
<p>TCP 的连接有这么多的状态，你知道如何在系统中查看某个连接的状态吗？</p>
<p><img alt="" src="assets/3c997ad09a1c72cbb32a992e7c9588d7.png"/></p>
<h3 id="留言问题-3">留言问题</h3>
<p>1.TIME_WAIT状态太多是怎么回事儿？</p>
<p><img alt="" src="assets/8535df3de9f426b44def750330dcf2b8.png"/></p>
<p><img alt="" src="assets/1f6a5e17b34f00d28722428b7b8ccb11.jpg"/></p>
<p>如果处于TIMEWAIT状态，说明双方建立成功过连接，而且已经发送了最后的ACK之后，才会处于这个状态，而且是主动发起关闭的一方处于这个状态。</p>
<p>如果存在大量的TIMEWAIT，往往是因为短连接太多，不断的创建连接，然后释放连接，从而导致很多连接在这个状态，可能会导致无法发起新的连接。解决的方式往往是：</p>
<ul>
<li><p>打开tcp_tw_recycle和tcp_timestamps选项；</p></li>
<li><p>打开tcp_tw_reuse和tcp_timestamps选项；</p></li>
<li><p>程序中使用SO_LINGER，应用强制使用rst关闭。</p></li>
</ul>
<p>当客户端收到Connection Reset，往往是收到了TCP的RST消息，RST消息一般在下面的情况下发送：</p>
<ul>
<li><p>试图连接一个未被监听的服务端；</p></li>
<li><p>对方处于TIMEWAIT状态，或者连接已经关闭处于CLOSED状态，或者重新监听seq num不匹配；</p></li>
<li><p>发起连接时超时，重传超时，keepalive超时；</p></li>
<li><p>在程序中使用SO_LINGER，关闭连接时，放弃缓存中的数据，给对方发送RST。</p></li>
</ul>
<p>2.起始序列号是怎么计算的，会冲突吗？</p>
<p>有同学在留言中问了几个问题。Ender0224的回答非常不错。</p>
<p><img alt="" src="assets/afed5f0593647c0b64971c2fef7e4247.png"/></p>
<p><img alt="" src="assets/c39c723c9389c4414401366a32b69fe1.jpg"/></p>
<p>起始ISN是基于时钟的，每4毫秒加一，转一圈要4.55个小时。</p>
<p>TCP初始化序列号不能设置为一个固定值，因为这样容易被攻击者猜出后续序列号，从而遭到攻击。 RFC1948中提出了一个较好的初始化序列号ISN随机生成算法。</p>
<p>ISN = M + F (localhost, localport, remotehost, remoteport)</p>
<p>M是一个计时器，这个计时器每隔4毫秒加1。F是一个Hash算法，根据源IP、目的IP、源端口、目的端口生成一个随机数值。要保证Hash算法不能被外部轻易推算得出，用MD5算法是一个比较好的选择。</p>
<h2 id="第12讲-tcp协议-下-西行必定多妖孽-恒心智慧消磨难">《第12讲 | TCP协议（下）：西行必定多妖孽，恒心智慧消磨难》</h2>
<h3 id="课后思考题-5">课后思考题</h3>
<p>TCP的BBR听起来很牛，你知道它是如何达到这个最优点的吗？</p>
<p><img alt="" src="assets/33b035bd326e9c1f811d667104a54003.png"/></p>
<h2 id="第13讲-套接字socket-talk-is-cheap-show-me-the-code">《第13讲 | 套接字Socket：Talk is cheap, show me the code》</h2>
<h3 id="课后思考题-6">课后思考题</h3>
<p>epoll是Linux上的函数，那你知道Windows上对应的机制是什么吗？如果想实现一个跨平台的程序，你知道应该怎么办吗？</p>
<p><img alt="" src="assets/74d6535a22f5dc8ab2f782b4484ca7e9.png"/></p>
<p>epoll是异步通知，当事件发生的时候，通知应用去调用IO函数获取数据。IOCP异步传输，当事件发生时，IOCP机制会将数据直接拷贝到缓冲区里，应用可以直接使用。</p>
<p>如果跨平台，推荐使用libevent库，它是一个事件通知库，适用于Windows、Linux、BSD等多种平台，内部使用select、epoll、kqueue、IOCP等系统调用管理事件机制。</p>
<hr/>
<p>感谢第7讲至第13讲中对内容有深度思考和提出问题的同学。我会为你们送上奖励礼券和知识图谱。（稍后运营同学会发送短信通知。）</p>
<p>欢迎你继续提问！</p>
<p><img alt="" src="assets/edc42141381c0458ab65f70628e88557.jpg"/></p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#365a5a5a0f020707060176515b575f5a1855595b" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</hr></div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9358c8c4abacc94a',t:'MTc0NTUzMTA5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>