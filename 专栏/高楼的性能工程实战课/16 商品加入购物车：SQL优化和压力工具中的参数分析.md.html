<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="16 商品加入购物车：SQL优化和压力工具中的参数分析" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>16 商品加入购物车：SQL优化和压力工具中的参数分析 </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%e6%89%93%e7%a0%b4%e5%9b%9b%e5%a4%a7%e8%ae%a4%e7%9f%a5%e5%b1%80%e9%99%90%ef%bc%8c%e8%bf%9b%e9%98%b6%e9%ab%98%e7%ba%a7%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%b8%88.md.html" id="00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html">00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/01%20%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%be%88%e5%a4%9a%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95%e4%ba%ba%e5%91%98%e6%97%a0%e6%b3%95%e5%af%b9%e6%80%a7%e8%83%bd%e7%bb%93%e6%9e%9c%e8%b4%9f%e8%b4%a3%ef%bc%9f.md.html" id="01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html">01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/02%20%e5%85%b3%e9%94%ae%e6%a6%82%e5%bf%b5%ef%bc%9a%e6%80%a7%e8%83%bd%e6%8c%87%e6%a0%87%e5%92%8c%e5%9c%ba%e6%99%af%e7%9a%84%e7%a1%ae%e5%ae%9a.md.html" id="02 关键概念：性能指标和场景的确定.md.html">02 关键概念：性能指标和场景的确定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/03%20%e6%a0%b8%e5%bf%83%e5%88%86%e6%9e%90%e9%80%bb%e8%be%91%ef%bc%9a%e6%89%80%e6%9c%89%e7%9a%84%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%ef%bc%8c%e9%9d%a0%e8%bf%99%e4%b8%83%e6%ad%a5%e9%83%bd%e8%83%bd%e6%90%9e%e5%ae%9a.md.html" id="03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html">03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/04%20%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%86%b3%e7%ad%96%e6%a0%91%e5%92%8c%e6%9f%a5%e6%89%be%e7%93%b6%e9%a2%88%e8%af%81%e6%8d%ae%e9%93%be%ef%bc%9f.md.html" id="04 如何构建性能分析决策树和查找瓶颈证据链？.md.html">04 如何构建性能分析决策树和查找瓶颈证据链？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/05%20%e6%80%a7%e8%83%bd%e6%96%b9%e6%a1%88%ef%bc%9a%e4%bd%a0%e7%9a%84%e6%96%b9%e6%a1%88%e6%98%af%e5%90%a6%e8%bf%98%e5%81%9c%e7%95%99%e5%9c%a8%e5%bd%a2%e5%bc%8f%e4%b8%8a%ef%bc%9f.md.html" id="05 性能方案：你的方案是否还停留在形式上？.md.html">05 性能方案：你的方案是否还停留在形式上？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/06%20%e5%a6%82%e4%bd%95%e6%8a%bd%e5%8f%96%e5%87%ba%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af%e7%9a%84%e4%b8%9a%e5%8a%a1%e6%a8%a1%e5%9e%8b%ef%bc%9f.md.html" id="06 如何抽取出符合真实业务场景的业务模型？.md.html">06 如何抽取出符合真实业务场景的业务模型？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/07%20%e6%80%a7%e8%83%bd%e5%9c%ba%e6%99%af%e7%9a%84%e6%95%b0%e6%8d%ae%e5%88%b0%e5%ba%95%e5%ba%94%e8%af%a5%e5%81%9a%e6%88%90%e4%bb%80%e4%b9%88%e6%a0%b7%e5%ad%90%ef%bc%9f.md.html" id="07 性能场景的数据到底应该做成什么样子？.md.html">07 性能场景的数据到底应该做成什么样子？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/08%20%e5%b9%b6%e5%8f%91%e3%80%81%e5%9c%a8%e7%ba%bf%e5%92%8cTPS%e5%88%b0%e5%ba%95%e6%98%af%e4%bb%80%e4%b9%88%e5%85%b3%e7%b3%bb%ef%bc%9f.md.html" id="08 并发、在线和TPS到底是什么关系？.md.html">08 并发、在线和TPS到底是什么关系？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/09%20%e5%a6%82%e4%bd%95%e8%ae%be%e8%ae%a1%e5%85%a8%e5%b1%80%e5%92%8c%e5%ae%9a%e5%90%91%e7%9b%91%e6%8e%a7%e7%ad%96%e7%95%a5%ef%bc%9f.md.html" id="09 如何设计全局和定向监控策略？.md.html">09 如何设计全局和定向监控策略？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/10%20%e8%ae%be%e8%ae%a1%e5%9f%ba%e5%87%86%e5%9c%ba%e6%99%af%e9%9c%80%e8%a6%81%e6%b3%a8%e6%84%8f%e5%93%aa%e4%ba%9b%e5%85%b3%e9%94%ae%e7%82%b9%ef%bc%9f.md.html" id="10 设计基准场景需要注意哪些关键点？.md.html">10 设计基准场景需要注意哪些关键点？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/11%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%b8%80%ef%bc%9a%e4%b8%80%e4%b8%aa%e6%a1%88%e4%be%8b%ef%bc%8c%e5%b8%a6%e4%bd%a0%e6%90%9e%e6%87%82%e5%9f%ba%e7%a1%80%e7%a1%ac%e4%bb%b6%e8%ae%be%e6%96%bd%e7%9a%84%e6%80%a7%e8%83%bd%e9%97%ae%e9%a2%98.md.html" id="11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html">11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/12%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%ba%8c%ef%bc%9a%e5%a6%82%e4%bd%95%e5%b9%b3%e8%a1%a1%e5%88%a9%e7%94%a8%e7%a1%ac%e4%bb%b6%e8%b5%84%e6%ba%90%ef%bc%9f.md.html" id="12 打开首页之二：如何平衡利用硬件资源？.md.html">12 打开首页之二：如何平衡利用硬件资源？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/13%20%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%ef%bc%9a%e6%80%8e%e4%b9%88%e5%88%a4%e6%96%ad%e7%ba%bf%e7%a8%8b%e4%b8%ad%e7%9a%84Block%e5%8e%9f%e5%9b%a0%ef%bc%9f.md.html" id="13 用户登录：怎么判断线程中的Block原因？.md.html">13 用户登录：怎么判断线程中的Block原因？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/14%20%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af%e6%9f%a5%e8%af%a2%ef%bc%9a%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e7%bd%91%e7%bb%9c%e8%bd%af%e4%b8%ad%e6%96%ad%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html">14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/15%20%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81%ef%bc%9a%e8%b5%84%e6%ba%90%e4%b8%8d%e8%b6%b3%e6%9c%89%e5%93%aa%e4%ba%9b%e6%80%a7%e8%83%bd%e8%a1%a8%e7%8e%b0%ef%bc%9f.md.html" id="15 查询商品：资源不足有哪些性能表现？.md.html">15 查询商品：资源不足有哪些性能表现？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/16%20%e5%95%86%e5%93%81%e5%8a%a0%e5%85%a5%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9aSQL%e4%bc%98%e5%8c%96%e5%92%8c%e5%8e%8b%e5%8a%9b%e5%b7%a5%e5%85%b7%e4%b8%ad%e7%9a%84%e5%8f%82%e6%95%b0%e5%88%86%e6%9e%90.md.html" id="16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html">16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/17%20%e6%9f%a5%e8%af%a2%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e9%93%ba%e5%ba%95%e5%8f%82%e6%95%b0%e4%b8%80%e5%ae%9a%e8%a6%81%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e7%89%b9%e6%80%a7%ef%bc%9f.md.html" id="17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html">17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/18%20%e8%b4%ad%e7%89%a9%e8%bd%a6%e4%bf%a1%e6%81%af%e7%a1%ae%e5%ae%9a%e8%ae%a2%e5%8d%95%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8a%a8%e6%80%81%e5%8f%82%e6%95%b0%e5%8c%96%e9%80%bb%e8%be%91%e9%9d%9e%e5%b8%b8%e9%87%8d%e8%a6%81%ef%bc%9f.md.html" id="18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html">18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/19%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e5%ba%94%e7%94%a8JDBC%e6%b1%a0%e4%bc%98%e5%8c%96%e5%92%8c%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%e5%88%86%e6%9e%90.md.html" id="19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html">19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/20%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e5%a4%8d%e6%9d%82%ef%bc%8c%e6%80%8e%e4%b9%88%e5%81%9a%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%ef%bc%9f.md.html" id="20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html">20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/21%20%e6%94%af%e4%bb%98%e5%89%8d%e6%9f%a5%e8%af%a2%e8%ae%a2%e5%8d%95%e5%88%97%e8%a1%a8%ef%bc%9a%e5%a6%82%e4%bd%95%e5%88%86%e6%9e%90%e4%bc%98%e5%8c%96%e4%b8%80%e4%b8%aa%e5%9b%ba%e5%ae%9a%e7%9a%84%e6%8a%80%e6%9c%af%e7%bb%84%e4%bb%b6%ef%bc%9f.md.html" id="21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html">21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/22%20%e6%94%af%e4%bb%98%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%ef%bc%9a%e5%a6%82%e4%bd%95%e9%ab%98%e6%95%88%e8%a7%a3%e5%86%b3for%e5%be%aa%e7%8e%af%e4%ba%a7%e7%94%9f%e7%9a%84%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%ef%bc%9f.md.html" id="22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html">22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/23%20%e5%86%b3%e5%ae%9a%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e6%88%90%e8%b4%a5%e7%9a%84%e5%85%b3%e9%94%ae%e5%9b%a0%e7%b4%a0%e6%9c%89%e5%93%aa%e4%ba%9b%ef%bc%9f.md.html" id="23 决定容量场景成败的关键因素有哪些？.md.html">23 决定容量场景成败的关键因素有哪些？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/24%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96%e5%92%8cKubernetes%e8%b5%84%e6%ba%90%e5%88%86%e9%85%8d%e4%b8%8d%e5%9d%87%e8%a1%a1%e6%80%8e%e4%b9%88%e5%8a%9e%ef%bc%9f.md.html" id="24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html">24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/25%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e7%bc%93%e5%ad%98%e5%af%b9%e6%80%a7%e8%83%bd%e4%bc%9a%e6%9c%89%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e5%bd%b1%e5%93%8d%ef%bc%9f.md.html" id="25 容量场景之二：缓存对性能会有什么样的影响？.md.html">25 容量场景之二：缓存对性能会有什么样的影响？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/26%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e4%b8%9a%e5%8a%a1%e7%a7%af%e7%b4%af%e9%87%8f%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html">26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/27%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e7%a3%81%e7%9b%98%e4%b8%8d%e8%b6%b3%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html">27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/28%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%e7%9a%84%e8%8c%83%e5%9b%b4%e5%92%8c%e8%ae%be%e8%ae%a1%e9%80%bb%e8%be%91%ef%bc%9f.md.html" id="28 如何确定异常场景的范围和设计逻辑？.md.html">28 如何确定异常场景的范围和设计逻辑？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/29%20%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%ef%bc%9a%e5%a6%82%e4%bd%95%e6%a8%a1%e6%8b%9f%e4%b8%8d%e5%90%8c%e7%bb%84%e4%bb%b6%e5%b1%82%e7%ba%a7%e7%9a%84%e5%bc%82%e5%b8%b8%ef%bc%9f.md.html" id="29 异常场景：如何模拟不同组件层级的异常？.md.html">29 异常场景：如何模拟不同组件层级的异常？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/30%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e7%94%9f%e4%ba%a7%e7%b3%bb%e7%bb%9f%e9%85%8d%e7%bd%ae%ef%bc%9f.md.html" id="30 如何确定生产系统配置？.md.html">30 如何确定生产系统配置？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/31%20%e6%80%8e%e4%b9%88%e5%86%99%e5%87%ba%e6%9c%89%e4%bb%b7%e5%80%bc%e7%9a%84%e6%80%a7%e8%83%bd%e6%8a%a5%e5%91%8a%ef%bc%9f.md.html" id="31 怎么写出有价值的性能报告？.md.html">31 怎么写出有价值的性能报告？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e6%88%91%e4%bb%ac%e8%bf%99%e4%b8%aa%e8%af%be%e7%a8%8b%e7%9a%84%e7%b3%bb%e7%bb%9f%e6%98%af%e6%80%8e%e4%b9%88%e6%90%ad%e5%bb%ba%e8%b5%b7%e6%9d%a5%e7%9a%84%ef%bc%9f.md.html" id="我们这个课程的系统是怎么搭建起来的？.md.html">我们这个课程的系统是怎么搭建起来的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e7%bb%93%e6%9d%9f%e8%af%ad%20%e5%81%9a%e7%9c%9f%e6%ad%a3%e7%9a%84%e6%80%a7%e8%83%bd%e9%a1%b9%e7%9b%ae.md.html" id="结束语 做真正的性能项目.md.html">结束语 做真正的性能项目.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="16 商品加入购物车：SQL优化和压力工具中的参数分析" id="title">16 商品加入购物车：SQL优化和压力工具中的参数分析</h1>
<div><p>你好，我是高楼。</p>
<p>今天这节课，我用商品加入购物车接口，来给你讲一讲SQL优化和压力工具中的参数分析。</p>
<p>对于SQL的优化，很多人一看到数据库资源使用率高，就猜测是SQL有问题。这个方向看起来没错，但是，具体是哪个SQL有问题，以及有什么样的问题，往往回答不出来。因此，这节课我会教你怎么根据资源使用率高，快速定位到有问题的SQL，并做出相应的调整。此外，你还将看到，当压力工具的参数使用不合理时，我们应该如何处理由此产生的数据库锁的问题。</p>
<p>现在，我们就开始这节课的分析。</p>
<h2 id="压力数据">压力数据</h2>
<p>对于商品加入购物车这个接口，我们第一次运行的性能场景结果如下：</p>
<p><img alt="" src="assets/e3aa6eaa22874bd887a82f172903860c.jpg"/></p>
<p>看着有一种想哭的感觉，有没有？从这张图来看，问题不止一个。我用自己在有限的职业生涯中吸收的天地之灵气，打开天眼一看，感觉这里有两个问题：</p>
<ul>
<li>TPS即使在峰值的时候，也不够高，才50左右；</li>
<li>TPS在峰值的时候，有大量的错误产生。</li>
</ul>
<p>那哪个问题更重要呢？有人可能说，明显应该处理错误呀，有错误看着不眼晕吗？如果你是有强迫症的人，那没办法，可以先处理错误。</p>
<p>不过，在我看来，先处理TPS不高的问题也是可以的。因为虽然有错误产生，但并不是全错呀，只有5%的错，你着个啥急。</p>
<p>可是，不管怎么着，我们都要走性能分析决策树的思路。</p>
<h2 id="看架构图">看架构图</h2>
<p><img alt="" src="assets/b09753bf93df4dfb89ca27065c647ff3.jpg"/></p>
<p>这个接口的逻辑清晰明了：压力工具 - Gateway - Cart - Member。</p>
<p>我打算先分析TPS不高、响应时间变长的问题，这个问题可以在压力曲线图的前半段中看出来。所以，接下来，我们的分析就从拆分响应时间开始。</p>
<p>如果你想在这样的场景中先处理错误 ，那就从查日志开始。其实，这些错误是容易处理的，因为它们给出了非常明确的方向指示。</p>
<h2 id="分析的第一阶段">分析的第一阶段</h2>
<h3 id="拆分响应时间">拆分响应时间</h3>
<p>这次我们截小图。</p>
<ul>
<li>User - Gateway：</li>
</ul>
<p><img alt="" src="assets/d825905e2e0f49eba53b8b35ad580571.jpg"/></p>
<ul>
<li>Gateway - Cart：</li>
</ul>
<p><img alt="" src="assets/bb6a9fd8858a44f692098456b5f275af.jpg"/></p>
<ul>
<li>Cart - Member ：</li>
</ul>
<p><img alt="" src="assets/19450de487184e3d99c2461f897bbfcc.jpg"/></p>
<ul>
<li>Cart - MySQL：</li>
</ul>
<p><img alt="" src="assets/e388d704db3149db9ee1a06bb2a41b9c.jpg"/></p>
<ul>
<li>Member - MySQL：</li>
</ul>
<p><img alt="" src="assets/54b17b76a06c4242ba2dffac5fdc133b.jpg"/></p>
<p>从响应时间上来看，我们需要先收拾MySQL，并且是和Cart服务相关的SQL，因为Cart - MySQL之间的响应时间有点长。</p>
<h3 id="全局分析">全局分析</h3>
<p>按照我们的惯例，还是得来看一下全局监控。</p>
<p><img alt="" src="assets/80d375f2579d4b548b38f30cc27f8ad7.jpg"/></p>
<p>既然worker-1上的CPU使用率很高，那我们就去看看worker-1上运行着什么服务。</p>
<p>你也许会问，网络的下载带宽也飘红了啊，已经达到100Mb以上了。这就涉及到怎么理解计数器的问题了。这里的网络虽然飘红了，但也只有100多Mb，它飘红只是因为Grafana DashBoard的阈值设置问题。如果你不想让它飘红，也可以把阈值设置得高一点。并且对于网络来说，100多Mb，真的不算大。</p>
<p>我们来看一下worker-1上有什么。</p>
<pre><code>[root@k8s-master-2 ~]# kubectl get pods -o wide|grep k8s-worker-1
elasticsearch-data-1                        1/1     Running   1          11d     10.100.230.57    k8s-worker-1   &lt;none&gt;           &lt;none&gt;
elasticsearch-master-0                      1/1     Running   0          3d11h   10.100.230.60    k8s-worker-1   &lt;none&gt;           &lt;none&gt;
mysql-min-d564fc4df-vs7d6                   1/1     Running   0          22h     10.100.230.1     k8s-worker-1   &lt;none&gt;           &lt;none&gt;
[root@k8s-master-2 ~]# 
</code></pre>
<p>你看，这个worker-1上不止有MySQL，还有ES data，这是一个吃网络的大户。不过，现在问题并没有指向它。</p>
<p>我们在前面看到的是MySQL的响应时间长，所以我们再到worker-1上，接着看全局监控的数据。</p>
<pre><code>[root@k8s-worker-1 ~]# top
top - 23:08:21 up 3 days, 11:30,  5 users,  load average: 29.90, 28.54, 23.00
Tasks: 309 total,   1 running, 307 sleeping,   0 stopped,   1 zombie
%Cpu0  : 94.1 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  2.9 si,  2.9 st
%Cpu1  : 94.1 us,  2.9 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  2.9 si,  0.0 st
%Cpu2  : 90.9 us,  3.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  6.1 st
%Cpu3  : 89.7 us,  3.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  3.4 si,  3.4 st
%Cpu4  : 87.9 us,  6.1 sy,  0.0 ni,  3.0 id,  0.0 wa,  0.0 hi,  0.0 si,  3.0 st
%Cpu5  : 87.9 us,  9.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  3.0 st
KiB Mem : 16265992 total,  1176564 free,  8436112 used,  6653316 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  7422832 avail Mem 


  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                      
21344 27        20   0 8222204 628452  12892 S 331.4  3.9 141:36.72 /opt/rh/rh-mysql57/root/usr/libexec/mysqld --defaults-file=/etc/my.cnf       
 5128 techstar  20   0 5917564   1.4g  21576 S 114.3  8.8 233:09.48 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache+
 5127 techstar  20   0   14.1g   3.5g  25756 S  40.0 22.8   1647:28 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache+
 1091 root      20   0 1145528 108228  29420 S  25.7  0.7 263:51.49 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock       
 1078 root      20   0 2504364 106288  38808 S  14.3  0.7 429:13.57 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.co+
17108 root      20   0  164472   2656   1712 R  14.3  0.0   0:00.66 top  
</code></pre>
<p>从上面的数据中，我们也能看到MySQL的进程消耗的CPU比较多，这说明我们现在走的证据链是正确的。既然走到了数据库，那我们主要看什么呢？当然是看MySQL的全局监控了。所以，我打印了MySQL Report，过滤掉一些没问题的数据之后得到如下结果（不然内容就太长了）：</p>
<pre><code>__ Questions ___________________________________________________________
Total         637.05k     8.0/s
  DMS         293.57k     3.7/s  %Total:  46.08
  Com_        235.02k     2.9/s           36.89
.............................
Slow 20 ms    119.50k     1.5/s           18.76  %DMS:  40.70  Log:
DMS           293.57k     3.7/s           46.08
  SELECT      224.80k     2.8/s           35.29         76.57
  UPDATE       51.86k     0.6/s            8.14         17.66
  INSERT       16.92k     0.2/s            2.66          5.76
  REPLACE           0       0/s            0.00          0.00
  DELETE            0       0/s            0.00          0.00
.............................


__ SELECT and Sort _____________________________________________________
Scan          137.84k     1.7/s %SELECT:  61.32
.............................
</code></pre>
<p>从上面的数据我们可以看到，在Total的部分中，DMS（Data Manipulation Statements ，数据维护语句）占比46.08%。而在DMS中，SELECT占比76.57%。所以，我们要把后续分析的重点放在SELECT语句上。</p>
<p>通过Slow这一行，看到慢日志也已经出现，因为我把慢日志阈值设置的比较低，只有20ms，所以，你能看到每秒产生了1.5个慢日志。我之所以把慢日志阈值设的比较低，主要是想把稍微慢一点的SQL都记录下来。不过，在你的应用中，要根据实际的情况来，不要设置过大，也不要过小，不然都是泪。</p>
<h3 id="定向分析">定向分析</h3>
<p>下面就是看慢日志喽。请你记住，在看MySQL慢日志之前，最好先把日志清一遍，让这个日志只记录压力场景执行时间段内的慢SQL，不然受影响的数据会很多。</p>
<pre><code>[root@7dgroup1 gaolou]# pt-query-digest slow-query.log


# 7.2s user time, 70ms system time, 36.78M rss, 106.05M vsz
# Current date: Wed Dec 30 23:30:14 2020
# Hostname: 7dgroup1
# Files: slow-query.log
# Overall: 36.60k total, 7 unique, 89.06 QPS, 17.17x concurrency _________
# Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51
# Attribute          total     min     max     avg     95%  stddev  median
# ============     ======= ======= ======= ======= ======= ======= =======
# Exec time          7055s    20ms      1s   193ms   501ms   160ms   128ms
# Lock time             7s       0    39ms   194us   247us   696us   125us
# Rows sent         35.45k       0       1    0.99    0.99    0.09    0.99
# Rows examine       2.33G       0 112.76k  66.71k 112.33k  46.50k 112.33k
# Query size        14.26M       6    1016  408.53  592.07  195.17  202.40


# Profile
# Rank Query ID                      Response time   Calls R/Call V/M   It
# ==== ============================= =============== ===== ====== ===== ==
#    1 0xB8BDB35AD896842FAC41202B... 5744.3322 81.4% 18420 0.3119  0.07 SELECT pms_sku_stock
#    2 0xC71984B4087F304BE41AC8F8... 1309.1841 18.6% 18138 0.0722  0.03 SELECT oms_cart_item
# MISC 0xMISC                           1.4979  0.0%    46 0.0326   0.0 &lt;5 ITEMS&gt;


# Query 1: 44.82 QPS, 13.98x concurrency, ID 0xB8BDB35AD896842FAC41202BB9C908E8 at byte 6504041
# This item is included in the report because it matches --limit.
# Scores: V/M = 0.07
# Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count         50   18420
# Exec time     81   5744s    76ms      1s   312ms   580ms   148ms   279ms
# Lock time     47      3s    70us    37ms   184us   224us   673us   119us
# Rows sent     50  17.99k       1       1       1       1       0       1
# Rows examine  85   1.98G 112.76k 112.76k 112.76k 112.76k       0 112.76k
# Query size    26   3.72M     212     212     212     212       0     212
# String:
# Hosts        10.100.5.54
# Users        reader
# Query_time distribution
#   1us
#  10us
# 100us
#   1ms
#  10ms  #
# 100ms  ################################################################
#    1s  #
#  10s+
# Tables
#    SHOW TABLE STATUS LIKE 'pms_sku_stock'\G
#    SHOW CREATE TABLE `pms_sku_stock`\G
# EXPLAIN /*!50100 PARTITIONS*/
select


    id, product_id, sku_code, price, stock, low_stock, pic, sale, promotion_price, lock_stock,
    sp_data

    from pms_sku_stock


     WHERE (  sku_code = '202008270027906' )\G


# Query 2: 44.13 QPS, 3.19x concurrency, ID 0xC71984B4087F304BE41AC8F82A88B245 at byte 20901845
# This item is included in the report because it matches --limit.
# Scores: V/M = 0.03
# Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count         49   18138
# Exec time     18   1309s    20ms   419ms    72ms   148ms    43ms    59ms
# Lock time     52      4s    76us    39ms   205us   260us   719us   138us
# Rows sent     49  17.45k       0       1    0.99    0.99    0.12    0.99
# Rows examine  14 356.31M  19.96k  20.22k  20.12k  19.40k       0  19.40k
# Query size    73  10.51M     604     610  607.81  592.07       0  592.07
# String:
# Hosts        10.100.5.54
# Users        reader
# Query_time distribution
#   1us
#  10us
# 100us
#   1ms
#  10ms  ################################################################
# 100ms  ##################
#    1s
#  10s+
# Tables
#    SHOW TABLE STATUS LIKE 'oms_cart_item'\G
#    SHOW CREATE TABLE `oms_cart_item`\G
# EXPLAIN /*!50100 PARTITIONS*/
select


    id, product_id, product_sku_id, member_id, quantity, price, product_pic, product_name,
    product_sub_title, product_sku_code, member_nickname, create_date, modify_date, delete_status,
    product_category_id, product_brand, product_sn, product_attr
    from oms_cart_item
     WHERE (  member_id = 381920
                       and product_id = 317
                  and delete_status = 0
                  and product_sku_id = 317 )\G
</code></pre>
<p>从上面的数据来看，我们的优化方向比较简单明了：占用总时间最长的两个SQL需要收拾，其中，一个占用了总时间的81.4%，另一个占用了18.6%。</p>
<p>我们先来看最慢的那个SQL：</p>
<pre><code>select
    id, product_id, sku_code, price, stock, low_stock, pic, sale, promotion_price, lock_stock,
    sp_data
    from pms_sku_stock
     WHERE (  sku_code = '202008270027906' )\G
</code></pre>
<p>要想知道一个语句哪里慢，就得来看一下执行计划：</p>
<p><img alt="" src="assets/3fd1f02b1296496db303ec421f246246.jpg"/></p>
<p>在执行计划中，type这一列的参数值为ALL，说明这个SQL没有用到索引。你想想，一个有where条件的语句，又没有用到索引，那它上方的索引到底合不合理呢？我们不妨检查一下这个索引：</p>
<p><img alt="" src="assets/9027125ede184bc6aaff37b38e1fc383.jpg"/></p>
<p>通过检查索引，我们看到只有一个ID列，也就是一个主键索引，并没有where条件中的sku_code列。所以，我们先给sku_code加一个索引来实现精准查询，这样就不用扫描整表的数据了：</p>
<pre><code>ALTER TABLE pms_sku_stock ADD INDEX sku_code_index (sku_code);
</code></pre>
<p>修改之后，我们再来看一下此时的执行计划：</p>
<p><img alt="" src="assets/2e1211b33fab4aa89888f9a12db79b16.jpg"/></p>
<p>现在，type列的参数值变为了ref，说明where条件确实走了索引了。那我们再把场景执行起来，看看效果：</p>
<p><img alt="" src="assets/9ce0c21bf8db4222824aa17c2263d925.jpg"/></p>
<p>从结果来看，TPS从50增加到了150以上。响应时间也从750ms左右降到250ms以下。效果显著。</p>
<p>收拾完了第一个SQL后，我们再来收拾另一个SQL。同样地，我们先看它的执行计划：</p>
<p><img alt="" src="assets/1391c081537947fabd3af165c537695b.jpg"/></p>
<p>type列的参数值为ALL，表明where条件没有使用索引。但是，第二个语句用了好几个where条件，所以，我们直接加一个组合索引，让where条件可以走到索引这里：</p>
<pre><code>ALTER TABLE oms_cart_item ADD INDEX mix_index (member_id,product_id,product_sku_id);
</code></pre>
<p>加了组合索引后，这个SQL的执行计划如下：</p>
<p><img alt="" src="assets/26d1b7462f9d497ba157c986111625cd.jpg"/></p>
<p>还是一样，我们再次把场景跑起来，看看优化了这两个最慢的SQL之后，效果如何。</p>
<h3 id="优化效果">优化效果</h3>
<p>优化效果如下：</p>
<p><img alt="" src="assets/66cd75c6ad394547b0c7c6fc22b56661.jpg"/></p>
<p>优化前后的对比图如下：</p>
<p><img alt="" src="assets/5ecbe56616e940c788af5367bd192c4b.jpg"/></p>
<p>建议你在写报告的时候，画这种对比图，用它来说明优化效果是非常直接明显的。</p>
<h2 id="分析的第二阶段">分析的第二阶段</h2>
<p>现在我们就要来分析错误了，反正也忽悠不过去。</p>
<h3 id="压力数据-1">压力数据</h3>
<p>下面是对应的错误图，我把图截多一点，可以看到趋势如下：</p>
<p><img alt="" src="assets/c180c1a4347d4f68a2e85298795eaab7.jpg"/></p>
<p>你看，<strong>TPS中有对的，也有错的，并且TPS越高的时候，错误率也越高</strong>。这一点很重要，希望你能记住。</p>
<p>紧接着，我们来拆分响应时间。</p>
<h3 id="拆分响应时间-1">拆分响应时间</h3>
<p>先设置skywalking的时间段：</p>
<p><img alt="" src="assets/f965099722174a999a0b972822bcab40.jpg"/></p>
<p>请你注意，在看性能计数器的时候，每一个工具上的时间窗口一定要对应上。</p>
<ul>
<li>User - Gateway：</li>
</ul>
<p><img alt="" src="assets/a28390c70c444d07b0b2c31ee26a34d1.jpg"/></p>
<ul>
<li>Gateway - Cart：</li>
</ul>
<p><img alt="" src="assets/86712c5facad490cb16ec9654b9cae00.jpg"/>-
<img alt="" src="assets/b6b82a90cf5b46938a6956d74ca557cc.jpg"/></p>
<ul>
<li>Cart - Member：</li>
</ul>
<p><img alt="" src="assets/162a2e983ab54d2e9b6abb41aa45e473.jpg"/><img alt="" src="assets/a82c76cb59084c8081f877b7ffb89b83.jpg"/></p>
<ul>
<li>Cart - MySQL：</li>
</ul>
<p><img alt="" src="assets/b48e6f18b39c4422bcfcf40acdfc87ae.jpg"/></p>
<ul>
<li>Member - MySQL：</li>
</ul>
<p><img alt="" src="assets/b0a029a8686a4a08a0ba335fcc349534.jpg"/></p>
<p>罗列了一堆信息之后……并没有什么发现。</p>
<p>你可能会奇怪，为什么说没有发现呢，Cart上的响应时间不是比较长吗？这里你就要注意了，我们现在分析的问题是错误，而不是响应时间，所以时间长就长呗。<strong>在分析的过程中，你一定要时刻记得自己查的是什么问题，不要走到半路就走岔了，那样会陷入混乱的状态。</strong></p>
<h3 id="全局分析-1">全局分析</h3>
<p>通常情况下，我们的全局分析都是从资源开始的对吧，也就是从性能分析决策树中一层层查下去。对应我们第4节课讲的内容，你可以把所有的第一层计数器查一遍。</p>
<p>而在我们的这个问题的分析中，其实不用那么麻烦，因为在前面看到压力数据的时候，已经看到了大量的报错了，要想分析错误，肯定得先知道错误在哪，所以，这里我们直接查日志相关的内容就可以。查到日志的时候，我们看到下面这些错误信息：</p>
<pre><code>2020-12-30 23:44:06.754 ERROR 1 --- [io-8086-exec-41] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.dao.DeadlockLoserDataAccessException: 
### Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction
### The error may involve com.dunshan.mall.mapper.OmsCartItemMapper.updateByPrimaryKey-Inline
### The error occurred while setting parameters
### SQL: update oms_cart_item     set product_id = ?,       product_sku_id = ?,       member_id = ?,       quantity = ?,       price = ?,       product_pic = ?,       product_name = ?,       product_sub_title = ?,       product_sku_code = ?,       member_nickname = ?,       create_date = ?,       modify_date = ?,       delete_status = ?,       product_category_id = ?,       product_brand = ?,       product_sn = ?,       product_attr = ?     where id = ?
### Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction
; Deadlock found when trying to get lock; try restarting transaction; nested exception is com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction] with root cause
...................................
</code></pre>
<p>这个错误已经给了我们明确的指向：死锁。可是为什么会死锁呢？</p>
<p>在性能分析中，你要记得，死锁其实是相对容易分析的内容。<strong>有争用才有锁，而死锁，就是</strong><strong>说锁被</strong><strong>争得死死的。</strong></p>
<p>下面我们开始定向分析为什么会产生锁。</p>
<h3 id="定向分析-1">定向分析</h3>
<p>首先，我们找到商品加入购物车业务对应的代码：</p>
<pre><code>/**
     * 增加购物车
     * @param productSkuCode 库存商品编号
     * @param quantity 商品数量
     * @return
     */
    @Override
    public int addCart(String productSkuCode, Integer quantity) {
     .........................................
        OmsCartItem existCartItem = getCartItem(cartItem);
        if (existCartItem == null) {
            cartItem.setCreateDate(new Date());
            count = cartItemMapper.insert(cartItem);
        } else {
            cartItem.setModifyDate(new Date());
            existCartItem.setQuantity(existCartItem.getQuantity() + cartItem.getQuantity());
            count = cartItemMapper.updateByPrimaryKey(existCartItem);
        }


        return count;
    }
</code></pre>
<p>引用这段代码的事务如下：</p>
<pre><code>@Transactional
int addCart(String productSkuCode, Integer quantity);
</code></pre>
<p>根据上面的关系，对于商品加入购物车来说，什么能引起死锁呢？你看，在代码中有一个update，它对应的也就是前面日志中的update语句。所以，要是发生死锁的话，那指定就是ID冲突了，而这个ID对应的就是会员ID。也就是说，有多个线程同时想更新同一个会员的购物车，这怎么能行！</p>
<p>既然是会员ID冲突了，那是谁给的会员信息呢？想都不用想，这个会员信息肯定是从脚本中传过来的呀，所以我们要查查脚本。</p>
<p>对应的脚本如下：</p>
<p><img alt="" src="assets/ced237f8b5ae42e9829d96f147ab1c5a.jpg"/></p>
<p>你看，这里有一个productSkuCode参数，共用了1000行数据量。</p>
<p><img alt="" src="assets/0eb348b548304d5caad006e2ce14eb5c.jpg"/></p>
<p>上面的图对应的JMeter脚本是这样的：</p>
<p><img alt="" src="assets/15b85b8dba5c4019a958dca8f60f1f00.jpg"/></p>
<p>我们来看JMeter脚本中的这三个参数：</p>
<pre><code>quotedData: false
recycle: true
stopThread: false
</code></pre>
<p>这意味着，我们所有的线程都在共用这1000条数据，并且在不断循环。这会导致数据使用重复，也就是说，如果有两个以上的线程用到了相同的用户数据，就会更新同一个购物车，于是产生冲突报错。</p>
<p>我们现在把上面三个参数改一下：</p>
<pre><code>quotedData: true
recycle: false
stopThread: true
</code></pre>
<p>这样就保证了每个线程可以分到不同的数据。</p>
<p>可是，另一个问题来了：我们做这样处理的话，1000条数据是不够用的，怎么办呢？那我们就只有把用户数据加大，等生成更多的Token之后，我们再来执行场景。</p>
<p>通过一晚上的造数，时间来到了第二天。</p>
<h3 id="优化效果-1">优化效果</h3>
<p>于是，我们得到了如下结果：</p>
<p><img alt="" src="assets/7ad9848e6dc74448b695cf06e1059438.jpg"/></p>
<p>从数据上来看，报错没有了，这是一个合理的结果。</p>
<h2 id="总结">总结</h2>
<p>现在，我们总结一下这节课。</p>
<p>“哎，哎，你先别总结呀，问题都没解决完，你看这不是还有TPS掉下来的情况吗？”</p>
<p>“年轻人，别捉急，饭都得一口一口吃，问题自然要一个一个解决了。这个问题，我会放在后面的课程中解决。”</p>
<p>在这节课中，我们从TPS不高开始，一直分析到了具体的SQL，看似是两个简单的索引就搞定的事情，逻辑也并不复杂，但是，这个分析思路非常重要。</p>
<p>对于第二个问题，我们从错误数据查到了日志中出现的死锁信息，这一点大部分人应该都可以做得到。只不过，能立即想到参数冲突的，就是有经验的人了。</p>
<p>此外，这里还有一个重点就是，<strong>参数化数据一定要符合真实场景</strong>！高老师已经反复强调很多遍了，希望你能记得住。</p>
<h2 id="课后作业">课后作业</h2>
<p>最后，我给你留两道题，请你思考一下：</p>
<ol>
<li>除了用本节课中的手段，你还有什么方法可以快速定位到SQL语句慢的问题？</li>
<li>你能画出在第二阶段分析中的逻辑吗？</li>
</ol>
<p>记得在留言区和我讨论、交流你的想法，每一次思考都会让你更进一步。</p>
<p>如果你读完这篇文章有所收获，也欢迎你分享给你的朋友，共同学习进步。我们下一讲再见！</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#e8848484d1dcd9d9d8dfa88f85898184c68b8785" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935988719d1c8278',t:'MTc0NTUzODk0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>