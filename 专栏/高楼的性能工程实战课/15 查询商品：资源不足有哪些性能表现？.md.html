<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="15 查询商品：资源不足有哪些性能表现？" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>15 查询商品：资源不足有哪些性能表现？ </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%e6%89%93%e7%a0%b4%e5%9b%9b%e5%a4%a7%e8%ae%a4%e7%9f%a5%e5%b1%80%e9%99%90%ef%bc%8c%e8%bf%9b%e9%98%b6%e9%ab%98%e7%ba%a7%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%b8%88.md.html" id="00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html">00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/01%20%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%be%88%e5%a4%9a%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95%e4%ba%ba%e5%91%98%e6%97%a0%e6%b3%95%e5%af%b9%e6%80%a7%e8%83%bd%e7%bb%93%e6%9e%9c%e8%b4%9f%e8%b4%a3%ef%bc%9f.md.html" id="01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html">01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/02%20%e5%85%b3%e9%94%ae%e6%a6%82%e5%bf%b5%ef%bc%9a%e6%80%a7%e8%83%bd%e6%8c%87%e6%a0%87%e5%92%8c%e5%9c%ba%e6%99%af%e7%9a%84%e7%a1%ae%e5%ae%9a.md.html" id="02 关键概念：性能指标和场景的确定.md.html">02 关键概念：性能指标和场景的确定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/03%20%e6%a0%b8%e5%bf%83%e5%88%86%e6%9e%90%e9%80%bb%e8%be%91%ef%bc%9a%e6%89%80%e6%9c%89%e7%9a%84%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%ef%bc%8c%e9%9d%a0%e8%bf%99%e4%b8%83%e6%ad%a5%e9%83%bd%e8%83%bd%e6%90%9e%e5%ae%9a.md.html" id="03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html">03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/04%20%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%86%b3%e7%ad%96%e6%a0%91%e5%92%8c%e6%9f%a5%e6%89%be%e7%93%b6%e9%a2%88%e8%af%81%e6%8d%ae%e9%93%be%ef%bc%9f.md.html" id="04 如何构建性能分析决策树和查找瓶颈证据链？.md.html">04 如何构建性能分析决策树和查找瓶颈证据链？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/05%20%e6%80%a7%e8%83%bd%e6%96%b9%e6%a1%88%ef%bc%9a%e4%bd%a0%e7%9a%84%e6%96%b9%e6%a1%88%e6%98%af%e5%90%a6%e8%bf%98%e5%81%9c%e7%95%99%e5%9c%a8%e5%bd%a2%e5%bc%8f%e4%b8%8a%ef%bc%9f.md.html" id="05 性能方案：你的方案是否还停留在形式上？.md.html">05 性能方案：你的方案是否还停留在形式上？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/06%20%e5%a6%82%e4%bd%95%e6%8a%bd%e5%8f%96%e5%87%ba%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af%e7%9a%84%e4%b8%9a%e5%8a%a1%e6%a8%a1%e5%9e%8b%ef%bc%9f.md.html" id="06 如何抽取出符合真实业务场景的业务模型？.md.html">06 如何抽取出符合真实业务场景的业务模型？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/07%20%e6%80%a7%e8%83%bd%e5%9c%ba%e6%99%af%e7%9a%84%e6%95%b0%e6%8d%ae%e5%88%b0%e5%ba%95%e5%ba%94%e8%af%a5%e5%81%9a%e6%88%90%e4%bb%80%e4%b9%88%e6%a0%b7%e5%ad%90%ef%bc%9f.md.html" id="07 性能场景的数据到底应该做成什么样子？.md.html">07 性能场景的数据到底应该做成什么样子？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/08%20%e5%b9%b6%e5%8f%91%e3%80%81%e5%9c%a8%e7%ba%bf%e5%92%8cTPS%e5%88%b0%e5%ba%95%e6%98%af%e4%bb%80%e4%b9%88%e5%85%b3%e7%b3%bb%ef%bc%9f.md.html" id="08 并发、在线和TPS到底是什么关系？.md.html">08 并发、在线和TPS到底是什么关系？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/09%20%e5%a6%82%e4%bd%95%e8%ae%be%e8%ae%a1%e5%85%a8%e5%b1%80%e5%92%8c%e5%ae%9a%e5%90%91%e7%9b%91%e6%8e%a7%e7%ad%96%e7%95%a5%ef%bc%9f.md.html" id="09 如何设计全局和定向监控策略？.md.html">09 如何设计全局和定向监控策略？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/10%20%e8%ae%be%e8%ae%a1%e5%9f%ba%e5%87%86%e5%9c%ba%e6%99%af%e9%9c%80%e8%a6%81%e6%b3%a8%e6%84%8f%e5%93%aa%e4%ba%9b%e5%85%b3%e9%94%ae%e7%82%b9%ef%bc%9f.md.html" id="10 设计基准场景需要注意哪些关键点？.md.html">10 设计基准场景需要注意哪些关键点？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/11%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%b8%80%ef%bc%9a%e4%b8%80%e4%b8%aa%e6%a1%88%e4%be%8b%ef%bc%8c%e5%b8%a6%e4%bd%a0%e6%90%9e%e6%87%82%e5%9f%ba%e7%a1%80%e7%a1%ac%e4%bb%b6%e8%ae%be%e6%96%bd%e7%9a%84%e6%80%a7%e8%83%bd%e9%97%ae%e9%a2%98.md.html" id="11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html">11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/12%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%ba%8c%ef%bc%9a%e5%a6%82%e4%bd%95%e5%b9%b3%e8%a1%a1%e5%88%a9%e7%94%a8%e7%a1%ac%e4%bb%b6%e8%b5%84%e6%ba%90%ef%bc%9f.md.html" id="12 打开首页之二：如何平衡利用硬件资源？.md.html">12 打开首页之二：如何平衡利用硬件资源？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/13%20%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%ef%bc%9a%e6%80%8e%e4%b9%88%e5%88%a4%e6%96%ad%e7%ba%bf%e7%a8%8b%e4%b8%ad%e7%9a%84Block%e5%8e%9f%e5%9b%a0%ef%bc%9f.md.html" id="13 用户登录：怎么判断线程中的Block原因？.md.html">13 用户登录：怎么判断线程中的Block原因？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/14%20%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af%e6%9f%a5%e8%af%a2%ef%bc%9a%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e7%bd%91%e7%bb%9c%e8%bd%af%e4%b8%ad%e6%96%ad%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html">14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/15%20%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81%ef%bc%9a%e8%b5%84%e6%ba%90%e4%b8%8d%e8%b6%b3%e6%9c%89%e5%93%aa%e4%ba%9b%e6%80%a7%e8%83%bd%e8%a1%a8%e7%8e%b0%ef%bc%9f.md.html" id="15 查询商品：资源不足有哪些性能表现？.md.html">15 查询商品：资源不足有哪些性能表现？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/16%20%e5%95%86%e5%93%81%e5%8a%a0%e5%85%a5%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9aSQL%e4%bc%98%e5%8c%96%e5%92%8c%e5%8e%8b%e5%8a%9b%e5%b7%a5%e5%85%b7%e4%b8%ad%e7%9a%84%e5%8f%82%e6%95%b0%e5%88%86%e6%9e%90.md.html" id="16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html">16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/17%20%e6%9f%a5%e8%af%a2%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e9%93%ba%e5%ba%95%e5%8f%82%e6%95%b0%e4%b8%80%e5%ae%9a%e8%a6%81%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e7%89%b9%e6%80%a7%ef%bc%9f.md.html" id="17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html">17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/18%20%e8%b4%ad%e7%89%a9%e8%bd%a6%e4%bf%a1%e6%81%af%e7%a1%ae%e5%ae%9a%e8%ae%a2%e5%8d%95%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8a%a8%e6%80%81%e5%8f%82%e6%95%b0%e5%8c%96%e9%80%bb%e8%be%91%e9%9d%9e%e5%b8%b8%e9%87%8d%e8%a6%81%ef%bc%9f.md.html" id="18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html">18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/19%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e5%ba%94%e7%94%a8JDBC%e6%b1%a0%e4%bc%98%e5%8c%96%e5%92%8c%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%e5%88%86%e6%9e%90.md.html" id="19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html">19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/20%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e5%a4%8d%e6%9d%82%ef%bc%8c%e6%80%8e%e4%b9%88%e5%81%9a%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%ef%bc%9f.md.html" id="20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html">20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/21%20%e6%94%af%e4%bb%98%e5%89%8d%e6%9f%a5%e8%af%a2%e8%ae%a2%e5%8d%95%e5%88%97%e8%a1%a8%ef%bc%9a%e5%a6%82%e4%bd%95%e5%88%86%e6%9e%90%e4%bc%98%e5%8c%96%e4%b8%80%e4%b8%aa%e5%9b%ba%e5%ae%9a%e7%9a%84%e6%8a%80%e6%9c%af%e7%bb%84%e4%bb%b6%ef%bc%9f.md.html" id="21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html">21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/22%20%e6%94%af%e4%bb%98%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%ef%bc%9a%e5%a6%82%e4%bd%95%e9%ab%98%e6%95%88%e8%a7%a3%e5%86%b3for%e5%be%aa%e7%8e%af%e4%ba%a7%e7%94%9f%e7%9a%84%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%ef%bc%9f.md.html" id="22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html">22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/23%20%e5%86%b3%e5%ae%9a%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e6%88%90%e8%b4%a5%e7%9a%84%e5%85%b3%e9%94%ae%e5%9b%a0%e7%b4%a0%e6%9c%89%e5%93%aa%e4%ba%9b%ef%bc%9f.md.html" id="23 决定容量场景成败的关键因素有哪些？.md.html">23 决定容量场景成败的关键因素有哪些？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/24%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96%e5%92%8cKubernetes%e8%b5%84%e6%ba%90%e5%88%86%e9%85%8d%e4%b8%8d%e5%9d%87%e8%a1%a1%e6%80%8e%e4%b9%88%e5%8a%9e%ef%bc%9f.md.html" id="24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html">24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/25%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e7%bc%93%e5%ad%98%e5%af%b9%e6%80%a7%e8%83%bd%e4%bc%9a%e6%9c%89%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e5%bd%b1%e5%93%8d%ef%bc%9f.md.html" id="25 容量场景之二：缓存对性能会有什么样的影响？.md.html">25 容量场景之二：缓存对性能会有什么样的影响？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/26%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e4%b8%9a%e5%8a%a1%e7%a7%af%e7%b4%af%e9%87%8f%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html">26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/27%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e7%a3%81%e7%9b%98%e4%b8%8d%e8%b6%b3%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html">27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/28%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%e7%9a%84%e8%8c%83%e5%9b%b4%e5%92%8c%e8%ae%be%e8%ae%a1%e9%80%bb%e8%be%91%ef%bc%9f.md.html" id="28 如何确定异常场景的范围和设计逻辑？.md.html">28 如何确定异常场景的范围和设计逻辑？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/29%20%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%ef%bc%9a%e5%a6%82%e4%bd%95%e6%a8%a1%e6%8b%9f%e4%b8%8d%e5%90%8c%e7%bb%84%e4%bb%b6%e5%b1%82%e7%ba%a7%e7%9a%84%e5%bc%82%e5%b8%b8%ef%bc%9f.md.html" id="29 异常场景：如何模拟不同组件层级的异常？.md.html">29 异常场景：如何模拟不同组件层级的异常？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/30%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e7%94%9f%e4%ba%a7%e7%b3%bb%e7%bb%9f%e9%85%8d%e7%bd%ae%ef%bc%9f.md.html" id="30 如何确定生产系统配置？.md.html">30 如何确定生产系统配置？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/31%20%e6%80%8e%e4%b9%88%e5%86%99%e5%87%ba%e6%9c%89%e4%bb%b7%e5%80%bc%e7%9a%84%e6%80%a7%e8%83%bd%e6%8a%a5%e5%91%8a%ef%bc%9f.md.html" id="31 怎么写出有价值的性能报告？.md.html">31 怎么写出有价值的性能报告？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e6%88%91%e4%bb%ac%e8%bf%99%e4%b8%aa%e8%af%be%e7%a8%8b%e7%9a%84%e7%b3%bb%e7%bb%9f%e6%98%af%e6%80%8e%e4%b9%88%e6%90%ad%e5%bb%ba%e8%b5%b7%e6%9d%a5%e7%9a%84%ef%bc%9f.md.html" id="我们这个课程的系统是怎么搭建起来的？.md.html">我们这个课程的系统是怎么搭建起来的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e7%bb%93%e6%9d%9f%e8%af%ad%20%e5%81%9a%e7%9c%9f%e6%ad%a3%e7%9a%84%e6%80%a7%e8%83%bd%e9%a1%b9%e7%9b%ae.md.html" id="结束语 做真正的性能项目.md.html">结束语 做真正的性能项目.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="15 查询商品：资源不足有哪些性能表现？" id="title">15 查询商品：资源不足有哪些性能表现？</h1>
<div><p>你好，我是高楼。</p>
<p>这节课，我们来收拾“查询商品”这个接口。虽然这次的现象同样是TPS低、响应时间长，但是，这个接口走的路径和之前的不一样，所以在分析过程中会有些新鲜的东西，你将看到在资源真的不足的情况下，我们只有增加相应节点的资源才能提升性能。</p>
<p>在我的项目中，我一直都在讲，<strong>不要轻易给出资源不足的结论。因为但凡有优化的空间，我们都要尝试做优化，而不是直接告诉客户加资源。而给出“增加资源”这个结论，也必须建立在有足够证据的基础上</strong>。在这节课中，你也将看到这一点。</p>
<p>话不多说，我们直接开始今天的内容。</p>
<h2 id="压力场景数据">压力场景数据</h2>
<p>对于查询商品接口，我们第一次试执行性能场景的结果如下：</p>
<p><img alt="" src="assets/4b81ba59a7e24e6db7c98d4043fb7314.jpg"/></p>
<p>你看，TPS只有250左右，并且响应时间也明显随着压力的增加而增加了，看起来瓶颈已经出现了，对吧？根据哥的逻辑，下一步就是看架构图啦。</p>
<h2 id="先看架构图">先看架构图</h2>
<p>我们用APM工具来看看这个接口的架构。</p>
<p><img alt="" src="assets/ff46cef5507d463e97ddab2d5396004a.jpg"/></p>
<p>你看，从压力机到Gateway服务、到Search服务、再到ES-Client，这个APM工具也只能帮我们到这里了。因为我们用的是ElasticSearch 7来做的搜索服务的支撑，而这个skywalking工具也没有对应的Agent，所以后面并没有配置skywalking。</p>
<p>在这里，我要多啰嗦几句。现在的APM工具大多是基于应用层来做的，有些运维APM采集的数据会更多一些，但也是响应时间、吞吐量等这样的信息。对于性能分析而言，现在的APM工具有减少排查时间的能力，但是在组件级的细化定位上还有待提高。虽然AI OPS也被提到了台面，但是也没见过哪个公司上了AIOPS产品后，就敢不让人看着。</p>
<p>总之，从细化分析的角度，我们在定位问题的根本原因时，手头有什么工具就可以用什么工具，即使什么工具都没有，撸日志也是照样能做到的，所以我建议你不要迷信工具，要“迷信”思路。</p>
<p>下面我们来拆分下这个接口的响应时间，看看这个案例的问题点在哪里。</p>
<h2 id="拆分响应时间">拆分响应时间</h2>
<p><strong>“在RESAR性能分析逻辑中，拆分响应时间只是一个分析的起点</strong>。”这是我一直在强调的一句话。如果性能工程师连这个都不会做，就只能好好学习天天向上了。</p>
<p>根据架构图，我们拆分响应时间如下。</p>
<ul>
<li>Gateway服务上的响应时间：</li>
</ul>
<p><img alt="" src="assets/b45f55b76f294ef08478b3c137007197.jpg"/></p>
<ul>
<li>Search服务上的响应时间：</li>
</ul>
<p><img alt="" src="assets/e94b4278ce13435c94ed22f3302d8ec1.jpg"/></p>
<ul>
<li>ES Client的响应时间：</li>
</ul>
<p><img alt="" src="assets/af89930d170f4fadb7d887f5145cbfc8.jpg"/></p>
<p>一层层看过之后，我们发现查询商品这个接口的响应时间消耗在了ES client上面。而在我们这个查询的路径上，在gateway/search服务上，我们并没有做什么复杂的动作。</p>
<p>既然知道了响应时间消耗在哪里，下面我们就来定位它，看能不能把TPS优化起来。</p>
<h2 id="全局监控">全局监控</h2>
<p>根据高老师的经验，我们还是从全局监控开始，看全局监控可以让我们更加有的放矢。在分析的过程中，经常有人往下走了几步之后，就开始思维混乱、步伐飘逸。因为数据有很多，所以分析时很容易从一个数据走到不重要的分支上去了。而这时候，如果你心里有全局监控数据，思路就会更清晰，不会在无关的分支上消耗时间。</p>
<p>回到我们这个例子中，从下面的k8s worker（也就是k8s中的node，在我们的环境中我习惯叫成worker，就是为了体现：在我的地盘，我爱叫啥就叫啥）的数据上来看，似乎没有一个worker的资源使用率是特别高的。</p>
<p><img alt="" src="assets/9023afcbc0e1414e964ccb7e1d0d2431.jpg"/></p>
<p>请你注意，在k8s中看资源消耗，一定不要只看worker这个层面，因为这个层面还不够，一个worker上可能会运行多个pod。从上图来看，由于worker层面没有资源消耗，但是时间又明显是消耗在ES client上的，所以，接下来我们要看一下每一个pod的资源使用情况。</p>
<p><img alt="" src="assets/8fc6f26bcb1949b4b52ceddd75e8f2fe.jpg"/></p>
<p>咦，有红色。你看，有两个与ES相关的POD，它们的CPU都飘红了，这下可有得玩了。既然是与ES相关的POD，那我们就把ES所有的POD排个序看看。</p>
<p><img alt="" src="assets/9bcc022b6e1f48588a352e073dd7e17d.jpg"/></p>
<p>从上图的数据来看，有一个ES Client 消耗了67%的CPU，有两个ES Data消耗了99%的CPU，ES本来就是吃CPU的大户，所以我们接下来要着重分析它。</p>
<p>这里我再说明一点，我们从前面的worker资源使用率一步一步走到这里，在分析方向上是合情合理的，因为这些都是属于我提到的全局监控的内容。</p>
<h2 id="定向分析">定向分析</h2>
<p>现在我们就来扒一扒ES，看看它在哪个worker节点上。罗列Pod信息如下：</p>
<pre><code>[root@k8s-master-1 ~]# kubectl get pods -o wide | grep elasticsearch
elasticsearch-client-0                      1/1     Running   0          6h43m   10.100.230.2     k8s-worker-1   &lt;none&gt;           &lt;none&gt;
elasticsearch-client-1                      1/1     Running   0          6h45m   10.100.140.8     k8s-worker-2   &lt;none&gt;           &lt;none&gt;
elasticsearch-data-0                        1/1     Running   0          7h8m    10.100.18.197    k8s-worker-5   &lt;none&gt;           &lt;none&gt;
elasticsearch-data-1                        1/1     Running   0          7h8m    10.100.5.5       k8s-worker-7   &lt;none&gt;           &lt;none&gt;
elasticsearch-data-2                        1/1     Running   0          7h8m    10.100.251.67    k8s-worker-9   &lt;none&gt;           &lt;none&gt;
elasticsearch-master-0                      1/1     Running   0          7h8m    10.100.230.0     k8s-worker-1   &lt;none&gt;           &lt;none&gt;
elasticsearch-master-1                      1/1     Running   0          7h8m    10.100.227.131   k8s-worker-6   &lt;none&gt;           &lt;none&gt;
elasticsearch-master-2                      1/1     Running   0          7h8m    10.100.69.206    k8s-worker-3   &lt;none&gt;           &lt;none&gt;
[root@k8s-master-1 ~]# 
</code></pre>
<p>现在就比较清晰了，可以看到，在整个namespace中有两个ES client，三个ES data，三个ES master。</p>
<p>我们来画一个细一点的架构图，以便在脑子里记下这个逻辑：</p>
<p><img alt="" src="assets/9f8a01ef5f424fdaa98972daba197f33.jpg"/></p>
<p>再结合我们在全局分析中看到的资源使用率图，现在判断至少有两个问题：</p>
<ol>
<li>ES client请求不均衡；</li>
<li>ES data CPU 高。</li>
</ol>
<p>下面我们一个一个来分析。</p>
<h3 id="es-client请求不均衡">ES client请求不均衡</h3>
<p>从上面的架构图中可以看到，search服务连两个ES client，但是只有一个ES client的CPU使用率高。所以，我们需要查一下链路，看看ES的service：</p>
<pre><code>[root@k8s-master-1 ~]# kubectl get svc -o wide | grep search
elasticsearch-client            NodePort    10.96.140.52    &lt;none&gt;        9200:30200/TCP,9300:31614/TCP         34d     app=elasticsearch-client,chart=elasticsearch,heritage=Helm,release=elasticsearch-client
elasticsearch-client-headless   ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP                     34d     app=elasticsearch-client
elasticsearch-data              ClusterIP   10.96.16.151    &lt;none&gt;        9200/TCP,9300/TCP                     7h41m   app=elasticsearch-data,chart=elasticsearch,heritage=Helm,release=elasticsearch-data
elasticsearch-data-headless     ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP                     7h41m   app=elasticsearch-data
elasticsearch-master            ClusterIP   10.96.207.238   &lt;none&gt;        9200/TCP,9300/TCP                     7h41m   app=elasticsearch-master,chart=elasticsearch,heritage=Helm,release=elasticsearch-master
elasticsearch-master-headless   ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP                     7h41m   app=elasticsearch-master
svc-mall-search                 ClusterIP   10.96.27.150    &lt;none&gt;        8081/TCP                              44d     app=svc-mall-search
[root@k8s-master-1 ~]# 
</code></pre>
<p>你看，整个namespace中有一个client service（解析出来的是VIP，访问此服务时不会绕过K8s的转发机制），还有一个client-headless service（解析出来的是POD IP，访问这个服务时会绕过K8s的转发机制）。</p>
<p>接下来，我们查一下为什么会出现访问不均衡的情况。</p>
<p>通过查看search服务的ES配置，我们看到如下信息：</p>
<pre><code>  elasticsearch:
    rest:
      uris: elasticsearch-client:9200
      username: elastic
      password: admin@123
</code></pre>
<p>看到我们这里是用的elasticsearch-client:9200，我们再来看一下client service的配置：</p>
<pre><code>---
apiVersion: v1
kind: Service
metadata:
  annotations:
    meta.helm.sh/release-name: elasticsearch-client
    meta.helm.sh/release-namespace: default
  creationTimestamp: '2020-12-10T17:34:19Z'
  labels:
    app: elasticsearch-client
    app.kubernetes.io/managed-by: Helm
    chart: elasticsearch
    heritage: Helm
    release: elasticsearch-client
  managedFields:
    - apiVersion: v1
      fieldsType: FieldsV1
      fieldsV1:
        'f:metadata': {}
        'f:spec':
          'f:ports': {}
      manager: Go-http-client
      operation: Update
      time: '2020-12-10T17:34:19Z'
  name: elasticsearch-client
  namespace: default
  resourceVersion: '4803428'
  selfLink: /api/v1/namespaces/default/services/elasticsearch-client
  uid: 457e962e-bee0-49b7-9ec4-ebfbef0fecdd
spec:
  clusterIP: 10.96.140.52
  externalTrafficPolicy: Cluster
  ports:
    - name: http
      nodePort: 30200
      port: 9200
      protocol: TCP
      targetPort: 9200
    - name: transport
      nodePort: 31614
      port: 9300
      protocol: TCP
      targetPort: 9300
  selector:
    app: elasticsearch-client
    chart: elasticsearch
    heritage: Helm
    release: elasticsearch-client
  sessionAffinity: None
  type: NodePort
</code></pre>
<p>从上面的配置来看，sessionAffinity也配置为None了，也就是说这个service不以客户端的IP来保持session。因为在这个环境配置中，Type为NodePort，而我们在k8s中配置的转发规则是iptables。所以说，service是依赖iptables的规则来做后端转发的。</p>
<p>接下来，我们检查一下iptables的转发规则。</p>
<p>我们先来看iptables中关于ES client的规则：</p>
<pre><code>[root@k8s-master-1 ~]# iptables -S KUBE-SERVICES -t nat|grep elasticsearch-client|grep 9200
-A KUBE-SERVICES ! -s 10.100.0.0/16 -d 10.96.140.52/32 -p tcp -m comment --comment "default/elasticsearch-client:http cluster IP" -m tcp --dport 9200 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.96.140.52/32 -p tcp -m comment --comment "default/elasticsearch-client:http cluster IP" -m tcp --dport 9200 -j KUBE-SVC-XCX4XZ2WPAE7BUZ4
[root@k8s-master-1 ~]# 
</code></pre>
<p>可以看到，service的规则名是KUBE-SVC-XCX4XZ2WPAE7BUZ4，那我们再去查它对应的iptables规则：</p>
<pre><code>[root@k8s-master-1 ~]# iptables -S KUBE-SVC-XCX4XZ2WPAE7BUZ4 -t nat
-N KUBE-SVC-XCX4XZ2WPAE7BUZ4
-A KUBE-SVC-XCX4XZ2WPAE7BUZ4 -m comment --comment "default/elasticsearch-client:http" -j KUBE-SEP-LO263M5QW4XA6E3Q
[root@k8s-master-1 ~]#
[root@k8s-master-1 ~]# iptables -S KUBE-SEP-LO263M5QW4XA6E3Q -t nat
-N KUBE-SEP-LO263M5QW4XA6E3Q
-A KUBE-SEP-LO263M5QW4XA6E3Q -s 10.100.227.130/32 -m comment --comment "default/elasticsearch-client:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-LO263M5QW4XA6E3Q -p tcp -m comment --comment "default/elasticsearch-client:http" -m tcp -j DNAT --to-destination 10.100.227.130:9200
</code></pre>
<p>问题来了，这里好像没有负载均衡的配置（没有probability参数），并且根据iptables规则也只是转发到了一个ES client上。到这里，其实我们也就能理解，为什么在全局监控的时候，我们只看到一个ES client有那么高的CPU使用率，而另一个ES client却一点动静都没有。</p>
<p>但是，这里的iptables规则并不是自己来配置的，而是在部署k8s的时候自动刷进去的规则。现在只有一条规则了，所以只能转发到一个POD上去。</p>
<p>那我们就再刷一遍ES的POD，重装一下ES的POD，看k8s自己能不能刷出来负载均衡的iptables规则。重来一遍之后，我们再来看iptables规则：</p>
<pre><code>[root@k8s-master-1 ~]# iptables -S KUBE-SVC-XCX4XZ2WPAE7BUZ4 -t nat
-N KUBE-SVC-XCX4XZ2WPAE7BUZ4
-A KUBE-SVC-XCX4XZ2WPAE7BUZ4 -m comment --comment "default/elasticsearch-client:http" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-IFM4L7YNSTSJP4YT
-A KUBE-SVC-XCX4XZ2WPAE7BUZ4 -m comment --comment "default/elasticsearch-client:http" -j KUBE-SEP-5RAP6F6FATXC4DFL
[root@k8s-master-1 ~]#
</code></pre>
<p>哟，现在刷出来两条iptables规则了，看来之前在我们不断折腾的部署过程中，ES client一直是有问题的。</p>
<p>在上面的iptables规则里，那两条iptables的上一条中有一个关键词“——probability 0.50000000000”。我们知道，iptables的匹配规则是从上到下的，既然上一条的匹配是随机0.5，也就是说只有50%的请求会走第一条规则，那下一条自然也是随机0.5了，因为总共只有两条规则嘛。这样一来就均衡了。</p>
<p>我们再接着做这个接口的压力场景，看到如下信息：</p>
<p><img alt="" src="assets/f9f8def7502a49c082b2ba44db044baa.jpg"/></p>
<p>看起来ES client均衡了，对不对？</p>
<p>它对应的TPS，如下：</p>
<p><img alt="" src="assets/6416260186644daebf6f302e82c023b8.jpg"/></p>
<p>明显TPS提升了60左右。</p>
<p>ES client请求不均衡的问题解决了，现在，我们还要来看一下ES data单节点CPU高的问题。</p>
<h3 id="es-data-cpu使用率高">ES Data CPU使用率高</h3>
<ul>
<li><strong>第一阶段：加一个CPU</strong></li>
</ul>
<p>在TPS提升之后，我们再来看一下全局监控数据。</p>
<p><img alt="" src="assets/86f4c6eec6b741c0b68476caf14fd5c9.jpg"/></p>
<p>看起来比一开始好多了。基于前面分析ES client的经验，我们就先来查一下ES data的iptables规则：</p>
<pre><code>-- 查看下有哪些ES data的POD
[root@k8s-master-1 ~]# kubectl get pods -o wide | grep data
elasticsearch-data-0                        1/1     Running   0          10h     10.100.18.197    k8s-worker-5   &lt;none&gt;           &lt;none&gt;
elasticsearch-data-1                        1/1     Running   0          10h     10.100.5.5       k8s-worker-7   &lt;none&gt;           &lt;none&gt;
elasticsearch-data-2                        1/1     Running   0          10h     10.100.251.67    k8s-worker-9   &lt;none&gt;           &lt;none&gt;


-- 查看ES data对应的iptables规则
[root@k8s-master-1 ~]# iptables -S KUBE-SERVICES -t nat|grep elasticsearch-data
-A KUBE-SERVICES ! -s 10.100.0.0/16 -d 10.96.16.151/32 -p tcp -m comment --comment "default/elasticsearch-data:http cluster IP" -m tcp --dport 9200 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.96.16.151/32 -p tcp -m comment --comment "default/elasticsearch-data:http cluster IP" -m tcp --dport 9200 -j KUBE-SVC-4LU6GV7CN63XJXEQ
-A KUBE-SERVICES ! -s 10.100.0.0/16 -d 10.96.16.151/32 -p tcp -m comment --comment "default/elasticsearch-data:transport cluster IP" -m tcp --dport 9300 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.96.16.151/32 -p tcp -m comment --comment "default/elasticsearch-data:transport cluster IP" -m tcp --dport 9300 -j KUBE-SVC-W4QKPGOO4JGYQZDQ


-- 查看9200（外部通信）对应的规则
[root@k8s-master-1 ~]# iptables -S KUBE-SVC-4LU6GV7CN63XJXEQ -t nat
-N KUBE-SVC-4LU6GV7CN63XJXEQ
-A KUBE-SVC-4LU6GV7CN63XJXEQ -m comment --comment "default/elasticsearch-data:http" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-ZHLKOYKJY5GV3ZVN
-A KUBE-SVC-4LU6GV7CN63XJXEQ -m comment --comment "default/elasticsearch-data:http" -m statistic --mode random --probability 1 -j KUBE-SEP-6ILKZEZS3TMCB4VJ
-A KUBE-SVC-4LU6GV7CN63XJXEQ -m comment --comment "default/elasticsearch-data:http" -j KUBE-SEP-JOYLBDPA3LNXKWUK


-- 查看以上三条规则的转发目标
[root@k8s-master-1 ~]# iptables -S KUBE-SEP-ZHLKOYKJY5GV3ZVN -t nat
-N KUBE-SEP-ZHLKOYKJY5GV3ZVN
-A KUBE-SEP-ZHLKOYKJY5GV3ZVN -s 10.100.18.197/32 -m comment --comment "default/elasticsearch-data:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-ZHLKOYKJY5GV3ZVN -p tcp -m comment --comment "default/elasticsearch-data:http" -m tcp -j DNAT --to-destination 10.100.18.197:9200
[root@k8s-master-1 ~]# iptables -S KUBE-SEP-6ILKZEZS3TMCB4VJ -t nat
-N KUBE-SEP-6ILKZEZS3TMCB4VJ
-A KUBE-SEP-6ILKZEZS3TMCB4VJ -s 10.100.251.67/32 -m comment --comment "default/elasticsearch-data:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-6ILKZEZS3TMCB4VJ -p tcp -m comment --comment "default/elasticsearch-data:http" -m tcp -j DNAT --to-destination 10.100.251.67:9200
[root@k8s-master-1 ~]# iptables -S KUBE-SEP-JOYLBDPA3LNXKWUK -t nat
-N KUBE-SEP-JOYLBDPA3LNXKWUK
-A KUBE-SEP-JOYLBDPA3LNXKWUK -s 10.100.5.5/32 -m comment --comment "default/elasticsearch-data:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-JOYLBDPA3LNXKWUK -p tcp -m comment --comment "default/elasticsearch-data:http" -m tcp -j DNAT --to-destination 10.100.5.5:9200
[root@k8s-master-1 ~]
</code></pre>
<p>Everything is perfect!！规则很合理。ES Data总共有三个pod，从逻辑上来看，它们各占了三分之一。</p>
<p>在前面的ES client分析中，我们讲到，第一个POD是0.5，下一条自然也只剩下0.5，这很容易理解。现在，ES data的部分有三条iptables规则，我们来简单说明一下。</p>
<blockquote>
<p>通常我们理解的iptables就是一个防火墙。不过，要是从根本上来讲，它不算是一个防火墙，只是一堆规则列表，而通过iptables设计的规则列表，请求会对应到netfilter框架中去，而这个netfilter框架，才是真正的防火墙。其中，netfilter是处于内核中的，iptables就只是一个用户空间上的配置工具而已。</p>
<p>我们知道iptables有四表五链。四表是：fileter表（负责过滤）、nat表（负责地址转换）、mangle表（负责解析）、raw表（关闭nat表上启用的连接追踪）；五链是：prerouting链（路由前）、input链（输入规则）、forward链（转发规则）、output链（输出规则）、postrouting链（路由后）。</p>
<p>而在这一部分，我们主要是看nat表以及其上的链。对于其他的部分，如果你想学习，可自行查阅iptables相关知识。毕竟，我还时刻记得自己写的是一个性能专栏，而不是计算机基础知识专栏，哈哈。</p>
</blockquote>
<p>从上面的信息可以看到，我们的这个集群中有三个ES data服务，对应着三条转发规则，其中，第一条规则的匹配比例是：0.33333333349；第二条比例：0.50000000000；第三条是1。而这三条转发规则对应的POD IP和端口分别是：10.100.18.197:9200、10.100.251.67:9200、10.100.5.5:9200，这也就意味着，通过这三条iptables规则可以实现负载均衡，画图理解如下：</p>
<p><img alt="" src="assets/961cf84d158546949a556e0fc6b32e08.jpg"/></p>
<p>我们假设有30个请求进来，那ES Data 0上就会有30x0.33333333349=10个请求；对于剩下的20个请求，在ES Data 1上就会有20x0.50000000000=10个请求；而最后剩下的10个请求，自然就到了ES Data 2上。这是一个非常均衡的逻辑，只是在iptables规则中，我看着这几个数据比例，实在是觉得别扭。</p>
<p>既然明白了这个逻辑，下面我们还是把查询商品接口的场景压起来看一下：</p>
<p><img alt="" src="assets/5a7c5abf0ee54a94b62e4c5cdc9711eb.jpg"/></p>
<p>从数据上来看，经常会出现ES data 某个节点消耗CPU高的情况。可是，对应到我们前面看到的全局worker监控界面中，并没有哪个worker的CPU很高。所以，在这里，我们要查一下ES Data中的cgroup配置，看它的限制是多少。</p>
<p><img alt="" src="assets/da9e5672e8844282b46ab332f62c28db.jpg"/></p>
<p>也就是说，ES data的每个POD都是配置了一颗CPU，难怪CPU使用率动不动就红了。</p>
<p>还有一点你要记住，前面我们在查看data列表的时候发现，ES data 0 在worker-5上，ES data 1 在worker-7上，ES data 2 在worker-9上。而我们现在看到的却是，它们都各自分到了一个CPU。既然如此，那我们就再添加一个CPU，然后再回去看一下worker-5/7/9的反应。为什么只加一个CPU呢？因为从worker-7上来看，现在的CPU使用率已经在50%左右了，要是加多了，我怕它吃不消。</p>
<p><img alt="" src="assets/e789820b9d8d4b42972788f927fd4451.jpg"/></p>
<p>看一下压力场景执行的效果：</p>
<p><img alt="" src="assets/54adce46598f475fb2cd85986ae7aed0.jpg"/></p>
<p>似乎……不怎么样？TPS并没有增加。</p>
<ul>
<li><strong>第二阶段：加副本</strong></li>
</ul>
<p>我们再看加了CPU之后的全局POD监控：</p>
<p><img alt="" src="assets/3ea137ea6aa04f82bf699bb2e02fc61a.jpg"/></p>
<p>还是只有一个ES data的CPU使用率高，所以我想查一下ES中的数据分布。因为负载均衡的问题解决了，并且知道有三个ES data节点。现在我们就要知道是不是每个节点都被访问到了。</p>
<pre><code>pms                               0 p 10.100.18.199 _w   32   17690 18363   6.7mb  7820 true  true  8.5.1 false
pms                               0 p 10.100.18.199 _15  41    2110     0 465.7kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.18.199 _16  42   21083 30255   9.5mb  5900 true  true  8.5.1 false
pms                               0 p 10.100.18.199 _17  43    2572     0   568kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.18.199 _18  44    1403     0 322.9kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.18.199 _19  45    1856     0 414.1kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.18.199 _1a  46    1904     0   423kb  5500 true  true  8.5.1 true
</code></pre>
<p>为啥数据都在一个节点上（都是10.100.18.199）？看起来只有一个数据副本的原因了。</p>
<pre><code>green open pms                                            A--6O32bQaSBrJPJltOLHQ 1 0   48618 48618  55.1mb  18.3mb
</code></pre>
<p>所以，我们先把副本数加上去，因为我们有三个data节点，所以这里加三个副本：</p>
<pre><code>PUT /pms/_settings
{
    "number_of_replicas": 3
}

我们再次查看ES中的数据分布，如下所示：

pms                               0 r 10.100.18.200 _w   32   17690 18363   6.7mb  7820 true  true  8.5.1 false
pms                               0 r 10.100.18.200 _15  41    2110     0 465.7kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.18.200 _16  42   21083 30255   9.5mb  5900 true  true  8.5.1 false
pms                               0 r 10.100.18.200 _17  43    2572     0   568kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.18.200 _18  44    1403     0 322.9kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.18.200 _19  45    1856     0 414.1kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.18.200 _1a  46    1904     0   423kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.251.69 _w   32   17690 18363   6.7mb  7820 true  true  8.5.1 false
pms                               0 p 10.100.251.69 _15  41    2110     0 465.7kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.251.69 _16  42   21083 30255   9.5mb  5900 true  true  8.5.1 false
pms                               0 p 10.100.251.69 _17  43    2572     0   568kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.251.69 _18  44    1403     0 322.9kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.251.69 _19  45    1856     0 414.1kb  5500 true  true  8.5.1 true
pms                               0 p 10.100.251.69 _1a  46    1904     0   423kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.140.10 _w   32   17690 18363   6.7mb  7820 true  true  8.5.1 false
pms                               0 r 10.100.140.10 _15  41    2110     0 465.7kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.140.10 _16  42   21083 30255   9.5mb  5900 true  true  8.5.1 false
pms                               0 r 10.100.140.10 _17  43    2572     0   568kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.140.10 _18  44    1403     0 322.9kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.140.10 _19  45    1856     0 414.1kb  5500 true  true  8.5.1 true
pms                               0 r 10.100.140.10 _1a  46    1904     0   423kb  5500 true  true  8.5.1 true
</code></pre>
<p>我们接着压起来，看看POD的资源：</p>
<p><img alt="" src="assets/4b0f84cc41a7484d944feabc1457f16f.jpg"/></p>
<p>现在看着是不是开心多了？data节点的CPU都用起来了。</p>
<p>我们再看一下worker的资源：</p>
<pre><code>[root@k8s-master-1 ~]# kubectl get pods -o wide | grep data
elasticsearch-data-0                        1/1     Running   0          16m     10.100.18.199    k8s-worker-5   &lt;none&gt;           &lt;none&gt;
elasticsearch-data-1                        1/1     Running   0          17m     10.100.251.68    k8s-worker-9   &lt;none&gt;           &lt;none&gt;
elasticsearch-data-2                        1/1     Running   0          18m     10.100.140.9     k8s-worker-2   &lt;none&gt;           &lt;none&gt;
</code></pre>
<p>现在ES Data的POD分布到2、5、9三这个worker上去了，我们查看下全局监控：</p>
<p><img alt="" src="assets/4bf351d25119406d81ac47041b3bee7f.jpg"/></p>
<p>嗯，不错，ES data的POD把资源用起来了。其实这里要想继续调，还可以把CPU加大，ES本来就是吃CPU、内存的大户。不过，我们前面在配置的时候，给ES data的CPU也确实太小了。这个问题，并不是我故意设计出来的，而是当时在部署的时候，没考虑到这些。</p>
<p>最后，我们来看优化后的效果：</p>
<p><img alt="" src="assets/36792ce3635c4adeb19b1e4cb5ca32ac.jpg"/></p>
<p>呀呀呀，你看TPS压都压不住呀，很快涨到900左右了！这个优化结果很好。</p>
<p>现在回过头来看第一个阶段，我们加CPU没有效果，主要还是因为副本数量太少。其实，在ES的优化中，还有很多细节可以玩。只不过，在我们这个课程中，我希望给你的是一个整体的分析思路和逻辑，而不是纠结于每个细节上的参数。所以，在这里，我们就不再说具体参数的调整了。</p>
<p>如果你想在ES上做更多的优化，可以在分析完业务之后，确定一下ES的架构、数据索引、分片等信息，然后再来设计一个合理的ES部署。</p>
<h2 id="总结">总结</h2>
<p>在这节课中，我们看到APM工具也有无能为力的地方。所以说，当我们分析到一个具体组件之后，要想再往下分析，就得靠自己的技术功底了。</p>
<p>在出现请求不均衡的时候，我们一定要先去看负载均衡的逻辑有没有问题。当看到ES client不均衡时，我们去看了iptables的原理，在发现iptables只有一个转发规则的时候，接下来要做的当然就是重刷转发规则了。</p>
<p>在ES client转发均衡了之后，我们在ES data单节点上又看到CPU使用率过高。由于ES data在POD当中，我们自然就要想到去看cgroup的限制。</p>
<p>而在添加了CPU之后，我们发现TPS并没有提高，这时候就要去看ES的逻辑了。ES的强大之处就在于多副本多分片的查询能力，所以，我们增加了副本之后，CPU就用起来了，这是一个合理的优化结果，TPS也自然提高了。</p>
<p>经过一系列的动作，我们终于把资源给用起来了。这也是我一直在强调的，<strong>性能优化第一个阶段的目标，就是把资源给用起来，然后再考虑更细节的优化</strong>。</p>
<h2 id="课后作业">课后作业</h2>
<p>最后，我给你留两道题，请你思考一下：</p>
<ol>
<li>当负载出现不均衡时，主要的分析方向是什么？</li>
<li>什么时候才需要去看组件内部的实现逻辑？</li>
</ol>
<p>记得在留言区和我讨论、交流你的想法，每一次思考都会让你更进一步。</p>
<p>如果你读完这篇文章有所收获，也欢迎你分享给你的朋友，共同学习进步。我们下一讲再见！</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#335f5f5f0a070202030473545e525a5f1d505c5e" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935988173a0fc56b',t:'MTc0NTUzODkyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>