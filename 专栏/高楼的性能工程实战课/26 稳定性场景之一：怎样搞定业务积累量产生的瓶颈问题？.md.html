<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？ </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%e6%89%93%e7%a0%b4%e5%9b%9b%e5%a4%a7%e8%ae%a4%e7%9f%a5%e5%b1%80%e9%99%90%ef%bc%8c%e8%bf%9b%e9%98%b6%e9%ab%98%e7%ba%a7%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%b8%88.md.html" id="00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html">00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/01%20%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%be%88%e5%a4%9a%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95%e4%ba%ba%e5%91%98%e6%97%a0%e6%b3%95%e5%af%b9%e6%80%a7%e8%83%bd%e7%bb%93%e6%9e%9c%e8%b4%9f%e8%b4%a3%ef%bc%9f.md.html" id="01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html">01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/02%20%e5%85%b3%e9%94%ae%e6%a6%82%e5%bf%b5%ef%bc%9a%e6%80%a7%e8%83%bd%e6%8c%87%e6%a0%87%e5%92%8c%e5%9c%ba%e6%99%af%e7%9a%84%e7%a1%ae%e5%ae%9a.md.html" id="02 关键概念：性能指标和场景的确定.md.html">02 关键概念：性能指标和场景的确定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/03%20%e6%a0%b8%e5%bf%83%e5%88%86%e6%9e%90%e9%80%bb%e8%be%91%ef%bc%9a%e6%89%80%e6%9c%89%e7%9a%84%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%ef%bc%8c%e9%9d%a0%e8%bf%99%e4%b8%83%e6%ad%a5%e9%83%bd%e8%83%bd%e6%90%9e%e5%ae%9a.md.html" id="03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html">03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/04%20%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%86%b3%e7%ad%96%e6%a0%91%e5%92%8c%e6%9f%a5%e6%89%be%e7%93%b6%e9%a2%88%e8%af%81%e6%8d%ae%e9%93%be%ef%bc%9f.md.html" id="04 如何构建性能分析决策树和查找瓶颈证据链？.md.html">04 如何构建性能分析决策树和查找瓶颈证据链？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/05%20%e6%80%a7%e8%83%bd%e6%96%b9%e6%a1%88%ef%bc%9a%e4%bd%a0%e7%9a%84%e6%96%b9%e6%a1%88%e6%98%af%e5%90%a6%e8%bf%98%e5%81%9c%e7%95%99%e5%9c%a8%e5%bd%a2%e5%bc%8f%e4%b8%8a%ef%bc%9f.md.html" id="05 性能方案：你的方案是否还停留在形式上？.md.html">05 性能方案：你的方案是否还停留在形式上？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/06%20%e5%a6%82%e4%bd%95%e6%8a%bd%e5%8f%96%e5%87%ba%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af%e7%9a%84%e4%b8%9a%e5%8a%a1%e6%a8%a1%e5%9e%8b%ef%bc%9f.md.html" id="06 如何抽取出符合真实业务场景的业务模型？.md.html">06 如何抽取出符合真实业务场景的业务模型？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/07%20%e6%80%a7%e8%83%bd%e5%9c%ba%e6%99%af%e7%9a%84%e6%95%b0%e6%8d%ae%e5%88%b0%e5%ba%95%e5%ba%94%e8%af%a5%e5%81%9a%e6%88%90%e4%bb%80%e4%b9%88%e6%a0%b7%e5%ad%90%ef%bc%9f.md.html" id="07 性能场景的数据到底应该做成什么样子？.md.html">07 性能场景的数据到底应该做成什么样子？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/08%20%e5%b9%b6%e5%8f%91%e3%80%81%e5%9c%a8%e7%ba%bf%e5%92%8cTPS%e5%88%b0%e5%ba%95%e6%98%af%e4%bb%80%e4%b9%88%e5%85%b3%e7%b3%bb%ef%bc%9f.md.html" id="08 并发、在线和TPS到底是什么关系？.md.html">08 并发、在线和TPS到底是什么关系？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/09%20%e5%a6%82%e4%bd%95%e8%ae%be%e8%ae%a1%e5%85%a8%e5%b1%80%e5%92%8c%e5%ae%9a%e5%90%91%e7%9b%91%e6%8e%a7%e7%ad%96%e7%95%a5%ef%bc%9f.md.html" id="09 如何设计全局和定向监控策略？.md.html">09 如何设计全局和定向监控策略？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/10%20%e8%ae%be%e8%ae%a1%e5%9f%ba%e5%87%86%e5%9c%ba%e6%99%af%e9%9c%80%e8%a6%81%e6%b3%a8%e6%84%8f%e5%93%aa%e4%ba%9b%e5%85%b3%e9%94%ae%e7%82%b9%ef%bc%9f.md.html" id="10 设计基准场景需要注意哪些关键点？.md.html">10 设计基准场景需要注意哪些关键点？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/11%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%b8%80%ef%bc%9a%e4%b8%80%e4%b8%aa%e6%a1%88%e4%be%8b%ef%bc%8c%e5%b8%a6%e4%bd%a0%e6%90%9e%e6%87%82%e5%9f%ba%e7%a1%80%e7%a1%ac%e4%bb%b6%e8%ae%be%e6%96%bd%e7%9a%84%e6%80%a7%e8%83%bd%e9%97%ae%e9%a2%98.md.html" id="11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html">11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/12%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%ba%8c%ef%bc%9a%e5%a6%82%e4%bd%95%e5%b9%b3%e8%a1%a1%e5%88%a9%e7%94%a8%e7%a1%ac%e4%bb%b6%e8%b5%84%e6%ba%90%ef%bc%9f.md.html" id="12 打开首页之二：如何平衡利用硬件资源？.md.html">12 打开首页之二：如何平衡利用硬件资源？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/13%20%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%ef%bc%9a%e6%80%8e%e4%b9%88%e5%88%a4%e6%96%ad%e7%ba%bf%e7%a8%8b%e4%b8%ad%e7%9a%84Block%e5%8e%9f%e5%9b%a0%ef%bc%9f.md.html" id="13 用户登录：怎么判断线程中的Block原因？.md.html">13 用户登录：怎么判断线程中的Block原因？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/14%20%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af%e6%9f%a5%e8%af%a2%ef%bc%9a%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e7%bd%91%e7%bb%9c%e8%bd%af%e4%b8%ad%e6%96%ad%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html">14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/15%20%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81%ef%bc%9a%e8%b5%84%e6%ba%90%e4%b8%8d%e8%b6%b3%e6%9c%89%e5%93%aa%e4%ba%9b%e6%80%a7%e8%83%bd%e8%a1%a8%e7%8e%b0%ef%bc%9f.md.html" id="15 查询商品：资源不足有哪些性能表现？.md.html">15 查询商品：资源不足有哪些性能表现？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/16%20%e5%95%86%e5%93%81%e5%8a%a0%e5%85%a5%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9aSQL%e4%bc%98%e5%8c%96%e5%92%8c%e5%8e%8b%e5%8a%9b%e5%b7%a5%e5%85%b7%e4%b8%ad%e7%9a%84%e5%8f%82%e6%95%b0%e5%88%86%e6%9e%90.md.html" id="16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html">16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/17%20%e6%9f%a5%e8%af%a2%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e9%93%ba%e5%ba%95%e5%8f%82%e6%95%b0%e4%b8%80%e5%ae%9a%e8%a6%81%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e7%89%b9%e6%80%a7%ef%bc%9f.md.html" id="17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html">17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/18%20%e8%b4%ad%e7%89%a9%e8%bd%a6%e4%bf%a1%e6%81%af%e7%a1%ae%e5%ae%9a%e8%ae%a2%e5%8d%95%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8a%a8%e6%80%81%e5%8f%82%e6%95%b0%e5%8c%96%e9%80%bb%e8%be%91%e9%9d%9e%e5%b8%b8%e9%87%8d%e8%a6%81%ef%bc%9f.md.html" id="18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html">18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/19%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e5%ba%94%e7%94%a8JDBC%e6%b1%a0%e4%bc%98%e5%8c%96%e5%92%8c%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%e5%88%86%e6%9e%90.md.html" id="19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html">19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/20%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e5%a4%8d%e6%9d%82%ef%bc%8c%e6%80%8e%e4%b9%88%e5%81%9a%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%ef%bc%9f.md.html" id="20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html">20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/21%20%e6%94%af%e4%bb%98%e5%89%8d%e6%9f%a5%e8%af%a2%e8%ae%a2%e5%8d%95%e5%88%97%e8%a1%a8%ef%bc%9a%e5%a6%82%e4%bd%95%e5%88%86%e6%9e%90%e4%bc%98%e5%8c%96%e4%b8%80%e4%b8%aa%e5%9b%ba%e5%ae%9a%e7%9a%84%e6%8a%80%e6%9c%af%e7%bb%84%e4%bb%b6%ef%bc%9f.md.html" id="21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html">21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/22%20%e6%94%af%e4%bb%98%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%ef%bc%9a%e5%a6%82%e4%bd%95%e9%ab%98%e6%95%88%e8%a7%a3%e5%86%b3for%e5%be%aa%e7%8e%af%e4%ba%a7%e7%94%9f%e7%9a%84%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%ef%bc%9f.md.html" id="22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html">22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/23%20%e5%86%b3%e5%ae%9a%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e6%88%90%e8%b4%a5%e7%9a%84%e5%85%b3%e9%94%ae%e5%9b%a0%e7%b4%a0%e6%9c%89%e5%93%aa%e4%ba%9b%ef%bc%9f.md.html" id="23 决定容量场景成败的关键因素有哪些？.md.html">23 决定容量场景成败的关键因素有哪些？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/24%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96%e5%92%8cKubernetes%e8%b5%84%e6%ba%90%e5%88%86%e9%85%8d%e4%b8%8d%e5%9d%87%e8%a1%a1%e6%80%8e%e4%b9%88%e5%8a%9e%ef%bc%9f.md.html" id="24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html">24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/25%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e7%bc%93%e5%ad%98%e5%af%b9%e6%80%a7%e8%83%bd%e4%bc%9a%e6%9c%89%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e5%bd%b1%e5%93%8d%ef%bc%9f.md.html" id="25 容量场景之二：缓存对性能会有什么样的影响？.md.html">25 容量场景之二：缓存对性能会有什么样的影响？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/26%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e4%b8%9a%e5%8a%a1%e7%a7%af%e7%b4%af%e9%87%8f%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html">26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/27%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e7%a3%81%e7%9b%98%e4%b8%8d%e8%b6%b3%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html">27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/28%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%e7%9a%84%e8%8c%83%e5%9b%b4%e5%92%8c%e8%ae%be%e8%ae%a1%e9%80%bb%e8%be%91%ef%bc%9f.md.html" id="28 如何确定异常场景的范围和设计逻辑？.md.html">28 如何确定异常场景的范围和设计逻辑？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/29%20%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%ef%bc%9a%e5%a6%82%e4%bd%95%e6%a8%a1%e6%8b%9f%e4%b8%8d%e5%90%8c%e7%bb%84%e4%bb%b6%e5%b1%82%e7%ba%a7%e7%9a%84%e5%bc%82%e5%b8%b8%ef%bc%9f.md.html" id="29 异常场景：如何模拟不同组件层级的异常？.md.html">29 异常场景：如何模拟不同组件层级的异常？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/30%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e7%94%9f%e4%ba%a7%e7%b3%bb%e7%bb%9f%e9%85%8d%e7%bd%ae%ef%bc%9f.md.html" id="30 如何确定生产系统配置？.md.html">30 如何确定生产系统配置？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/31%20%e6%80%8e%e4%b9%88%e5%86%99%e5%87%ba%e6%9c%89%e4%bb%b7%e5%80%bc%e7%9a%84%e6%80%a7%e8%83%bd%e6%8a%a5%e5%91%8a%ef%bc%9f.md.html" id="31 怎么写出有价值的性能报告？.md.html">31 怎么写出有价值的性能报告？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e6%88%91%e4%bb%ac%e8%bf%99%e4%b8%aa%e8%af%be%e7%a8%8b%e7%9a%84%e7%b3%bb%e7%bb%9f%e6%98%af%e6%80%8e%e4%b9%88%e6%90%ad%e5%bb%ba%e8%b5%b7%e6%9d%a5%e7%9a%84%ef%bc%9f.md.html" id="我们这个课程的系统是怎么搭建起来的？.md.html">我们这个课程的系统是怎么搭建起来的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e7%bb%93%e6%9d%9f%e8%af%ad%20%e5%81%9a%e7%9c%9f%e6%ad%a3%e7%9a%84%e6%80%a7%e8%83%bd%e9%a1%b9%e7%9b%ae.md.html" id="结束语 做真正的性能项目.md.html">结束语 做真正的性能项目.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？" id="title">26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？</h1>
<div><p>你好，我是高楼。</p>
<p>根据我们的RESAR性能理论，在执行完基准场景、容量场景之后，接下来就是稳定性场景了。</p>
<p>做过性能项目的工程师应该都有一个感觉：在跑稳定性场景之前，内心是战战兢兢的，因为不知道在运行长时间之后，系统会是什么样的表现。</p>
<p>并且，还有一个复杂的地方就是，在稳定性场景中，由于运行的时间长，出现问题后，我们分析起来会比较困难，主要有三点原因：</p>
<p>（1）分析一定要有完整且持续的计数器监控。因为在稳定性场景中，实时查看性能计数器是不现实的，我们不可能一直盯着。而且，问题出现的时间点也不确定。所以，在分析问题时，我们需要完整且持续的计数器监控。</p>
<p>（2）累积业务量产生的问题点在整个系统中也是不确定的。</p>
<p>（3）你知道，稳定性场景回归比较耗时，在分析优化的过程中，但凡调个参数、改行代码啥的，总是要回归场景的，而把稳定性场景拉起来就需要几个小时。所以，稳定性场景中的优化动作即便看似简单，也会消耗比较长的时间。</p>
<p>基于这几点原因，<strong>我们在稳定性运行之前，一定要想好监控哪些计数器</strong>，避免在稳定性运行过程中遇到问题时，发现没有可用的计数器分析问题，那就悲催了。这是极有可能出现的情况，你要格外注意。</p>
<p>根据<a href="https://time.geekbang.org/column/article/361138" target="_blank">第9讲</a>中提到的监控逻辑，在执行我们稳定性场景前，我们已经按“组件 - 模块 - 计数器”这样的逻辑罗列了所有需要监控的计数器，并且也用相应的工具去实现了。一切看起来已经万事具备。下面我们来看看在执行稳定性场景时，有哪些要点需要注意？</p>
<h2 id="稳定性场景的要点">稳定性场景的要点</h2>
<p>在稳定性场景中，有两点是需要你着重关注的：一个是运行时长，另一个是压力量级。</p>
<h3 id="1-运行时长">1. 运行时长</h3>
<p>我们在前面提到，容量场景是为了看系统所能承受的最大容量，而<strong>稳定性场景主要看的是系统提供长时间服务时的性能稳定性，观察系统在长时间运行过程中出现的累积效应</strong>。因此，运行时长就是稳定性场景中非常重要的一个指标了。</p>
<p>在每个业务系统中，稳定性运行时长都不是固定的，这取决于业务系统的具体应用场景。</p>
<p>对于大部分长年不能宕机的系统来说，它们靠的不是系统中的所有节点都能长年运行，而是<strong>架构设计可以在任一节点出现问题之后，将对应的业务承接到其他节点上</strong>。而这些架构设计就涉及到了DNS分区、扩展能力、高可用能力等技术。</p>
<p>可是，对于我们性能项目来说，即便是长年不宕机的系统，稳定性场景也不可能长年运行。因为如果这样做，就相当于长年运行着另一个生产系统，成本高、维护难，这显然是非常不现实的。</p>
<p>这时候，另一个岗位的重要性就体现出来了，那就是：运维。</p>
<p>在运维的职责里，就有“处理生产环境中出现的各种问题”这一项，我们俗称背锅侠。运维要做的就是保障系统在各种场景下都要正常运行。不过我想多啰嗦几句，要保证这一点，就不能只靠运维岗的工程师，它需要一个企业中所有技术岗的通力合作。换句话说，运维的职责实际上应该由一个企业的所有技术人员来承担。</p>
<p>话说回来，我们知道，运维会制定各种工作内容来保障系统的正常运行，其中，非常重要的一项就是，搭建完善的监控系统，因为你让一个运维眼睛都不眨眼地盯着系统是不现实的。而我们这个课程中提到的全局监控和定向监控，就可以完全覆盖到这种监控系统的要求。</p>
<p>为什么要提到运维呢？</p>
<p>因为<strong>稳定性场景的运行时长，不能覆盖长年运行的系统，这就需要运维人员来保障那线上的稳定性状态了</strong>。总体来看，运维有两大类工作内容：一类是日常巡检（用手工或自动化的方式，查看系统的健康状态）；另一类是运维动作（用手工或自动化的方式，完成归档、日志清理等动作）。</p>
<p>有些系统有固定的运维周期，周期按照天、周或者月来计算。而有些系统是没有固定的运维周期的，这就要靠监控系统提供的信息来判断什么时候做运维动作了。在自动化运维比较完善的情况下，有些运维动作就由自动化系统承接了；在自动化运维不完善的情况下，就只能靠人了。</p>
<p>不过，不管有没有自动化运维，每个系统都是有运维周期的，像下面这样：</p>
<p><img alt="" src="assets/9ebbd684c8ec4e868108c1d83cdd952a.jpg"/></p>
<p>下面我们具体来看看，对于上述两种系统，怎么计算稳定性场景的运行时长。</p>
<ul>
<li><strong>有固定运维周期的系统</strong></li>
</ul>
<p>对于有固定运维周期的系统，稳定性场景的运行时长就比较容易定义了。我们先根据生产系统的数据统计，看一下系统在固定的运维周期内，最大的业务容量是多少。</p>
<p>假设你根据生产系统统计出，在之前的运维周期中，有1亿的业务容量，而在容量场景中得到的最大TPS有1000。那么，我们就可以通过下面这个公式来计算：</p>
<p><span class="math display">\[ 稳定性运行时长 = 1亿(业务累积量) \\div 1000(TPS) \\div 3600(秒) \\approx 28(小时) \]</span></p><p>用这种方式得出的稳定性运行时长，对于有固定运维周期的系统来说已经足够了。</p>
<ul>
<li><strong>没有固定运维周期的系统</strong></li>
</ul>
<p>对于没有固定运维周期的系的系统，该怎么办呢？也许有人会说，运行时间只有尽可能长了。但是，“尽可能”也得有一个界限。根据我的经验，我们不能用“尽可能”来判断稳定性场景的运行时长。</p>
<p>根据上面的运算公式，TPS来自于容量场景，时间是最大的变量，所以业务累积累是不确定的。现在，我们要做的就是把业务累积量确定下来。</p>
<p>我们知道，<strong>业务积累量需要根据历史业务的统计数据来做决定</strong>。如果你的系统一个月有1000万的业务累积量，同时，稳定性运行的指标是稳定运行三个月（也就是说，即便没有固定的运维周期，我们也得给出一个时间长度）：-
<img alt="" src="assets/b990224ad9c242398eb5a173cd8e51b8.jpg"/></p>
<p>那么，总业务累积量就是3000万。</p>
<p>我们再根据上面的公式来计算就可以了：</p>
<p><span class="math display">\[ 稳定性运行时长 = 3000万(业务累积量) \\div 1000(TPS) \\div 3600(秒) \\approx 8(小时) \]</span></p><p>总之，<strong>不管是什么样的系统，要想运行稳定性场景，都得确定一个业务累积量</strong>。</p>
<h3 id="2-压力量级">2. 压力量级</h3>
<p>我们再来看压力量级，这是稳定性场景中必须要确定的另一个前提条件。</p>
<p>我们在网上经常能看到这样的说法：稳定性的压力应该用最大TPS的80%来运行。可是，我们来看一下<strong>稳定性场景的目标：保障系统的业务累积量</strong>。也就是说，我们只要保证这一目标就可以了，至于TPS是多少，并不重要。</p>
<p>因此，<strong>我们不用考虑80%的问题，直接用最大TPS来运行即可</strong>。一个系统如果能在最大TPS的状态下正常运行，才算是真正经受住了考验。</p>
<p>你可能会有这样的疑问：当一个系统在最大TPS状态下运行，如果有突增的压力需要更高的TPS怎么办？请你注意，稳定性场景不是为了解决突增的压力峰值而设计的。如果你要考虑突增的业务压力，我建议你增加容量场景来验证。</p>
<p>另外，如果我们要对付突增的业务容量，不止要在性能场景中考虑增加容量场景，还要在架构设计时，把相应的限流、熔断、降级等异常保障机制加进来。</p>
<p>到这里，我们就把两个重要的稳定性条件讲完了。</p>
<p>下面我们具体操作一下，以我们这个课程的电商系统为例，看看稳定性场景该怎么确定。</p>
<h2 id="场景运行数据">场景运行数据</h2>
<p>因为这是一个示例系统，所以我们先定一个小目标：稳定运行业务累积量为5000万。</p>
<p>对于这个系统，我们在容量场景中得到的最大TPS在1700，但是随着容量场景的不断增加，数据库中的数据量越来越大，TPS也会慢慢降低，因为我并没有做数据库的容量限制和归档等动作。那我们就用容量场景中的相应的压力线程来运行稳定性场景，让我们的理论能在落地时得到印证。根据前面的计算公式，运行时长为：</p>
<p><span class="math display">\[ 稳定性运行时长 = 5000万 \\div 1700(TPS) \\div 3600(秒) \\approx 8.16(小时) \]</span></p><p>也就是说我们要运行稳定性场景8个小时多一点。</p>
<p>下面我们来看一下具体的运行数据：</p>
<p><img alt="" src="assets/46c1457fa1bc40abbbd9188f17960bcc.jpg"/></p>
<p>从数据上来看，在稳定性场景运行4个多小时的时候，TPS就没了，响应时间又非常高，这明显是出现问题了。</p>
<p>这时候的业务积累量为：</p>
<p><img alt="" src="assets/f49739866aa343a4a5f93a9c0ba54404.jpg"/></p>
<p>总的业务累积量是2900多万，这和我们的预期并不相符。</p>
<p>下面我们分析一下到底是怎么回事。</p>
<h2 id="全局监控分析">全局监控分析</h2>
<p>按照我们一贯的性能分析逻辑，我们先来查看全局监控数据：</p>
<p><img alt="" src="assets/e7241273c49540368fb50a2bb9cd9a48.jpg"/></p>
<p>你看，在运行期间，好几个worker的CPU资源都在70%以上，这样的数据中规中矩，还不是我们关注的重点。因为对于稳定性场景来说，资源只要能撑得住就行了。</p>
<p>但是，在场景运行数据中，TPS直接就断掉了。在我查看每个主机的资源情况时，在worker-1上看到了这样的数据：</p>
<p><img alt="" src="assets/c9796971280946359c762bc83f178a57.jpg"/><img alt="" src="assets/a5bfc39e54314d1a8abdf93b86b8562d.jpg"/></p>
<p>这是数据断掉了呀！那我们就要定向分析这个主机了。</p>
<h2 id="定向监控分析">定向监控分析</h2>
<h3 id="定向分析第一阶段">定向分析第一阶段</h3>
<p>根据断掉的时间点，和我们前面使用的监控手段，一层层查（这个步骤就是把我们的项目级全局监控计数器看一遍，在<a href="https://time.geekbang.org/column/article/356789" target="_blank">第</a><a href="https://time.geekbang.org/column/article/356789" target="_blank">4</a><a href="https://time.geekbang.org/column/article/356789" target="_blank">讲</a>中已经有了明确的说明，我这里不再赘述了），结果看到了这样的日志信息：</p>
<pre><code>Feb 20 04:20:41 hp-server kernel: Out of memory: Kill process 7569 (qemu-kvm) score 256 or sacrifice child
Feb 20 04:20:41 hp-server kernel: Killed process 7569 (qemu-kvm), UID 107, total-vm:18283204kB, anon-rss:16804564kB, file-rss:232kB, shmem-rss:16kB
Feb 20 04:20:44 hp-server kernel: br0: port 4(vnet2) entered disabled state
Feb 20 04:20:44 hp-server kernel: device vnet2 left promiscuous mode
Feb 20 04:20:44 hp-server kernel: br0: port 4(vnet2) entered disabled state
Feb 20 04:20:44 hp-server libvirtd: 2021-02-19 20:20:44.706+0000: 1397: error : qemuMonitorIO:718 : 内部错误：End of file from qemu monitor
Feb 20 04:20:44 hp-server libvirtd: 2021-02-19 20:20:44.740+0000: 1397: error : qemuAgentIO:598 : 内部错误：End of file from agent monitor
Feb 20 04:20:45 hp-server systemd-machined: Machine qemu-3-vm-k8s-worker-1 terminated.
</code></pre>
<p>显然，因为宿主机内存不够，worker-1被直接杀掉了。既然是内存不足，我们肯定要确定一下这个宿主机是为什么内存不足了。</p>
<p>我检查了宿主机的overcommit参数。这个参数是确定操作系统是否允许超分内存的。对于Linux来说，内存分配出去，不一定会被用完。所以，对宿主机来说超分可以支持更多的虚拟机。</p>
<pre><code>[root@hp-server log]# cat /proc/sys/vm/overcommit_memory
1
</code></pre>
<p>我们看到，overcommit的配置是1，那就是允许超分。</p>
<p>我在这里简单说明一下，这个参数的几个选项：</p>
<ul>
<li>0，不允许超分。</li>
<li>1，不管当前的内存状态，都允许分配所有的物理内存。</li>
<li>2，允许分配的内存超过物理内存+交换空间。</li>
</ul>
<p>请你注意，允许超分，并不是说允许超用！而我们现在的情况是宿主已经OOM（内存溢出）了，这就说明内存真的已经不够用了。</p>
<p>这个逻辑其实挺有意思；Linux虽然允许超分内存，但是当内存真正不够用的时候，即便是收到了超分请求，也得为了保证自己的正常运行而做OOM的判断。也就是说分给你，你不见得能用得起来！这种耍流氓的手段，像不像领导画大饼？</p>
<p>没办法，我们还是要理智地来分析，看看怎么解决。</p>
<p>因为虚拟机是worker-1被杀掉的，我们来看一下worker-1的内存：</p>
<p><img alt="" src="assets/84476f4432e841e48634a0e7671d46e8.jpg"/></p>
<p>从worker-1的资源上来看，如果worker-1是因为内存用得多被杀掉，那应该在12点20分到12点30分之间就被杀掉了，因为上面的内存曲线在12点半左右之后就没有大的波动了。</p>
<p>可是，为什么要等到凌晨4点20分呢？这说明worker-1被杀掉，并不是因为worker-1上的内存使用突然增加。而是宿主机上的内存使用变多，进而内存不足，然后在计算了OOM评分之后杀掉了worker-1。那我们就到宿主机上，看看还有哪些虚拟机在运行：</p>
<pre><code>[root@hp-server log]# virsh list --all
 Id    名称                         状态
----------------------------------------------------
 1     vm-k8s-master-1                running
 2     vm-k8s-master-3                running
 4     vm-k8s-worker-2                running
 5     vm-k8s-worker-3                running
 6     vm-k8s-worker-4                running
 7     vm-k8s-worker-1                running
</code></pre>
<p>宿主机上总共运行了6个虚拟机，它们在12点半之后的时间里，对应的内存依次如下：</p>
<p>vm-k8s-worker-2：</p>
<p><img alt="" src="assets/c40109f8636e480dbbd1eb942fa2ba45.jpg"/></p>
<p>vm-k8s-worker-3：</p>
<p><img alt="" src="assets/c18a9d19cf4042be987d5f2d74462a09.jpg"/></p>
<p>vm-k8s-worker-4：</p>
<p><img alt="" src="assets/aee4e39006984c49a5e703a646c1ad23.jpg"/></p>
<p>vm-k8s-master-1：</p>
<p><img alt="" src="assets/967b57000ca24dfe972fa77eaa6e4bf0.jpg"/></p>
<p>vm-k8s-master-3：</p>
<p><img alt="" src="assets/101eaa41fe27439e947756a1eef39dbb.jpg"/></p>
<p>看到了没有？4点多的时候，在worker-2上有一个内存较大的请求。</p>
<p>针对这种情况，如果我们要细细地分析下去，接下来应该分析这个内存请求是从哪来的。但是，在稳定性场景中，要做这样的分析是比较麻烦的。因为这个场景的运行时间长，并且业务众多，不容易拆分时间。因此，我建议你到基准场景中去做分析。</p>
<p>现在，我们不能断言这个内存请求不合理，我们要做的是让这个系统稳定运行下去。所以，我们先来解决问题。</p>
<p>你可能会有疑问：既然是worker-2请求了内存，为啥要把worker-1杀掉呢？这就需要了解Linux的OOM killer机制了。</p>
<p>在OOM killer机制中，不是说谁用的内存大就会杀谁（当然，如果谁用的内存大，被杀的可能性也会比较大），而是会经过计算评分，哪个进程评分高就杀哪个。</p>
<p>在每个进程中，都会有三个参数：oom_adj、oom_score、oom_score_adj，系统的评分结果就记录在oom_score中。其他两个是调节参数：oom_adj是一个旧的调节参数，为了系统的兼容性，被保留了下来；oom_score_adj是一个新的调节参数，Linux会根据进程的运行参数来判断调节参数为多少。</p>
<p>这里提到的运行参数主要是这几个：</p>
<ul>
<li>运行时长（存活时间越长的进程，越不容易被杀掉）</li>
<li>CPU时间消耗（CPU消耗越大的进程，越容易被干掉）</li>
<li>内存消耗（内存消耗越大的进程，越容易被干掉）</li>
</ul>
<p>这些参数组合在一起，决定了哪个进程要被干掉。</p>
<p>而在我们这个场景中是worker-1被干掉了，这就说明worker-1的评分是高的。</p>
<p>因为前面有worker-1上的内存消耗也比较大，所以，我们在worker-1、worker-2这两台机器上查一下有多少Pod：</p>
<pre><code>[root@k8s-master-1 ~]# kubectl get pods -o wide --all-namespaces| grep worker-2
default                cloud-nacos-registry-76845b5cfb-bnj76        1/1     Running            0          9h     10.100.140.8     k8s-worker-2   &lt;none&gt;           &lt;none&gt;
default                sample-webapp-755fq                          0/1     ImagePullBackOff   0          19h    10.100.140.7     k8s-worker-2   &lt;none&gt;           &lt;none&gt;
default                skywalking-es-init-4w44r                     0/1     Completed          0          15h    10.100.140.11    k8s-worker-2   &lt;none&gt;           &lt;none&gt;
default                skywalking-ui-7d7754576b-nj7sf               1/1     Running            0          9h     10.100.140.14    k8s-worker-2   &lt;none&gt;           &lt;none&gt;
default                svc-mall-auth-6ccf9fd7c9-qh7j8               1/1     Running            0          151m   10.100.140.21    k8s-worker-2   &lt;none&gt;           &lt;none&gt;
default                svc-mall-auth-6ccf9fd7c9-sblzx               1/1     Running            0          151m   10.100.140.23    k8s-worker-2   &lt;none&gt;           &lt;none&gt;
default                svc-mall-member-df566595c-9zq9k              1/1     Running            0          151m   10.100.140.19    k8s-worker-2   &lt;none&gt;           &lt;none&gt;
default                svc-mall-member-df566595c-dmj67              1/1     Running            0          151m   10.100.140.22    k8s-worker-2   &lt;none&gt;           &lt;none&gt;
kube-system            calico-node-pwsqt                            1/1     Running            8          37d    172.16.106.149   k8s-worker-2   &lt;none&gt;           &lt;none&gt;
kube-system            kube-proxy-l8xf9                             1/1     Running            15         85d    172.16.106.149   k8s-worker-2   &lt;none&gt;           &lt;none&gt;
monitoring             node-exporter-wcsj7                          2/2     Running            18         42d    172.16.106.149   k8s-worker-2   &lt;none&gt;           &lt;none&gt;
nginx-ingress          nginx-ingress-7jjv2                          1/1     Running            0          18h    10.100.140.62    k8s-worker-2   &lt;none&gt;           &lt;none&gt;
[root@k8s-master-1 ~]# kubectl get pods -o wide --all-namespaces| grep worker-1
default                mysql-min-c4f8d4599-fxwf4                    1/1     Running            0          9h     10.100.230.9     k8s-worker-1   &lt;none&gt;           &lt;none&gt;
kube-system            calico-node-tmpfl                            1/1     Running            8          37d    172.16.106.130   k8s-worker-1   &lt;none&gt;           &lt;none&gt;
kube-system            kube-proxy-fr22f                             1/1     Running            13         85d    172.16.106.130   k8s-worker-1   &lt;none&gt;           &lt;none&gt;
monitoring             alertmanager-main-0                          2/2     Running            0          162m   10.100.230.12    k8s-worker-1   &lt;none&gt;           &lt;none&gt;
monitoring             node-exporter-222c5                          2/2     Running            10         7d     172.16.106.130   k8s-worker-1   &lt;none&gt;           &lt;none&gt;
nginx-ingress          nginx-ingress-pjrkw                          1/1     Running            1          18h    10.100.230.10    k8s-worker-1   &lt;none&gt;           &lt;none&gt;
[root@k8s-master-1 ~]# 
</code></pre>
<p>我们进一步查看那些应用经常使用的Pod，看看它们的内存情况如何：</p>
<pre><code>PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                  
 7609 27        20   0   12.4g   7.0g  12896 S 118.9 45.0 167:38.02 /opt/rh/rh-mysql57/root/usr/libexec/mysqld --defaults-file=/etc/my.cnf  
</code></pre>
<p>通过查看worker-1上的进程，我们发现主要是MySQL使用的内存最多，这是吃内存的大户。如果宿主机内存不够，把worker-1杀掉确实是有可能的。</p>
<p>下面，我们增加几个临时的监控，把一些重要服务的内存记录一下，比如Gateway、Member、MySQL、Redis等。然后再恢复所有的应用，把场景跑起来，看看是什么样的结果：</p>
<p><img alt="" src="assets/0da0939a7e234a0a8cd6030ab345d4c8.jpg"/></p>
<p>运行时长已经快有七个小时了。你可能会奇怪，为什么上一个场景只运行了4个多小时，而现在却能运行7个小时了呢？这是因为worker-1被杀了之后，虚拟机重启了，状态都重置了。</p>
<p>而在上次的场景运行之前，我们并没有重启过虚拟机，也就是说前面已经有了一段时间的内存消耗。对于稳定性场景来说，增删改查都是有的，数据量也在不断增加，所以内存会使用得越来越多。</p>
<p>这一次运行的累积业务量是3200多万：</p>
<p><img alt="" src="assets/51e7b6ea05024a78b3e1755d6bfdff47.jpg"/></p>
<p>但是，问题还是出现了：通过查看宿主机的日志，我看到worker-2又被杀掉了：</p>
<pre><code>Feb 20 19:42:44 hp-server kernel: Out of memory: Kill process 7603 (qemu-kvm) score 257 or sacrifice child
Feb 20 19:42:44 hp-server kernel: Killed process 7603 (qemu-kvm), UID 107, total-vm:17798976kB, anon-rss:16870472kB, file-rss:0kB, shmem-rss:16kB
Feb 20 19:42:46 hp-server kernel: br0: port 5(vnet3) entered disabled state
Feb 20 19:42:46 hp-server kernel: device vnet3 left promiscuous mode
Feb 20 19:42:46 hp-server kernel: br0: port 5(vnet3) entered disabled state
Feb 20 19:42:46 hp-server systemd-machined: Machine qemu-4-vm-k8s-worker-2 terminated.
Feb 20 19:42:46 hp-server avahi-daemon[953]: Withdrawing address record for fe80::fc54:ff:fe5e:dded on vnet3.
Feb 20 19:42:46 hp-server avahi-daemon[953]: Withdrawing workstation service for vnet3.
[root@hp-server log]# 
</code></pre>
<p>也就是说，在内存不够的情况下，杀掉哪个worker并不是固定的。至少这可以说明，宿主机真的是因为自己的内存不够用而杀掉虚拟机的。这可能就和具体的组件无关了，因为组件的内存消耗是根据运行需求来的，是合理的。</p>
<p>为什么做这样的判断呢？因为如果是某个固定的worker被杀掉，那我们可以去监控这个worker上运行的技术组件，看看是哪个组件的内存增加得快，然后进一步判断这个技术组件的内存不断增加的原因。</p>
<p>可是现在被杀掉的worker并不是固定的。根据OOM的逻辑，宿主机操作系统在内存不够用的时候才会调用OOM killer。我们前面也提到，overcommit的参数设置是1，也就是说宿主机操作系统允许内存在请求时超分。</p>
<p>但是，在宿主机真正使用内存的时候，内存不够用了，进而导致虚拟机被杀掉。这意味着，在宿主机创建KVM虚拟机时，产生了超分但并没有提供足够的可用内存，而在压力持续的过程中，虚拟机又确实需要这些内存。所以，虚拟机不断向宿主机申请内存，可宿主机没有足够的内存，因而触发了OOM killer机制。</p>
<p>这样看来，我们就得算一下内存到底超分了多少，看看是不是因为我们配置的超分过大，导致了这个问题。我们把虚拟机的内存列出来看看：</p>
<p><img alt="" src="assets/bb13f78e31734e089dae8cfcde0ec6cb.jpg"/></p>
<p>我们计算一下总分配内存：</p>
<p><span class="math display">\[ 总分配内存 = 8 \\times 2 + 16 \\times 4 = 80G \]</span></p><p>而宿主机的物理内存只有：</p>
<pre><code>[root@hp-server log]# cat /proc/meminfo|grep Total
MemTotal:       65675952 kB
SwapTotal:             0 kB
VmallocTotal:   34359738367 kB
CmaTotal:              0 kB
HugePages_Total:       0
[root@hp-server log]# 
</code></pre>
<p>也就是说宿主机的最大物理内存也只有65G左右。这也难怪，物理内存在真实使用时会不够用。</p>
<p>现在我们把虚拟机的内存降下来，让它不会产生超分，配置如下：</p>
<p><img alt="" src="assets/67e1d2bb4edd45e1a7847be99d60276d.jpg"/></p>
<p>总分配内存计算下来就是：</p>
<p><span class="math display">\[ 总分配内存 = 4 \\times 2 + 13 \\times 4 = 60G \]</span></p><p>这样就足够用了。</p>
<p>不过，根据性能分析中，时间和空间相互转换的原则，这样可能会导致TPS降低。因为在虚拟机的操作系统内存减少时，会更早地出现page faults，也就是页错误（换页时会产生）。不过，如果只是换页，而不是出现OOM，至少不会导致虚拟机被杀掉。</p>
<p>我们再把场景跑起来，看看结果：</p>
<p><img alt="" src="assets/00bd16b4afca4e0cb0cdcc7e0056693d.jpg"/></p>
<p>这个结果看起来不错，虽说TPS有掉下来的时候，但是总体上是稳定的。运行时间也超过了12小时。</p>
<p>我们再来看累积业务量：</p>
<p><img alt="" src="assets/c983c6a855af41779b67e663d94bb856.jpg"/></p>
<p>这次的累积业务量超过了7200万，超过了我们定的5000万的小目标。现在是不是可以欢呼一下了？</p>
<p>别高兴太早，在下节课中，你会感受到性能项目中的大起大落。</p>
<h2 id="总结">总结</h2>
<p>今天我们讲了稳定性场景的两个要点，分别是运行时长和压力量级。要想把稳定性场景做得有意义，这两点是必备前提条件。</p>
<p>同时，你要记住一点，稳定性场景是为了找出业务积累的过程中出现的问题。所以，<strong>如果业务积累量不能达到线上的要求，就不能说明稳定性场景做得有意义。</strong></p>
<p>此外，在这节课中，我们也分析了物理内存增加的问题。在内存的使用上，特别是在这种Kubernetes+Docker的架构中，资源分配是非常关键的。不要觉得Kubernetes给我们做了很多自动的分配工作，我们就可以喝咖啡了。你会发现，仍然有不少新坑在等着我们。</p>
<h2 id="课后作业">课后作业</h2>
<p>这就是今天的全部内容，最后给你留两个思考题吧：</p>
<ol>
<li>在你的项目中，怎么将这节课的稳定性理念落地？</li>
<li>在查找稳定性的问题时，如何设计监控策略，才能保证我们可以收集到足够的分析数据？在你的项目中是如何做的？</li>
</ol>
<p>记得在留言区和我讨论、交流你的想法，每一次思考都会让你更进一步。</p>
<p>如果这节课让你有所收获，也欢迎你分享给你的朋友，共同学习进步。我们下一讲再见！</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#6e020202575a5f5f5e592e09030f0702400d0103" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93598c1209a10949',t:'MTc0NTUzOTA5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>