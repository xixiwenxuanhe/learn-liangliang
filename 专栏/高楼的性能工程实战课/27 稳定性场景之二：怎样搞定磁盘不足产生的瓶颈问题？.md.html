<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？ </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%e6%89%93%e7%a0%b4%e5%9b%9b%e5%a4%a7%e8%ae%a4%e7%9f%a5%e5%b1%80%e9%99%90%ef%bc%8c%e8%bf%9b%e9%98%b6%e9%ab%98%e7%ba%a7%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%b8%88.md.html" id="00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html">00 开篇词 打破四大认知局限，进阶高级性能工程师.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/01%20%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%be%88%e5%a4%9a%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95%e4%ba%ba%e5%91%98%e6%97%a0%e6%b3%95%e5%af%b9%e6%80%a7%e8%83%bd%e7%bb%93%e6%9e%9c%e8%b4%9f%e8%b4%a3%ef%bc%9f.md.html" id="01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html">01 性能工程：为什么很多性能测试人员无法对性能结果负责？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/02%20%e5%85%b3%e9%94%ae%e6%a6%82%e5%bf%b5%ef%bc%9a%e6%80%a7%e8%83%bd%e6%8c%87%e6%a0%87%e5%92%8c%e5%9c%ba%e6%99%af%e7%9a%84%e7%a1%ae%e5%ae%9a.md.html" id="02 关键概念：性能指标和场景的确定.md.html">02 关键概念：性能指标和场景的确定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/03%20%e6%a0%b8%e5%bf%83%e5%88%86%e6%9e%90%e9%80%bb%e8%be%91%ef%bc%9a%e6%89%80%e6%9c%89%e7%9a%84%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%ef%bc%8c%e9%9d%a0%e8%bf%99%e4%b8%83%e6%ad%a5%e9%83%bd%e8%83%bd%e6%90%9e%e5%ae%9a.md.html" id="03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html">03 核心分析逻辑：所有的性能分析，靠这七步都能搞定.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/04%20%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%86%b3%e7%ad%96%e6%a0%91%e5%92%8c%e6%9f%a5%e6%89%be%e7%93%b6%e9%a2%88%e8%af%81%e6%8d%ae%e9%93%be%ef%bc%9f.md.html" id="04 如何构建性能分析决策树和查找瓶颈证据链？.md.html">04 如何构建性能分析决策树和查找瓶颈证据链？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/05%20%e6%80%a7%e8%83%bd%e6%96%b9%e6%a1%88%ef%bc%9a%e4%bd%a0%e7%9a%84%e6%96%b9%e6%a1%88%e6%98%af%e5%90%a6%e8%bf%98%e5%81%9c%e7%95%99%e5%9c%a8%e5%bd%a2%e5%bc%8f%e4%b8%8a%ef%bc%9f.md.html" id="05 性能方案：你的方案是否还停留在形式上？.md.html">05 性能方案：你的方案是否还停留在形式上？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/06%20%e5%a6%82%e4%bd%95%e6%8a%bd%e5%8f%96%e5%87%ba%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af%e7%9a%84%e4%b8%9a%e5%8a%a1%e6%a8%a1%e5%9e%8b%ef%bc%9f.md.html" id="06 如何抽取出符合真实业务场景的业务模型？.md.html">06 如何抽取出符合真实业务场景的业务模型？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/07%20%e6%80%a7%e8%83%bd%e5%9c%ba%e6%99%af%e7%9a%84%e6%95%b0%e6%8d%ae%e5%88%b0%e5%ba%95%e5%ba%94%e8%af%a5%e5%81%9a%e6%88%90%e4%bb%80%e4%b9%88%e6%a0%b7%e5%ad%90%ef%bc%9f.md.html" id="07 性能场景的数据到底应该做成什么样子？.md.html">07 性能场景的数据到底应该做成什么样子？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/08%20%e5%b9%b6%e5%8f%91%e3%80%81%e5%9c%a8%e7%ba%bf%e5%92%8cTPS%e5%88%b0%e5%ba%95%e6%98%af%e4%bb%80%e4%b9%88%e5%85%b3%e7%b3%bb%ef%bc%9f.md.html" id="08 并发、在线和TPS到底是什么关系？.md.html">08 并发、在线和TPS到底是什么关系？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/09%20%e5%a6%82%e4%bd%95%e8%ae%be%e8%ae%a1%e5%85%a8%e5%b1%80%e5%92%8c%e5%ae%9a%e5%90%91%e7%9b%91%e6%8e%a7%e7%ad%96%e7%95%a5%ef%bc%9f.md.html" id="09 如何设计全局和定向监控策略？.md.html">09 如何设计全局和定向监控策略？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/10%20%e8%ae%be%e8%ae%a1%e5%9f%ba%e5%87%86%e5%9c%ba%e6%99%af%e9%9c%80%e8%a6%81%e6%b3%a8%e6%84%8f%e5%93%aa%e4%ba%9b%e5%85%b3%e9%94%ae%e7%82%b9%ef%bc%9f.md.html" id="10 设计基准场景需要注意哪些关键点？.md.html">10 设计基准场景需要注意哪些关键点？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/11%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%b8%80%ef%bc%9a%e4%b8%80%e4%b8%aa%e6%a1%88%e4%be%8b%ef%bc%8c%e5%b8%a6%e4%bd%a0%e6%90%9e%e6%87%82%e5%9f%ba%e7%a1%80%e7%a1%ac%e4%bb%b6%e8%ae%be%e6%96%bd%e7%9a%84%e6%80%a7%e8%83%bd%e9%97%ae%e9%a2%98.md.html" id="11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html">11 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/12%20%e6%89%93%e5%bc%80%e9%a6%96%e9%a1%b5%e4%b9%8b%e4%ba%8c%ef%bc%9a%e5%a6%82%e4%bd%95%e5%b9%b3%e8%a1%a1%e5%88%a9%e7%94%a8%e7%a1%ac%e4%bb%b6%e8%b5%84%e6%ba%90%ef%bc%9f.md.html" id="12 打开首页之二：如何平衡利用硬件资源？.md.html">12 打开首页之二：如何平衡利用硬件资源？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/13%20%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%ef%bc%9a%e6%80%8e%e4%b9%88%e5%88%a4%e6%96%ad%e7%ba%bf%e7%a8%8b%e4%b8%ad%e7%9a%84Block%e5%8e%9f%e5%9b%a0%ef%bc%9f.md.html" id="13 用户登录：怎么判断线程中的Block原因？.md.html">13 用户登录：怎么判断线程中的Block原因？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/14%20%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af%e6%9f%a5%e8%af%a2%ef%bc%9a%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e7%bd%91%e7%bb%9c%e8%bd%af%e4%b8%ad%e6%96%ad%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html">14 用户信息查询：如何解决网络软中断瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/15%20%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81%ef%bc%9a%e8%b5%84%e6%ba%90%e4%b8%8d%e8%b6%b3%e6%9c%89%e5%93%aa%e4%ba%9b%e6%80%a7%e8%83%bd%e8%a1%a8%e7%8e%b0%ef%bc%9f.md.html" id="15 查询商品：资源不足有哪些性能表现？.md.html">15 查询商品：资源不足有哪些性能表现？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/16%20%e5%95%86%e5%93%81%e5%8a%a0%e5%85%a5%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9aSQL%e4%bc%98%e5%8c%96%e5%92%8c%e5%8e%8b%e5%8a%9b%e5%b7%a5%e5%85%b7%e4%b8%ad%e7%9a%84%e5%8f%82%e6%95%b0%e5%88%86%e6%9e%90.md.html" id="16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html">16 商品加入购物车：SQL优化和压力工具中的参数分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/17%20%e6%9f%a5%e8%af%a2%e8%b4%ad%e7%89%a9%e8%bd%a6%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e9%93%ba%e5%ba%95%e5%8f%82%e6%95%b0%e4%b8%80%e5%ae%9a%e8%a6%81%e7%ac%a6%e5%90%88%e7%9c%9f%e5%ae%9e%e4%b8%9a%e5%8a%a1%e7%89%b9%e6%80%a7%ef%bc%9f.md.html" id="17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html">17 查询购物车：为什么铺底参数一定要符合真实业务特性？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/18%20%e8%b4%ad%e7%89%a9%e8%bd%a6%e4%bf%a1%e6%81%af%e7%a1%ae%e5%ae%9a%e8%ae%a2%e5%8d%95%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8a%a8%e6%80%81%e5%8f%82%e6%95%b0%e5%8c%96%e9%80%bb%e8%be%91%e9%9d%9e%e5%b8%b8%e9%87%8d%e8%a6%81%ef%bc%9f.md.html" id="18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html">18 购物车信息确定订单：为什么动态参数化逻辑非常重要？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/19%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e5%ba%94%e7%94%a8JDBC%e6%b1%a0%e4%bc%98%e5%8c%96%e5%92%8c%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%e5%88%86%e6%9e%90.md.html" id="19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html">19 生成订单信息之一：应用JDBC池优化和内存溢出分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/20%20%e7%94%9f%e6%88%90%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91%e5%a4%8d%e6%9d%82%ef%bc%8c%e6%80%8e%e4%b9%88%e5%81%9a%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%ef%bc%9f.md.html" id="20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html">20 生成订单信息之二：业务逻辑复杂，怎么做性能优化？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/21%20%e6%94%af%e4%bb%98%e5%89%8d%e6%9f%a5%e8%af%a2%e8%ae%a2%e5%8d%95%e5%88%97%e8%a1%a8%ef%bc%9a%e5%a6%82%e4%bd%95%e5%88%86%e6%9e%90%e4%bc%98%e5%8c%96%e4%b8%80%e4%b8%aa%e5%9b%ba%e5%ae%9a%e7%9a%84%e6%8a%80%e6%9c%af%e7%bb%84%e4%bb%b6%ef%bc%9f.md.html" id="21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html">21 支付前查询订单列表：如何分析优化一个固定的技术组件？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/22%20%e6%94%af%e4%bb%98%e8%ae%a2%e5%8d%95%e4%bf%a1%e6%81%af%ef%bc%9a%e5%a6%82%e4%bd%95%e9%ab%98%e6%95%88%e8%a7%a3%e5%86%b3for%e5%be%aa%e7%8e%af%e4%ba%a7%e7%94%9f%e7%9a%84%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%ef%bc%9f.md.html" id="22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html">22 支付订单信息：如何高效解决for循环产生的内存溢出？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/23%20%e5%86%b3%e5%ae%9a%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e6%88%90%e8%b4%a5%e7%9a%84%e5%85%b3%e9%94%ae%e5%9b%a0%e7%b4%a0%e6%9c%89%e5%93%aa%e4%ba%9b%ef%bc%9f.md.html" id="23 决定容量场景成败的关键因素有哪些？.md.html">23 决定容量场景成败的关键因素有哪些？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/24%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96%e5%92%8cKubernetes%e8%b5%84%e6%ba%90%e5%88%86%e9%85%8d%e4%b8%8d%e5%9d%87%e8%a1%a1%e6%80%8e%e4%b9%88%e5%8a%9e%ef%bc%9f.md.html" id="24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html">24 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/25%20%e5%ae%b9%e9%87%8f%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e7%bc%93%e5%ad%98%e5%af%b9%e6%80%a7%e8%83%bd%e4%bc%9a%e6%9c%89%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e5%bd%b1%e5%93%8d%ef%bc%9f.md.html" id="25 容量场景之二：缓存对性能会有什么样的影响？.md.html">25 容量场景之二：缓存对性能会有什么样的影响？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/26%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%b8%80%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e4%b8%9a%e5%8a%a1%e7%a7%af%e7%b4%af%e9%87%8f%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html">26 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/27%20%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%9c%ba%e6%99%af%e4%b9%8b%e4%ba%8c%ef%bc%9a%e6%80%8e%e6%a0%b7%e6%90%9e%e5%ae%9a%e7%a3%81%e7%9b%98%e4%b8%8d%e8%b6%b3%e4%ba%a7%e7%94%9f%e7%9a%84%e7%93%b6%e9%a2%88%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html">27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/28%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%e7%9a%84%e8%8c%83%e5%9b%b4%e5%92%8c%e8%ae%be%e8%ae%a1%e9%80%bb%e8%be%91%ef%bc%9f.md.html" id="28 如何确定异常场景的范围和设计逻辑？.md.html">28 如何确定异常场景的范围和设计逻辑？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/29%20%e5%bc%82%e5%b8%b8%e5%9c%ba%e6%99%af%ef%bc%9a%e5%a6%82%e4%bd%95%e6%a8%a1%e6%8b%9f%e4%b8%8d%e5%90%8c%e7%bb%84%e4%bb%b6%e5%b1%82%e7%ba%a7%e7%9a%84%e5%bc%82%e5%b8%b8%ef%bc%9f.md.html" id="29 异常场景：如何模拟不同组件层级的异常？.md.html">29 异常场景：如何模拟不同组件层级的异常？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/30%20%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e7%94%9f%e4%ba%a7%e7%b3%bb%e7%bb%9f%e9%85%8d%e7%bd%ae%ef%bc%9f.md.html" id="30 如何确定生产系统配置？.md.html">30 如何确定生产系统配置？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/31%20%e6%80%8e%e4%b9%88%e5%86%99%e5%87%ba%e6%9c%89%e4%bb%b7%e5%80%bc%e7%9a%84%e6%80%a7%e8%83%bd%e6%8a%a5%e5%91%8a%ef%bc%9f.md.html" id="31 怎么写出有价值的性能报告？.md.html">31 怎么写出有价值的性能报告？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e6%88%91%e4%bb%ac%e8%bf%99%e4%b8%aa%e8%af%be%e7%a8%8b%e7%9a%84%e7%b3%bb%e7%bb%9f%e6%98%af%e6%80%8e%e4%b9%88%e6%90%ad%e5%bb%ba%e8%b5%b7%e6%9d%a5%e7%9a%84%ef%bc%9f.md.html" id="我们这个课程的系统是怎么搭建起来的？.md.html">我们这个课程的系统是怎么搭建起来的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e9%ab%98%e6%a5%bc%e7%9a%84%e6%80%a7%e8%83%bd%e5%b7%a5%e7%a8%8b%e5%ae%9e%e6%88%98%e8%af%be/%e7%bb%93%e6%9d%9f%e8%af%ad%20%e5%81%9a%e7%9c%9f%e6%ad%a3%e7%9a%84%e6%80%a7%e8%83%bd%e9%a1%b9%e7%9b%ae.md.html" id="结束语 做真正的性能项目.md.html">结束语 做真正的性能项目.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？" id="title">27 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？</h1>
<div><p>你好，我是高楼。</p>
<p>上节课，我们讲解了稳定性场景的两个要点：运行时长和压力量级，并通过课程的示例系统，带你具体操作了稳定性场景。</p>
<p>在定向分析的第一个阶段中，我们分析了虚拟机内存超分导致的操作系统OOM的问题，发现是配置的超分过大导致的。在我们降低了虚拟机的内存之后，稳定性场景的运行时间超过了12个小时，累积业务量达到7200多万，这样的结果已经达到了我们的目标。</p>
<p>可是，由于贪心，我并没有停止场景，就在它继续运行的时候，又出现了新问题……因此，我们今天就进入到定向分析的第二阶段，看看还有什么问题在等着我们。</p>
<h2 id="定向监控分析">定向监控分析</h2>
<h3 id="定向分析第二阶段">定向分析第二阶段</h3>
<p>当场景继续运行的时候，我看到了这样的数据：</p>
<p><img alt="" src="assets/b5fdab4b3c1041f0ae319704ee2e3b44.jpg"/></p>
<p>从图中我们可以很明显地看到，在场景持续运行的过程中，TPS掉下来了，响应时间则是蹭蹭往上涨。</p>
<p>我们看一下这时候的总业务累积量：</p>
<p><img alt="" src="assets/1357e350f2764a169d80f1148085cf50.jpg"/></p>
<p>也就是说，多了20多万的业务累积量。</p>
<p>见到问题，不分析总是觉得不那么舒服，那我们就来分析一下。</p>
<p>还是按照性能分析决策树，我们把计数器一个一个查过去。在我查看MySQL的Pod日志时，发现它一直在被删掉重建：</p>
<p><img alt="" src="assets/f8b4b8204f284cecb91bd1d07b9b0a0e.jpg"/></p>
<p>请注意，我们这是一个示例系统，为了方便重建，我把MySQL放到Pod中了。如果是在真实的环境中，我建议你最好根据生产的实际配置来做数据库的配置。</p>
<p>讲到这里，我稍微回应一下行业里的一种声音：数据库不应该放到Kubernetes的Pod中去。我不清楚持这样观点的人，只是在感觉上认为不安全，还是真正遇到了问题。在我的经验中，很多系统对数据库的性能要求其实并不高，业务量也不大。而用容器来管理便于迁移和重建，并且性能上也完全跟得上。所以，在这种场景下用Pod也没有关系。</p>
<p>当然，也有一些系统用数据库比较狠，为了保障更高的性能，会在物理机上直接部署。如果你面对的系统，确实需要用到物理机来创建数据库，那就选择物理机。如果Pod可以满足需求，我觉得不用纠结，直接用Pod就可以了。</p>
<p>因为MySQL的Pod被删掉重建，而MySQL又位于worker-1中，那我们就来看一下worker-1的操作系统日志：</p>
<pre><code>Feb 22 00:43:16 k8s-worker-1 kubelet: I0222 00:43:16.085214    1082 image_gc_manager.go:304] [imageGCManager]: Disk usage on image filesystem is at 95% which is over the high threshold (85%). Trying to free 7213867827 bytes down to the low threshold (80%).
</code></pre>
<p>原来是分配给worker-1的磁盘被用光了，难怪MySQL的Pod一直在被删掉重建。</p>
<p>我们检查一下磁盘的配额：</p>
<pre><code>[root@k8s-worker-1 ~]# df -h
文件系统                 容量  已用  可用 已用% 挂载点
devtmpfs                 6.3G     0  6.3G    0% /dev
tmpfs                    6.3G   24M  6.3G    1% /dev/shm
tmpfs                    6.3G   67M  6.3G    2% /run
tmpfs                    6.3G     0  6.3G    0% /sys/fs/cgroup
/dev/mapper/centos-root   47G   45G  2.7G   95% /
/dev/vda1               1014M  304M  711M   30% /boot
tmpfs                    1.3G  4.0K  1.3G    1% /run/user/42
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/9962f8d2-f6bb-4981-a073-dd16bfa9a171/volumes/kubernetes.io~secret/kube-proxy-token-vnxh9
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/f5872331-14b1-402b-99e0-063834d834fa/volumes/kubernetes.io~secret/calico-node-token-hvs7q
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/e61e5b2232592ef9883861d8536f37153617d46735026b49b285c016a47179cf/merged
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/4c057d86c1eabb84eddda86f991ca3852042da0647fd5b8c349568e2a0565591/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/f1e8c983be46895acc576c1d51b631bd2767aabe908035cff229af0cd6c47ffb/mounts/shm
shm                       64M     0   64M    0% /var/lib/docker/containers/c7e44cdfc5faa7f8ad9a08f8b8ce44928a5116ccf912fbc2d8d8871ab00648a5/mounts/shm
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/a685a1652586aca165f7f159347bf466dd63f497766762d8738b511c7eca1df3/merged
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/b7da3fde04f716a7385c47fe558416b35e471797a97b28dddd79f500c62542f2/merged
tmpfs                    1.3G   36K  1.3G    1% /run/user/0
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/d01f8686-e066-4ebf-951e-e5fe9d39067d/volumes/kubernetes.io~secret/node-exporter-token-wnzc6
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/5215bd987a62316b3ebb7d6b103e991f26fffea4fe3c05aac51feeb44ab099ab/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/d0cf9df15ac269475bb9f2aec20c048c8a61b98a993c16f5d6ef4aba2027326a/mounts/shm
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/aa5125b01d60b19c75f3f5d018f7bb51e902264580a7f4033e5d2abaaf7cc3f6/merged
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/3a7d3d4cddc51410103731e7e8f3fbcddae4d74a116c88582557a79252124c5d/merged
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/34f60184-07e5-40da-b2cb-c0295d560d54/volumes/kubernetes.io~secret/default-token-7s6hb
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/940009fca9f57e4b6f6d38bab584d69a2f3ff84153e3f0dfd3c9b9db91fa2b30/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/12c6a27bb53a4b0de5556a960d7c394272d11ceb46ac8172bd91f58f762cde14/mounts/shm
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/366007a9f82dfb9bd5de4e4cadf184cba122ef2070c096f393b7b9e24ae06a98/merged
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/251e9c86-4f25-42bd-82a0-282d057fe238/volumes/kubernetes.io~secret/nginx-ingress-token-cbpz9
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/1defd5a0004201a0f116f48dd2a21cba16647a3c8fdfde802fb5ea1d3e5591ff/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/459bf58b1cafcc9ab673d30b92ae815a093e85593ab01921b9ba6e677e36fe45/mounts/shm
overlay                   47G   45G  2.7G   95% /var/lib/docker/overlay2/49197bcd5b63e30abc94315b0083761a4fd25ebf4341d2574697b84e49350d53/merged
[root@k8s-worker-1 ~]# 
</code></pre>
<p>可以看到，磁盘的配置是使用到95%就会驱逐Pod，而现在的磁盘使用量已经到了配置的限额。</p>
<p>既然如此，那我们的解决方案也就非常明确了，就是把磁盘再加大一些，我们再扩大100G：</p>
<pre><code>[root@k8s-worker-1 ~]# df -h
文件系统                 容量  已用  可用 已用% 挂载点
devtmpfs                 6.3G     0  6.3G    0% /dev
tmpfs                    6.3G     0  6.3G    0% /dev/shm
tmpfs                    6.3G   19M  6.3G    1% /run
tmpfs                    6.3G     0  6.3G    0% /sys/fs/cgroup
/dev/mapper/centos-root  147G   43G  105G   30% /
/dev/vda1               1014M  304M  711M   30% /boot
tmpfs                    1.3G  4.0K  1.3G    1% /run/user/42
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/d01f8686-e066-4ebf-951e-e5fe9d39067d/volumes/kubernetes.io~secret/node-exporter-token-wnzc6
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/9962f8d2-f6bb-4981-a073-dd16bfa9a171/volumes/kubernetes.io~secret/kube-proxy-token-vnxh9
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/251e9c86-4f25-42bd-82a0-282d057fe238/volumes/kubernetes.io~secret/nginx-ingress-token-cbpz9
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/f5872331-14b1-402b-99e0-063834d834fa/volumes/kubernetes.io~secret/calico-node-token-hvs7q
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/7380ac7d8f83ba37ddae785e5b4cd65ef7f9aa138bfb04f86e3c7f186f54211a/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/3c90444a51820f83954c4f32a5bc2d1630762cdf6d3be2c2f897a3f26ee54760/mounts/shm
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/c841e85e88fdcfe9852dcde33849b3e9c5a229e63ee5daea374ddbc572432235/merged
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/147a81e8a50401ec90d55d3d4df3607eb5409ffe10e2c4c876c826aa5d47caf0/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/9e2c04b858025523e7b586fe679a429ac49df3711881261cda40b158ad05aebf/mounts/shm
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/83e01c8cda50233088dc70395a14c861ac09ce5e36621f1d8fdd8d3d3e0a7271/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/f23362117532f08ff89f937369c3e4d2039d55a9ba51f61e41e62d725b24e3a1/mounts/shm
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/0cfe0dbd0c633e13a42bd3d69bd09ea51ab4354d77a0e6dcf93cabf4c76c3942/merged
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/7b83010457d86cecf3c80ebc34d9db5d26400c624cba33a23f0e9983f7791aef/merged
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/0f31c96b1961d5df194a3710fdc896063a864f4282d7a287b41da27e4d58a456/merged
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/f67a6de6a1b18d4748581230ed7c34c8f16d8f0dd877a168eb12eacf6bf42f05/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/e3eb1ea1785e35045213518dd6814edcd361b501748b8e6bdede20c8961062d2/mounts/shm
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/5cec0d1a7723dfcb0e5eaf139f4965a220575557795ad2959ce100aa888dc12b/merged
tmpfs                    1.3G   32K  1.3G    1% /run/user/0
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/704657eb-ea28-4fb0-8aee-c49870e692d3/volumes/kubernetes.io~secret/default-token-7s6hb
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/da4073b560a2ce031fa234624c09757b65eb7b6cfc895186dbf8731e2d279fee/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/76a6814a838778049495e9f8b2b93e131d041c8f90e8dea867d3c99fa6ca918b/mounts/shm
tmpfs                    6.3G   12K  6.3G    1% /var/lib/kubelet/pods/a73b0bc6-76fc-4e2a-9202-380397399b76/volumes/kubernetes.io~secret/default-token-7s6hb
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/cea9c51e718964cc46824ba51ff631a898402318c19e9603c6d364ac3bed8a27/merged
shm                       64M     0   64M    0% /var/lib/docker/containers/d936e646d12f7b8381a36e8a11094d76a0a72d95f84edf3f30c7e8b3981264e0/mounts/shm
overlay                  147G   43G  105G   30% /var/lib/docker/overlay2/4c210c659428999d000676fde7f1c952f1f43d68b63b308fa766b0ce41568f06/merged
[root@k8s-worker-1 ~]# 
</code></pre>
<p>这样就完美地解决了MySQL中的Pod一直在被删掉重建的问题，对吧！</p>
<p>不过，我们高兴得有些早了，正当我把这次的稳定性场景接着跑起来的时候，结果还没出来，又出现了新问题！于是，我们只得来到定向分析的第三阶段。</p>
<h3 id="定向分析第三阶段">定向分析第三阶段</h3>
<p>在上一阶段中，我们发现了MySQL的Pod被删掉重建。于是，当场景再次运行起来时，我就直接查看了所有namespace中的Pod状态，结果看到了下面的信息：</p>
<p><img alt="" src="assets/df3c0fd1226e40c682dc4f8c7a0afdfe.jpg"/></p>
<p>不知道什么原因，Order容器一直在被驱逐。</p>
<p>通过查看日志，我发现了这样的信息：</p>
<p><img alt="" src="assets/f041136f34f144688f5f2235845d9a1b.jpg"/></p>
<p>DiskPressure！这就是说Order服务所在的worker上的存储被用完了呗。在Order应用的虚拟机中，我通过查看Kubernetes日志，发现了这样的错误信息：</p>
<pre><code>kubelet: W0222 14:31:35.507991    1084 eviction_manager.go:344] eviction manager: attempting to reclaim ephemeral-storage
</code></pre>
<p>这是Order应用的存储已经用完了，并且尝试扩展存储。我们接着查Kubernetes日志，看到了“The node was low on resource: ephemeral-storage”的提示。</p>
<p>对Order服务来说，不就是写个日志吗？其他的应用方法都是在用CPU，到底什么Order服务会用这么多的磁盘呢？我们查一下日志，结果看到了这样的错误信息：</p>
<pre><code>[2021-02-25 20:48:22.022] [org.apache.juli.logging.DirectJDKLog] [http-nio-8086-exec-349] [175] [ERROR] Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.jdbc.UncategorizedSQLException: 
### Error querying database.  Cause: java.sql.SQLException: Index oms_order is corrupted
### The error may exist in URL [jar:file:/app.jar!/BOOT-INF/lib/mall-mbg-1.0-SNAPSHOT.jar!/com/dunshan/mall/mapper/OmsOrderMapper.xml]
### The error may involve com.dunshan.mall.mapper.OmsOrderMapper.selectByExample-Inline
### The error occurred while setting parameters
### SQL: SELECT count(0) FROM oms_order WHERE (delete_status = ? AND member_id = ?)
### Cause: java.sql.SQLException: Index oms_order is corrupted
; uncategorized SQLException; SQL state [HY000]; error code [1712]; Index oms_order is corrupted; nested exception is java.sql.SQLException: Index oms_order is corrupted] with root cause
java.sql.SQLException: Index oms_order is corrupted
</code></pre>
<p>这样的错误有很多，并且还增加得非常快。难道是Order表坏了？</p>
<p>在Order服务的日志中，我们可以看到明显是SQL执行报错了，但是我们在上面已经增加了MySQL机器的硬盘，按理说不应该是MySQL的磁盘不够导致的这类报错。所以，我们再来看看MySQL错误日志：</p>
<pre><code>156 2021-02-25T11:26:35.520327Z 0 [Note] InnoDB: Uncompressed page, stored checksum in field1 2147483648, calculated checksums for field1: crc32 1193184986/3495072576, innodb 846701958,         none 3735928559, stored checksum in field2 2147483659, calculated checksums for field2: crc32 1193184986/3495072576, innodb 810726412, none 3735928559,  page LSN 0 0, low 4 bytes of         LSN at page end 3836608512, page number (if stored to page already) 327680, space id (if created with &gt;= MySQL-4.1.1 and stored already) 0
157 InnoDB: Page may be a freshly allocated page
158 2021-02-25T11:26:35.520373Z 0 [Note] InnoDB: It is also possible that your operating system has corrupted its own file cache and rebooting your computer removes the error. If the cor        rupt page is an index page. You can also try to fix the corruption by dumping, dropping, and reimporting the corrupt table. You can use CHECK TABLE to scan your table for corruption.         Please refer to http://dev.mysql.com/doc/refman/5.7/en/forcing-innodb-recovery.html for information about forcing recovery.
159 2021-02-25T11:26:35.520408Z 0 [ERROR] InnoDB: Space id and page no stored in the page, read in are [page id: space=779484, page number=3836674048], should be [page id: space=111, pag        e number=150922]
160 2021-02-25T11:26:35.520415Z 0 [ERROR] InnoDB: Database page corruption on disk or a failed file read of page [page id: space=111, page number=150922]. You may have to recover from a         backup.
161 2021-02-25T11:26:35.520420Z 0 [Note] InnoDB: Page dump in ascii and hex (16384 bytes):
.............                                                      
</code></pre>
<p>从上面的信息来看，应该是数据库的文件损坏了，从而导致了报错。</p>
<p>那我们就尝试一下直接在MySQL中对这个表进行操作，会不会报错。结果得到如下信息：</p>
<pre><code>[Err] 1877 - Operation cannot be performed. The table 'mall.oms_order' is missing, corrupt or contains bad data.
</code></pre>
<p>这个错误日志提示说，操作系统的文件有可能出现了问题，建议重启操作系统。既然系统有建议，那咱就重启一下吧。</p>
<p>然而，世事无常，处处是坑，我们在重启操作系统时看到了这个界面：</p>
<p><img alt="" src="assets/bf9767c3534e486eb91245a89327279b.jpg"/></p>
<p>想哭对吧？现在居然连磁盘都找不着了……</p>
<p>回想刚才对磁盘的操作，我们在增加磁盘空间时，直接用的是这个命令：</p>
<pre><code>qumu-img resize imagename +100G
</code></pre>
<p>我在查看了官方资料之后发现，这个命令虽然能扩容，但是要先关闭虚拟机，不然磁盘会出问题。而我们当时并没有关虚拟机。没办法，我们只有把虚拟机重建一下了。</p>
<p>经过一翻折腾，我们再次把数据库启动，等应用都正常连上之后，再次把稳定性场景运行起来，看到了这样的结果：</p>
<p><img alt="" src="assets/6135f01da0e6418fbc477eeed590c9f5.jpg"/></p>
<p>此时的业务累积量为：</p>
<p><img alt="" src="assets/edde760af5f849ed9483998afe423406.jpg"/></p>
<p>从场景数据来看，TPS有所下降，这是因为我们在压力过程中，所有的数据一直都是累加的。累加得越多，数据库中的操作就会越慢，我们看一下worker-1中，数据库的资源使用量就可以知道：</p>
<p><img alt="" src="assets/9e02a8d40c0749feae4eedc4a6f49810.jpg"/></p>
<p><img alt="" src="assets/8c96a713218c41b6a496a930ac68cea6.jpg"/></p>
<p>你看，这里面的系统负载和IO吞吐，都因稳定性运行时间越来越长、数据量越来越多受到了影响。我们后续的优化思路也就非常明确了，那就是保证当前表的数据量级，像分库分表、定期归档这样的手段就可以上了，这些操作都是常规操作。</p>
<p>在我们当前这个场景中，由于稳定性目标已经达到，就不再接着往下整了。毕竟，性能优化是没有止境的。</p>
<h2 id="总结">总结</h2>
<p>正如我们前面所说，在稳定性场景中，我们要关注的就是“运行时长”和“业务累积量”这两个指标。只要达到了这两个指标，稳定性场景即可结束。</p>
<p>在这节课中，我们分析了长时间运行导致的两个问题：</p>
<ul>
<li><strong>磁盘不足的问题</strong></li>
</ul>
<p>这样的问题在稳定性中也是经常出现的。因此，我们在稳定性场景运行之前，最好预估一下会用到多少磁盘。像日志之类的增长速度，一定要做好循环日志，不要保留太长时间。如果你想保留，那就移到其他地方去。</p>
<ul>
<li><strong>数据库文件损坏的问题</strong></li>
</ul>
<p>这是扩展磁盘空间导致的问题。虽然在操作的过程中，磁盘看似成功扩展了，但由于操作的不当导致了数据库文件损坏。这类问题虽然是操作上的问题，但在操作的过程中我们却没有看到任何的错误信息和提醒。</p>
<p>另外，我们还需要充分考虑数据库的累积量。我建议你先通过计算来判断，当数据库的数据量增加后，会对应用产生什么样的影响。磁盘要能保证数据库当前表的数据量，以及数据增长过程中的查询性能。</p>
<p>在这里，我无法穷举出稳定性中的所有问题，只有通过实际案例给你一个分析的思路，供你借鉴。在你的应用场景中，你可以根据RESAR性能工程理论分析具体的问题。</p>
<p>总之，在性能工程中，稳定性场景对系统来说是一个严峻的考验。“合情合理地设计稳定性场景，并且做到符合生产业务场景”是我们必须要达到的目标。</p>
<h2 id="课后作业">课后作业</h2>
<p>这就是今天的全部内容，最后给你留两个思考题吧：</p>
<ol>
<li>你在稳定性场景中遇到过什么由于业务不断累积导致的问题？</li>
<li>在稳定性场景中，如何保证磁盘使用量不会随场景持续增加，而是保持在一个使用量级？</li>
</ol>
<p>记得在留言区和我讨论、交流你的想法，每一次思考都会让你更进一步。</p>
<p>如果这节课让你有所收获，也欢迎你分享给你的朋友，共同学习进步。我们下一讲再见！</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#98f4f4f4a1aca9a9a8afd8fff5f9f1f4b6fbf7f5" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93598c6deae4392b',t:'MTc0NTUzOTEwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>