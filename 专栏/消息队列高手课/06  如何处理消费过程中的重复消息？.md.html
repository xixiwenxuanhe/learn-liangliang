<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="06  如何处理消费过程中的重复消息？" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>06  如何处理消费过程中的重复消息？ </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%20%e4%bc%98%e7%a7%80%e7%9a%84%e7%a8%8b%e5%ba%8f%e5%91%98%ef%bc%8c%e4%bd%a0%e7%9a%84%e6%8a%80%e6%9c%af%e6%a0%88%e4%b8%ad%e4%b8%8d%e8%83%bd%e5%8f%aa%e6%9c%89%e2%80%9c%e5%a2%9e%e5%88%a0%e6%94%b9%e6%9f%a5%e2%80%9d.md.html" id="00 开篇词  优秀的程序员，你的技术栈中不能只有“增删改查”.md.html">00 开篇词  优秀的程序员，你的技术栈中不能只有“增删改查”.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/00%20%e9%a2%84%e4%b9%a0%20%20%e6%80%8e%e6%a0%b7%e6%9b%b4%e5%a5%bd%e5%9c%b0%e5%ad%a6%e4%b9%a0%e8%bf%99%e9%97%a8%e8%af%be%ef%bc%9f.md.html" id="00 预习  怎样更好地学习这门课？.md.html">00 预习  怎样更好地学习这门课？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/01%20%20%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%ef%bc%9f.md.html" id="01  为什么需要消息队列？.md.html">01  为什么需要消息队列？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/02%20%20%e8%af%a5%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%ef%bc%9f.md.html" id="02  该如何选择消息队列？.md.html">02  该如何选择消息队列？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/03%20%20%e6%b6%88%e6%81%af%e6%a8%a1%e5%9e%8b%ef%bc%9a%e4%b8%bb%e9%a2%98%e5%92%8c%e9%98%9f%e5%88%97%e6%9c%89%e4%bb%80%e4%b9%88%e5%8c%ba%e5%88%ab%ef%bc%9f.md.html" id="03  消息模型：主题和队列有什么区别？.md.html">03  消息模型：主题和队列有什么区别？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/04%20%20%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%e4%ba%8b%e5%8a%a1%e6%b6%88%e6%81%af%e5%ae%9e%e7%8e%b0%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%ef%bc%9f.md.html" id="04  如何利用事务消息实现分布式事务？.md.html">04  如何利用事务消息实现分布式事务？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/05%20%20%e5%a6%82%e4%bd%95%e7%a1%ae%e4%bf%9d%e6%b6%88%e6%81%af%e4%b8%8d%e4%bc%9a%e4%b8%a2%e5%a4%b1.md.html" id="05  如何确保消息不会丢失.md.html">05  如何确保消息不会丢失.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/06%20%20%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%e6%b6%88%e8%b4%b9%e8%bf%87%e7%a8%8b%e4%b8%ad%e7%9a%84%e9%87%8d%e5%a4%8d%e6%b6%88%e6%81%af%ef%bc%9f.md.html" id="06  如何处理消费过程中的重复消息？.md.html">06  如何处理消费过程中的重复消息？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/07%20%20%e6%b6%88%e6%81%af%e7%a7%af%e5%8e%8b%e4%ba%86%e8%af%a5%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%ef%bc%9f.md.html" id="07  消息积压了该如何处理？.md.html">07  消息积压了该如何处理？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/08%20%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%91%ef%bc%88%e4%b8%80%ef%bc%89%20%20%e7%bd%91%e5%85%b3%e5%a6%82%e4%bd%95%e6%8e%a5%e6%94%b6%e6%9c%8d%e5%8a%a1%e7%ab%af%e7%9a%84%e7%a7%92%e6%9d%80%e7%bb%93%e6%9e%9c%ef%bc%9f.md.html" id="08  答疑解惑（一）  网关如何接收服务端的秒杀结果？.md.html">08  答疑解惑（一）  网关如何接收服务端的秒杀结果？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/09%20%20%e5%ad%a6%e4%b9%a0%e5%bc%80%e6%ba%90%e4%bb%a3%e7%a0%81%e8%af%a5%e5%a6%82%e4%bd%95%e5%85%a5%e6%89%8b%ef%bc%9f.md.html" id="09  学习开源代码该如何入手？.md.html">09  学习开源代码该如何入手？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/10%20%20%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e5%bc%82%e6%ad%a5%e8%ae%be%e8%ae%a1%e6%8f%90%e5%8d%87%e7%b3%bb%e7%bb%9f%e6%80%a7%e8%83%bd%ef%bc%9f.md.html" id="10  如何使用异步设计提升系统性能？.md.html">10  如何使用异步设计提升系统性能？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/11%20%20%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e9%ab%98%e6%80%a7%e8%83%bd%e7%9a%84%e5%bc%82%e6%ad%a5%e7%bd%91%e7%bb%9c%e4%bc%a0%e8%be%93%ef%bc%9f.md.html" id="11  如何实现高性能的异步网络传输？.md.html">11  如何实现高性能的异步网络传输？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/12%20%20%e5%ba%8f%e5%88%97%e5%8c%96%e4%b8%8e%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%ef%bc%9a%e5%a6%82%e4%bd%95%e9%80%9a%e8%bf%87%e7%bd%91%e7%bb%9c%e4%bc%a0%e8%be%93%e7%bb%93%e6%9e%84%e5%8c%96%e7%9a%84%e6%95%b0%e6%8d%ae%ef%bc%9f.md.html" id="12  序列化与反序列化：如何通过网络传输结构化的数据？.md.html">12  序列化与反序列化：如何通过网络传输结构化的数据？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/13%20%20%e4%bc%a0%e8%be%93%e5%8d%8f%e8%ae%ae%ef%bc%9a%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e4%b9%8b%e9%97%b4%e5%af%b9%e8%af%9d%e7%9a%84%e8%af%ad%e8%a8%80.md.html" id="13  传输协议：应用程序之间对话的语言.md.html">13  传输协议：应用程序之间对话的语言.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/14%20%20%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86%ef%bc%9a%e5%a6%82%e4%bd%95%e9%81%bf%e5%85%8d%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%e5%92%8c%e9%a2%91%e7%b9%81%e7%9a%84%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%ef%bc%9f.md.html" id="14  内存管理：如何避免内存溢出和频繁的垃圾回收？.md.html">14  内存管理：如何避免内存溢出和频繁的垃圾回收？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/15%20%20Kafka%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e9%ab%98%e6%80%a7%e8%83%bdIO%ef%bc%9f.md.html" id="15  Kafka如何实现高性能IO？.md.html">15  Kafka如何实现高性能IO？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/16%20%20%e7%bc%93%e5%ad%98%e7%ad%96%e7%95%a5%ef%bc%9a%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e7%bc%93%e5%ad%98%e6%9d%a5%e5%87%8f%e5%b0%91%e7%a3%81%e7%9b%98IO%ef%bc%9f.md.html" id="16  缓存策略：如何使用缓存来减少磁盘IO？.md.html">16  缓存策略：如何使用缓存来减少磁盘IO？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/17%20%20%e5%a6%82%e4%bd%95%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e9%94%81%e4%bf%9d%e6%8a%a4%e5%85%b1%e4%ba%ab%e6%95%b0%e6%8d%ae%ef%bc%8c%e5%8d%8f%e8%b0%83%e5%bc%82%e6%ad%a5%e7%ba%bf%e7%a8%8b%ef%bc%9f.md.html" id="17  如何正确使用锁保护共享数据，协调异步线程？.md.html">17  如何正确使用锁保护共享数据，协调异步线程？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/18%20%20%e5%a6%82%e4%bd%95%e7%94%a8%e7%a1%ac%e4%bb%b6%e5%90%8c%e6%ad%a5%e5%8e%9f%e8%af%ad%ef%bc%88CAS%ef%bc%89%e6%9b%bf%e4%bb%a3%e9%94%81%ef%bc%9f.md.html" id="18  如何用硬件同步原语（CAS）替代锁？.md.html">18  如何用硬件同步原语（CAS）替代锁？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/19%20%20%e6%95%b0%e6%8d%ae%e5%8e%8b%e7%bc%a9%ef%bc%9a%e6%97%b6%e9%97%b4%e6%8d%a2%e7%a9%ba%e9%97%b4%e7%9a%84%e6%b8%b8%e6%88%8f.md.html" id="19  数据压缩：时间换空间的游戏.md.html">19  数据压缩：时间换空间的游戏.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/20%20%20RocketMQ%20Producer%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%9a%e6%b6%88%e6%81%af%e7%94%9f%e4%ba%a7%e7%9a%84%e5%ae%9e%e7%8e%b0%e8%bf%87%e7%a8%8b.md.html" id="20  RocketMQ Producer源码分析：消息生产的实现过程.md.html">20  RocketMQ Producer源码分析：消息生产的实现过程.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/21%20%20Kafka%20Consumer%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%9a%e6%b6%88%e6%81%af%e6%b6%88%e8%b4%b9%e7%9a%84%e5%ae%9e%e7%8e%b0%e8%bf%87%e7%a8%8b.md.html" id="21  Kafka Consumer源码分析：消息消费的实现过程.md.html">21  Kafka Consumer源码分析：消息消费的实现过程.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/22%20%20Kafka%e5%92%8cRocketMQ%e7%9a%84%e6%b6%88%e6%81%af%e5%a4%8d%e5%88%b6%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%b7%ae%e5%bc%82%e7%82%b9%e5%9c%a8%e5%93%aa%ef%bc%9f.md.html" id="22  Kafka和RocketMQ的消息复制实现的差异点在哪？.md.html">22  Kafka和RocketMQ的消息复制实现的差异点在哪？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/23%20%20RocketMQ%e5%ae%a2%e6%88%b7%e7%ab%af%e5%a6%82%e4%bd%95%e5%9c%a8%e9%9b%86%e7%be%a4%e4%b8%ad%e6%89%be%e5%88%b0%e6%ad%a3%e7%a1%ae%e7%9a%84%e8%8a%82%e7%82%b9%ef%bc%9f.md.html" id="23  RocketMQ客户端如何在集群中找到正确的节点？.md.html">23  RocketMQ客户端如何在集群中找到正确的节点？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/24%20%20Kafka%e7%9a%84%e5%8d%8f%e8%b0%83%e6%9c%8d%e5%8a%a1ZooKeeper%ef%bc%9a%e5%ae%9e%e7%8e%b0%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e7%9a%84%e2%80%9c%e7%91%9e%e5%a3%ab%e5%86%9b%e5%88%80%e2%80%9d.md.html" id="24  Kafka的协调服务ZooKeeper：实现分布式系统的“瑞士军刀”.md.html">24  Kafka的协调服务ZooKeeper：实现分布式系统的“瑞士军刀”.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/25%20%20RocketMQ%e4%b8%8eKafka%e4%b8%ad%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%ba%8b%e5%8a%a1%ef%bc%9f.md.html" id="25  RocketMQ与Kafka中如何实现事务？.md.html">25  RocketMQ与Kafka中如何实现事务？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/26%20%20MQTT%e5%8d%8f%e8%ae%ae%ef%bc%9a%e5%a6%82%e4%bd%95%e6%94%af%e6%8c%81%e6%b5%b7%e9%87%8f%e7%9a%84%e5%9c%a8%e7%ba%bfIoT%e8%ae%be%e5%a4%87.md.html" id="26  MQTT协议：如何支持海量的在线IoT设备.md.html">26  MQTT协议：如何支持海量的在线IoT设备.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/27%20%20Pulsar%e7%9a%84%e5%ad%98%e5%82%a8%e8%ae%a1%e7%ae%97%e5%88%86%e7%a6%bb%e8%ae%be%e8%ae%a1%ef%bc%9a%e5%85%a8%e6%96%b0%e7%9a%84%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af.md.html" id="27  Pulsar的存储计算分离设计：全新的消息队列设计思路.md.html">27  Pulsar的存储计算分离设计：全新的消息队列设计思路.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/28%20%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%91%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e6%88%91%e7%9a%84100%e5%85%83%e5%93%aa%e5%84%bf%e5%8e%bb%e4%ba%86%ef%bc%9f.md.html" id="28  答疑解惑（二）：我的100元哪儿去了？.md.html">28  答疑解惑（二）：我的100元哪儿去了？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/29%20%20%e6%b5%81%e8%ae%a1%e7%ae%97%e4%b8%8e%e6%b6%88%e6%81%af%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e9%80%9a%e8%bf%87Flink%e7%90%86%e8%a7%a3%e6%b5%81%e8%ae%a1%e7%ae%97%e7%9a%84%e5%8e%9f%e7%90%86.md.html" id="29  流计算与消息（一）：通过Flink理解流计算的原理.md.html">29  流计算与消息（一）：通过Flink理解流计算的原理.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/30%20%20%e6%b5%81%e8%ae%a1%e7%ae%97%e4%b8%8e%e6%b6%88%e6%81%af%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e5%9c%a8%e6%b5%81%e8%ae%a1%e7%ae%97%e4%b8%ad%e4%bd%bf%e7%94%a8Kafka%e9%93%be%e6%8e%a5%e8%ae%a1%e7%ae%97%e4%bb%bb%e5%8a%a1.md.html" id="30  流计算与消息（二）：在流计算中使用Kafka链接计算任务.md.html">30  流计算与消息（二）：在流计算中使用Kafka链接计算任务.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/31%20%20%e5%8a%a8%e6%89%8b%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84RPC%e6%a1%86%e6%9e%b6%ef%bc%88%e4%b8%80%ef%bc%89%ef%bc%9a%e5%8e%9f%e7%90%86%e5%92%8c%e7%a8%8b%e5%ba%8f%e7%9a%84%e7%bb%93%e6%9e%84.md.html" id="31  动手实现一个简单的RPC框架（一）：原理和程序的结构.md.html">31  动手实现一个简单的RPC框架（一）：原理和程序的结构.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/32%20%20%e5%8a%a8%e6%89%8b%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84RPC%e6%a1%86%e6%9e%b6%ef%bc%88%e4%ba%8c%ef%bc%89%ef%bc%9a%e9%80%9a%e4%bf%a1%e4%b8%8e%e5%ba%8f%e5%88%97%e5%8c%96.md.html" id="32  动手实现一个简单的RPC框架（二）：通信与序列化.md.html">32  动手实现一个简单的RPC框架（二）：通信与序列化.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/33%20%20%e5%8a%a8%e6%89%8b%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84RPC%e6%a1%86%e6%9e%b6%ef%bc%88%e4%b8%89%ef%bc%89%ef%bc%9a%e5%ae%a2%e6%88%b7%e7%ab%af.md.html" id="33  动手实现一个简单的RPC框架（三）：客户端.md.html">33  动手实现一个简单的RPC框架（三）：客户端.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/34%20%20%e5%8a%a8%e6%89%8b%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84RPC%e6%a1%86%e6%9e%b6%ef%bc%88%e5%9b%9b%ef%bc%89%ef%bc%9a%e6%9c%8d%e5%8a%a1%e7%ab%af.md.html" id="34  动手实现一个简单的RPC框架（四）：服务端.md.html">34  动手实现一个简单的RPC框架（四）：服务端.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/35%20%20%e7%ad%94%e7%96%91%e8%a7%a3%e6%83%91%ef%bc%88%e4%b8%89%ef%bc%89%ef%bc%9a%e4%b8%bb%e6%b5%81%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%83%bd%e6%98%af%e5%a6%82%e4%bd%95%e5%ad%98%e5%82%a8%e6%b6%88%e6%81%af%e7%9a%84%ef%bc%9f.md.html" id="35  答疑解惑（三）：主流消息队列都是如何存储消息的？.md.html">35  答疑解惑（三）：主流消息队列都是如何存储消息的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/%e5%8a%a0%e9%a4%90%20%20JMQ%e7%9a%84Broker%e6%98%af%e5%a6%82%e4%bd%95%e5%bc%82%e6%ad%a5%e5%a4%84%e7%90%86%e6%b6%88%e6%81%af%e7%9a%84%ef%bc%9f.md.html" id="加餐  JMQ的Broker是如何异步处理消息的？.md.html">加餐  JMQ的Broker是如何异步处理消息的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%ab%98%e6%89%8b%e8%af%be/%e7%bb%93%e6%9d%9f%e8%af%ad%20%20%e7%a8%8b%e5%ba%8f%e5%91%98%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e7%9f%a5%e8%af%86%e4%bd%93%e7%b3%bb%ef%bc%9f.md.html" id="结束语  程序员如何构建知识体系？.md.html">结束语  程序员如何构建知识体系？.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="06  如何处理消费过程中的重复消息？" id="title">06  如何处理消费过程中的重复消息？</h1>
<div><p>你好，我是李玥。上节课我们讲了如何确保消息不会丢失，课后我给你留了一个思考题，如果消息重复了怎么办？这节课，我们就来聊一聊如何处理重复消息的问题。</p>
<p>在消息传递过程中，如果出现传递失败的情况，发送方会执行重试，重试的过程中就有可能会产生重复的消息。对使用消息队列的业务系统来说，如果没有对重复消息进行处理，就有可能会导致系统的数据出现错误。</p>
<p>比如说，一个消费订单消息，统计下单金额的微服务，如果没有正确处理重复消息，那就会出现重复统计，导致统计结果错误。</p>
<p>你可能会问，如果消息队列本身能保证消息不重复，那应用程序的实现不就简单了？那有没有消息队列能保证消息不重复呢？</p>
<h2 id="消息重复的情况必然存在">消息重复的情况必然存在</h2>
<p>在 MQTT 协议中，给出了三种传递消息时能够提供的服务质量标准，这三种服务质量从低到高依次是：</p>
<ul>
<li><strong>At most once</strong>: 至多一次。消息在传递时，最多会被送达一次。换一个说法就是，没什么消息可靠性保证，允许丢消息。一般都是一些对消息可靠性要求不太高的监控场景使用，比如每分钟上报一次机房温度数据，可以接受数据少量丢失。</li>
<li><strong>At least once</strong>: 至少一次。消息在传递时，至少会被送达一次。也就是说，不允许丢消息，但是允许有少量重复消息出现。</li>
<li><strong>Exactly once</strong>：恰好一次。消息在传递时，只会被送达一次，不允许丢失也不允许重复，这个是最高的等级。</li>
</ul>
<p>这个服务质量标准不仅适用于 MQTT，对所有的消息队列都是适用的。我们现在常用的绝大部分消息队列提供的服务质量都是 At least once，包括 RocketMQ、RabbitMQ 和 Kafka 都是这样。也就是说，消息队列很难保证消息不重复。</p>
<p>说到这儿我知道肯定有的同学会反驳我：“你说的不对，我看过 Kafka 的文档，Kafka 是支持 Exactly once 的。”我在这里跟这些同学解释一下，你说的没错，Kafka 的确是支持 Exactly once，但是我讲的也没有问题，为什么呢？</p>
<p>Kafka 支持的“Exactly once”和我们刚刚提到的消息传递的服务质量标准“Exactly once”是不一样的，它是 Kafka 提供的另外一个特性，Kafka 中支持的事务也和我们通常意义理解的事务有一定的差异。在 Kafka 中，事务和 Excactly once 主要是为了配合流计算使用的特性，我们在专栏“进阶篇”这个模块中，会有专门的一节课来讲 Kafka 的事务和它支持的 Exactly once 特性。</p>
<p>稍微说一些题外话，Kafka 的团队是一个非常善于包装和营销的团队，你看他们很巧妙地用了两个所有人都非常熟悉的概念“事务”和“Exactly once”来包装它的新的特性，实际上它实现的这个事务和 Exactly once 并不是我们通常理解的那两个特性，但是你深入了解 Kafka 的事务和 Exactly once 后，会发现其实它这个特性虽然和我们通常的理解不一样，但确实和事务、Exactly once 有一定关系。</p>
<p>这一点上，我们都要学习 Kafka 团队。一个优秀的开发团队，不仅要能写代码，更要能写文档，能写 Slide（PPT），还要能讲，会分享。对于每个程序员来说，也是一样的。</p>
<p>我们把话题收回来，继续来说重复消息的问题。既然消息队列无法保证消息不重复，就需要我们的消费代码能够接受“消息是可能会重复的”这一现状，然后，通过一些方法来消除重复消息对业务的影响。</p>
<h2 id="用幂等性解决重复消息问题">用幂等性解决重复消息问题</h2>
<p>一般解决重复消息的办法是，在消费端，让我们消费消息的操作具备幂等性。</p>
<p><strong>幂等（Idempotence）</strong> 本来是一个数学上的概念，它是这样定义的：</p>
<blockquote>
<p>如果一个函数 f(x) 满足：f(f(x)) = f(x)，则函数 f(x) 满足幂等性。</p>
</blockquote>
<p>这个概念被拓展到计算机领域，被用来描述一个操作、方法或者服务。一个幂等操作的特点是，<strong>其任意多次执行所产生的影响均与一次执行的影响相同。</strong></p>
<p>一个幂等的方法，使用同样的参数，对它进行多次调用和一次调用，对系统产生的影响是一样的。所以，对于幂等的方法，不用担心重复执行会对系统造成任何改变。</p>
<p>我们举个例子来说明一下。在不考虑并发的情况下，“将账户 X 的余额设置为 100 元”，执行一次后对系统的影响是，账户 X 的余额变成了 100 元。只要提供的参数 100 元不变，那即使再执行多少次，账户 X 的余额始终都是 100 元，不会变化，这个操作就是一个幂等的操作。</p>
<p>再举一个例子，“将账户 X 的余额加 100 元”，这个操作它就不是幂等的，每执行一次，账户余额就会增加 100 元，执行多次和执行一次对系统的影响（也就是账户的余额）是不一样的。</p>
<p>如果我们系统消费消息的业务逻辑具备幂等性，那就不用担心消息重复的问题了，因为同一条消息，消费一次和消费多次对系统的影响是完全一样的。也就可以认为，消费多次等于消费一次。</p>
<p>从对系统的影响结果来说：<strong>At least once + 幂等消费 = Exactly once。</strong></p>
<p>那么如何实现幂等操作呢？最好的方式就是，<strong>从业务逻辑设计上入手，将消费的业务逻辑设计成具备幂等性的操作。</strong>但是，不是所有的业务都能设计成天然幂等的，这里就需要一些方法和技巧来实现幂等。</p>
<p>下面我给你介绍几种常用的设计幂等操作的方法：</p>
<p><strong>1. 利用数据库的唯一约束实现幂等</strong></p>
<p>例如我们刚刚提到的那个不具备幂等特性的转账的例子：将账户 X 的余额加 100 元。在这个例子中，我们可以通过改造业务逻辑，让它具备幂等性。</p>
<p>首先，我们可以限定，对于每个转账单每个账户只可以执行一次变更操作，在分布式系统中，这个限制实现的方法非常多，最简单的是我们在数据库中建一张转账流水表，这个表有三个字段：转账单 ID、账户 ID 和变更金额，然后给转账单 ID 和账户 ID 这两个字段联合起来创建一个唯一约束，这样对于相同的转账单 ID 和账户 ID，表里至多只能存在一条记录。</p>
<p>这样，我们消费消息的逻辑可以变为：“在转账流水表中增加一条转账记录，然后再根据转账记录，异步操作更新用户余额即可。”在转账流水表增加一条转账记录这个操作中，由于我们在这个表中预先定义了“账户 ID 转账单 ID”的唯一约束，对于同一个转账单同一个账户只能插入一条记录，后续重复的插入操作都会失败，这样就实现了一个幂等的操作。我们只要写一个 SQL，正确地实现它就可以了。</p>
<p>基于这个思路，不光是可以使用关系型数据库，只要是支持类似“INSERT IF NOT EXIST”语义的存储类系统都可以用于实现幂等，比如，你可以用 Redis 的 SETNX 命令来替代数据库中的唯一约束，来实现幂等消费。</p>
<p><strong>2. 为更新的数据设置前置条件</strong></p>
<p>另外一种实现幂等的思路是，给数据变更设置一个前置条件，如果满足条件就更新数据，否则拒绝更新数据，在更新数据的时候，同时变更前置条件中需要判断的数据。这样，重复执行这个操作时，由于第一次更新数据的时候已经变更了前置条件中需要判断的数据，不满足前置条件，则不会重复执行更新数据操作。</p>
<p>比如，刚刚我们说过，“将账户 X 的余额增加 100 元”这个操作并不满足幂等性，我们可以把这个操作加上一个前置条件，变为：“如果账户 X 当前的余额为 500 元，将余额加 100 元”，这个操作就具备了幂等性。对应到消息队列中的使用时，可以在发消息时在消息体中带上当前的余额，在消费的时候进行判断数据库中，当前余额是否与消息中的余额相等，只有相等才执行变更操作。</p>
<p>但是，如果我们要更新的数据不是数值，或者我们要做一个比较复杂的更新操作怎么办？用什么作为前置判断条件呢？更加通用的方法是，给你的数据增加一个版本号属性，每次更数据前，比较当前数据的版本号是否和消息中的版本号一致，如果不一致就拒绝更新数据，更新数据的同时将版本号 +1，一样可以实现幂等更新。</p>
<p><strong>3. 记录并检查操作</strong></p>
<p>如果上面提到的两种实现幂等方法都不能适用于你的场景，我们还有一种通用性最强，适用范围最广的实现幂等性方法：记录并检查操作，也称为“Token 机制或者 GUID（全局唯一 ID）机制”，实现的思路特别简单：在执行数据更新操作之前，先检查一下是否执行过这个更新操作。</p>
<p>具体的实现方法是，在发送消息时，给每条消息指定一个全局唯一的 ID，消费时，先根据这个 ID 检查这条消息是否有被消费过，如果没有消费过，才更新数据，然后将消费状态置为已消费。</p>
<p>原理和实现是不是很简单？其实一点儿都不简单，在分布式系统中，这个方法其实是非常难实现的。首先，给每个消息指定一个全局唯一的 ID 就是一件不那么简单的事儿，方法有很多，但都不太好同时满足简单、高可用和高性能，或多或少都要有些牺牲。更加麻烦的是，在“检查消费状态，然后更新数据并且设置消费状态”中，三个操作必须作为一组操作保证原子性，才能真正实现幂等，否则就会出现 Bug。</p>
<p>比如说，对于同一条消息：“全局 ID 为 8，操作为：给 ID 为 666 账户增加 100 元”，有可能出现这样的情况：</p>
<ul>
<li>t0 时刻：Consumer A 收到条消息，检查消息执行状态，发现消息未处理过，开始执行“账户增加 100 元”；</li>
<li>t1 时刻：Consumer B 收到条消息，检查消息执行状态，发现消息未处理过，因为这个时刻，Consumer A 还未来得及更新消息执行状态。</li>
</ul>
<p>这样就会导致账户被错误地增加了两次 100 元，这是一个在分布式系统中非常容易犯的错误，一定要引以为戒。</p>
<p>对于这个问题，当然我们可以用事务来实现，也可以用锁来实现，但是在分布式系统中，无论是分布式事务还是分布式锁都是比较难解决问题。</p>
<h2 id="小结">小结</h2>
<p>这节课我们主要介绍了通过幂等消费来解决消息重复的问题，然后我重点讲了几种实现幂等操作的方法，你可以利用数据库的约束来防止重复更新数据，也可以为数据更新设置一次性的前置条件，来防止重复消息，如果这两种方法都不适用于你的场景，还可以用“记录并检查操作”的方式来保证幂等，这种方法适用范围最广，但是实现难度和复杂度也比较高，一般不推荐使用。</p>
<p>这些实现幂等的方法，不仅可以用于解决重复消息的问题，也同样适用于，在其他场景中来解决重复请求或者重复调用的问题。比如，我们可以将 HTTP 服务设计成幂等的，解决前端或者 APP 重复提交表单数据的问题；也可以将一个微服务设计成幂等的，解决 RPC 框架自动重试导致的重复调用问题。这些方法都是通用的，希望你能做到触类旁通，举一反三。</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#630f0f0f5a575252535423040e020a0f4d000c0e" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93595b87cf7e819a',t:'MTc0NTUzNzEwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>