<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="15 弹出选项与切换状态" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>15 弹出选项与切换状态 </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/01%20%e5%89%8d%e8%a8%80-%e6%95%99%e7%a8%8b%e5%86%85%e5%ae%b9%e5%af%bc%e8%af%bb.md.html" id="01 前言-教程内容导读.md.html">01 前言-教程内容导读.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/02%20Flutter%20%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e7%9a%84%e6%90%ad%e5%bb%ba.md.html" id="02 Flutter 开发环境的搭建.md.html">02 Flutter 开发环境的搭建.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/03%20%e6%96%b0%e6%89%8b%e6%9d%91%e5%9f%ba%e7%a1%80%20Dart%20%e8%af%ad%e6%b3%95%20%28%e4%b8%8a%29.md.html" id="03 新手村基础 Dart 语法 (上).md.html">03 新手村基础 Dart 语法 (上).md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/04%20%e6%96%b0%e6%89%8b%e6%9d%91%e5%9f%ba%e7%a1%80%20Dart%20%e8%af%ad%e6%b3%95%20%28%e4%b8%8b%29.md.html" id="04 新手村基础 Dart 语法 (下).md.html">04 新手村基础 Dart 语法 (下).md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/05%20Flutter%20%e8%ae%a1%e6%95%b0%e5%99%a8%e9%a1%b9%e7%9b%ae%e8%a7%a3%e8%af%bb.md.html" id="05 Flutter 计数器项目解读.md.html">05 Flutter 计数器项目解读.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/06%20%e7%8c%9c%e6%95%b0%e5%ad%97%e7%95%8c%e9%9d%a2%e4%ba%a4%e4%ba%92%e4%b8%8e%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90.md.html" id="06 猜数字界面交互与需求分析.md.html">06 猜数字界面交互与需求分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/07%20%e4%bd%bf%e7%94%a8%e7%bb%84%e4%bb%b6%e6%9e%84%e5%bb%ba%e9%9d%99%e6%80%81%e7%95%8c%e9%9d%a2.md.html" id="07 使用组件构建静态界面.md.html">07 使用组件构建静态界面.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/08%20%e7%8a%b6%e6%80%81%e6%95%b0%e6%8d%ae%e4%b8%8e%e7%95%8c%e9%9d%a2%e6%9b%b4%e6%96%b0.md.html" id="08 状态数据与界面更新.md.html">08 状态数据与界面更新.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/09%20%e6%a0%a1%e9%aa%8c%e7%bb%93%e6%9e%9c%e4%b8%8e%e6%8f%90%e7%a4%ba%e4%bf%a1%e6%81%af.md.html" id="09 校验结果与提示信息.md.html">09 校验结果与提示信息.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/10%20%e5%8a%a8%e7%94%bb%e4%bd%bf%e7%94%a8%e4%b8%8e%e7%8a%b6%e6%80%81%e5%91%a8%e6%9c%9f.md.html" id="10 动画使用与状态周期.md.html">10 动画使用与状态周期.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/11%20%e7%8c%9c%e6%95%b0%e5%ad%97%e6%95%b4%e7%90%86%e4%b8%8e%e6%80%bb%e7%bb%93.md.html" id="11 猜数字整理与总结.md.html">11 猜数字整理与总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/12%20%e7%94%b5%e5%ad%90%e6%9c%a8%e9%b1%bc%e7%95%8c%e9%9d%a2%e4%ba%a4%e4%ba%92%e4%b8%8e%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90.md.html" id="12 电子木鱼界面交互与需求分析.md.html">12 电子木鱼界面交互与需求分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/13%20%e7%94%b5%e5%ad%90%e6%9c%a8%e9%b1%bc%e9%9d%99%e6%80%81%e7%95%8c%e9%9d%a2%e6%9e%84%e5%bb%ba.md.html" id="13 电子木鱼静态界面构建.md.html">13 电子木鱼静态界面构建.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/14%20%e8%ae%a1%e6%95%b0%e5%8f%98%e5%8c%96%e4%b8%8e%e9%9f%b3%e6%95%88%e6%92%ad%e6%94%be.md.html" id="14 计数变化与音效播放.md.html">14 计数变化与音效播放.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/15%20%e5%bc%b9%e5%87%ba%e9%80%89%e9%a1%b9%e4%b8%8e%e5%88%87%e6%8d%a2%e7%8a%b6%e6%80%81.md.html" id="15 弹出选项与切换状态.md.html">15 弹出选项与切换状态.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/16%20%e7%94%a8%e6%bb%91%e5%8a%a8%e5%88%97%e8%a1%a8%e5%b1%95%e7%a4%ba%e8%ae%b0%e5%bd%95.md.html" id="16 用滑动列表展示记录.md.html">16 用滑动列表展示记录.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/17%20%e7%94%b5%e5%ad%90%e6%9c%a8%e9%b1%bc%e6%95%b4%e7%90%86%e4%b8%8e%e6%80%bb%e7%bb%93.md.html" id="17 电子木鱼整理与总结.md.html">17 电子木鱼整理与总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/18%20%e7%99%bd%e6%9d%bf%e7%bb%98%e5%88%b6%e7%95%8c%e9%9d%a2%e4%ba%a4%e4%ba%92%e4%b8%8e%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90.md.html" id="18 白板绘制界面交互与需求分析.md.html">18 白板绘制界面交互与需求分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/19%20%e8%ae%a4%e8%af%86%e8%87%aa%e5%ae%9a%e4%b9%89%e7%bb%98%e5%88%b6%e7%bb%84%e4%bb%b6.md.html" id="19 认识自定义绘制组件.md.html">19 认识自定义绘制组件.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/20%20%e9%80%9a%e8%bf%87%e6%89%8b%e5%8a%bf%e5%9c%a8%e7%99%bd%e6%9d%bf%e4%b8%8a%e7%bb%98%e5%88%b6.md.html" id="20 通过手势在白板上绘制.md.html">20 通过手势在白板上绘制.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/21%20%e7%99%bd%e6%9d%bf%e7%94%bb%e7%ac%94%e7%9a%84%e5%8f%82%e6%95%b0%e8%ae%be%e7%bd%ae.md.html" id="21 白板画笔的参数设置.md.html">21 白板画笔的参数设置.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/22%20%e6%92%a4%e9%94%80%e5%8a%9f%e8%83%bd%e4%b8%8e%e7%94%bb%e6%9d%bf%e4%bc%98%e5%8c%96.md.html" id="22 撤销功能与画板优化.md.html">22 撤销功能与画板优化.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/23%20%e5%ba%94%e7%94%a8%e7%95%8c%e9%9d%a2%e6%95%b4%e5%90%88.md.html" id="23 应用界面整合.md.html">23 应用界面整合.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/24%20%e6%95%b0%e6%8d%ae%e7%9a%84%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8.md.html" id="24 数据的持久化存储.md.html">24 数据的持久化存储.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/25%20%e7%bd%91%e7%bb%9c%e6%95%b0%e6%8d%ae%e7%9a%84%e8%ae%bf%e9%97%ae.md.html" id="25 网络数据的访问.md.html">25 网络数据的访问.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/26%20%e6%95%99%e7%a8%8b%e6%80%bb%e7%bb%93%e4%b8%8e%e5%b1%95%e6%9c%9b.md.html" id="26 教程总结与展望.md.html">26 教程总结与展望.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="15 弹出选项与切换状态" id="title">15 弹出选项与切换状态</h1>
<div><h4 id="1-选择木鱼界面分析">1. 选择木鱼界面分析</h4>
<p>现在想要的效果如下所示，点击第二个绿色按钮时，从底部弹出木鱼图片的选项。从界面上来说，有如下几个要点：</p>
<ul>
<li>需要展示木鱼样式的基本信息，包括名称、图片及每次功德数范围。</li>
<li>需要将当前展示选择的木鱼边上蓝色边线，表示选择状态。</li>
<li>选择切换木鱼时，同时更新主界面木鱼样式。</li>
</ul>
<table>
<thead>
<tr>
<th>木鱼界面</th>
<th>选择界面</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="fa4426744315b5f1fdf8659efac37cb.jpg" src="assets/f73b2deb0573426d966cda5fcbbb603a_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
<td><img alt="800956908b6a68d94dfad9cba9ef6f3.jpg" src="assets/8dfbc17ef9714f60bf7881a9230e94ad_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
</tr>
</tbody>
</table>
<p>仔细分析可以看出，两个选项的布局结构是类似的，不同点在于木鱼的信息以及激活状态。所以只要封装一个组件，就可以用来构建上面的两个选择项，这就是封装的可复用性。不过在此之前先梳理一下木鱼的数据信息：
根据目前的需求设定，木鱼需要 <code>名称</code>、<code>图片资源</code>、<code>增加功德范围</code> 的数据，这些数据可以通过一个类型进行维护，比如下面的 <code>ImageOption</code> 类：</p>
<pre><code class="language-arduino">---&gt;[muyu/models/image_option.dart]---
class ImageOption{
  final String name; // 名称
  final String src; // 资源
  final int min; // 每次点击时功德最小值
  final int max; // 每次点击时功德最大值

  const ImageOption(this.name, this.src, this.min, this.max);
}
</code></pre>
<p>对于一个样式来说，依赖的数据是 <code>ImageOption</code> 对象和 <code>bool</code> 类型的激活状态。这里封装一个 <code>ImageOptionItem</code> 组件用于构建一种样式的界面：</p>
<p><img alt="image.png" src="assets/4c54407269314f31996630337a00acce_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>代码如下，红框中的单体是上中下的结果，通过 <code>Column</code> 组件竖向排列，另外使用装饰属性的 <code>border</code> ，根据是否激活，添加边线。其中的文字、图片数据都是通过 <code>ImageOption</code> 类型的成员确定的。</p>
<pre><code class="language-php">---&gt;[muyu/options/select_image.dart]---
class ImageOptionItem extends StatelessWidget {
  final ImageOption option;
  final bool active;

  const ImageOptionItem({
    Key? key,
    required this.option,
    required this.active,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    const Border activeBorder = Border.fromBorderSide(BorderSide(color: Colors.blue));
    return Container(
      padding: const EdgeInsets.symmetric(vertical: 8),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(8),
        border: !active ? null : activeBorder,
      ),
      child: Column(
        children: [
          Text(option.name, style: TextStyle(fontWeight: FontWeight.bold)),
          Expanded(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8.0),
              child: Image.asset(option.src),
            ),
          ),
          Text('每次功德 +${option.min}~${option.max}',
              style: const TextStyle(color: Colors.grey,fontSize: 12)),
        ],
      ),
    );
  }
}
</code></pre>
<hr/>
<h4 id="2-底部弹框及界面构建">2.底部弹框及界面构建</h4>
<p>由于有了新需求，<code>_MuyuPageState</code> 状态类需要添加一些状态数据来实现功能。如下，新增了 <code>imageOptions</code> 对象表示木鱼选项的列表；已及 <code>_activeImageIndex</code> 表示当前激活的木鱼索引：</p>
<pre><code class="language-ini">----&gt;[_MuyuPageState]----
final List&lt;ImageOption&gt; imageOptions = const [
  ImageOption('基础版','assets/images/muyu.png',1,3),
  ImageOption('尊享版','assets/images/muyu_2.png',3,6),
];

int _activeImageIndex = 0;
</code></pre>
<hr/>
<p>点击时的底部弹框，可以使用 <code>showCupertinoModalPopup</code> 方法实现。其中 <code>builder</code> 入参中返回底部弹框中的内容组件，这里通过自定义的 <code>ImageOptionPanel</code> 组件来完成弹框内界面的构建逻辑。</p>
<pre><code class="language-php">----&gt;[_MuyuPageState]----
void _onTapSwitchImage() {
  showCupertinoModalPopup(
    context: context,
    builder: (BuildContext context) {
      return ImageOptionPanel(
        imageOptions: imageOptions,
        activeIndex: _activeImageIndex,
        onSelect: _onSelectImage,
      );
    },
  );
}
</code></pre>
<hr/>
<p>很容易可以看出选择木鱼的面板中需要 <code>ImageOption</code> 列表、当前激活索引两个数据；由于点击选择时需要更新主界面的数据，所以这里通过 <code>onSelect</code> 回调，让处理逻辑交由使用者来实现。</p>
<pre><code class="language-dart">---&gt;[muyu/options/select_image.dart]---
class ImageOptionPanel extends StatelessWidget {
  final List&lt;ImageOption&gt; imageOptions;
  final ValueChanged&lt;int&gt; onSelect;
  final int activeIndex;

  const ImageOptionPanel({
    Key? key,
    required this.imageOptions,
    required this.activeIndex,
    required this.onSelect,
  }) : super(key: key);
</code></pre>
<p>界面的构建逻辑如下，整体结构并不复杂。主要是上下结构，上面是标题，下面是选项的条目。由于这里只要两个条目，使用 <code>Row</code> + <code>Expanded</code> 组件，让单体平分水平空间：</p>
<p><img alt="image.png" src="assets/dc8065c05cd64e2cb38d15199c5f321d_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<pre><code class="language-php">@override
Widget build(BuildContext context) {
  const TextStyle labelStyle = TextStyle(fontSize: 16, fontWeight: FontWeight.bold);
  const EdgeInsets padding = EdgeInsets.symmetric(horizontal: 8.0, vertical: 16);
  return Material(
    child: SizedBox(
      height: 300,
      child: Column(
        children: [
          Container(
              height: 46,
              alignment: Alignment.center,
              child: const Text( "选择木鱼", style: labelStyle)),
          Expanded(
              child: Padding(
            padding: padding,
            child: Row(
              children: [
                Expanded(child: _buildByIndex(0)),
                const SizedBox(width: 10),
                Expanded(child: _buildByIndex(1)),
              ],
            ),
          ))
        ],
      ),
    ),
  );
}
</code></pre>
<p>在 <code>_buildByIndex</code> 中，简单封装一下根据索引生成条目组件的逻辑，并通过点击事件，触发 <code>onSelect</code> 回调，将条目对应的索引传递出去。</p>
<pre><code class="language-scss">Widget _buildByIndex(int index) {
  bool active = index == activeIndex;
  return GestureDetector(
    onTap: () =&gt; onSelect(index),
    child: ImageOptionItem(
      option: imageOptions[index],
      active: active,
    ),
  );
}
</code></pre>
<hr/>
<p>到这里，万事俱备只欠东风，在点击木鱼样式回调中，需要更新 <code>_activeImageIndex</code> 的值即可，这里如果点击的是当前样式，则不进行更新操作。另外，在选择时通过 <code>Navigator.of(context).pop()</code> 可以关闭底部弹框。</p>
<pre><code class="language-ini">----&gt;[_MuyuPageState]----
void _onSelectImage(int value) {
  Navigator.of(context).pop();
  if(value == _activeImageIndex) return;
  setState(() {
    _activeImageIndex = value;
  });
}
</code></pre>
<p>最后，主页面中的图片和点击时增加的值需要根据 <code>_activeImageIndex</code> 来确定。这里在 <code>_MuyuPageState</code> 中给两个 <code>get</code> 方法，方便通过 <code>_activeImageIndex</code> 和 <code>imageOptions</code> 获取需要的信息：</p>
<pre><code class="language-arduino">----&gt;[_MuyuPageState]----
// 激活图像
String get activeImage =&gt; imageOptions[_activeImageIndex].src;

// 敲击是增加值
int get knockValue {
  int min = imageOptions[_activeImageIndex].min;
  int max = imageOptions[_activeImageIndex].max;
  return min + _random.nextInt(max+1 - min);
}


//...
MuyuAssetsImage(
  image: activeImage, // 使用激活图像
  onTap: _onKnock,
),

void _onKnock() {
  pool?.start();
  setState(() {
    _cruValue = knockValue; // 使用激活木鱼的值
    _counter += _cruValue;
  });
}
</code></pre>
<p>这样，就可以选择木鱼样式的功能，在敲击时每次功德的增加量也会不同。如下右图中，尊享版木鱼每次敲击，数字增加在 <code>3~6</code> 之间随机。当前代码位置 <a href="https://github.com/toly1994328/flutter_first_station/tree/3ea572974329d6daacf559e3da2e847c20393b12/lib/muyu" target="_blank">muyu</a></p>
<table>
<thead>
<tr>
<th>选择</th>
<th>切换后敲击</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="103.gif" src="assets/3c7101b2ce0a45dcbca5511d6d17eca1_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
<td><img alt="104.gif" src="assets/bbae4be605494cd4a57966f14c1697eb_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
</tr>
</tbody>
</table>
<blockquote>
<p>这里有个小问题，可以作为思考，这个问题将会在下一篇解决：
如上左图，在切换图片时，会看到 <code>功德+2</code> 的动画，这是为什么呢？ 有哪些方式可以解决这个问题。</p>
</blockquote>
<hr/>
<h4 id="3-选择音效功能">3. 选择音效功能</h4>
<p>选择音效的整体思路和上面类似，点击主界面右上角第一个按钮，从底部弹出选择界面，这里准备了三个音效以供选择。当前音效也会高亮显示，另外右侧有一个播放按钮可以试听：</p>
<table>
<thead>
<tr>
<th>主界面</th>
<th>选择音效界面</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="ceee40e6c28ae8e2385d8459ea906a4.jpg" src="assets/0f581397ec8a44d5beb6696fff11b3e9_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
<td><img alt="d8fcfc6c4429e575fd93ffb804b7ff5.jpg" src="assets/be26058f50c544898844cd9c7a3ef844_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
</tr>
</tbody>
</table>
<hr/>
<p>首先还是对数据进行一下封装，对于音频选择界面而言，两个信息数据： <code>名称</code> 和 <code>资源</code>。这里通过 <code>AudioOption</code> 类进行</p>
<pre><code class="language-arduino">---&gt;[muyu/models/audio_option.dart]---
class AudioOption{
  final String name;
  final String src;

  const AudioOption(this.name, this.src);
}
</code></pre>
<p>在 <code>_MuyuPageState</code> 中，通过 <code>audioOptions</code> 列表记录音频选项对应的数据；<code>_activeAudioIndex</code> 表示当前激活的音频索引：</p>
<pre><code class="language-ini">----&gt;[_MuyuPageState]----
final List&lt;AudioOption&gt; audioOptions = const [
  AudioOption('音效1', 'muyu_1.mp3'),
  AudioOption('音效2', 'muyu_2.mp3'),
  AudioOption('音效3', 'muyu_3.mp3'),
];

int _activeAudioIndex = 0;
</code></pre>
<p>如何同样，在点击按钮时，通过 <code>showCupertinoModalPopup</code> 弹出底部栏，使用 <code>AudioOptionPanel</code> 构建展示内容：</p>
<pre><code class="language-php">----&gt;[_MuyuPageState]----
void _onTapSwitchAudio() {
  showCupertinoModalPopup(
    context: context,
    builder: (BuildContext context) {
      return AudioOptionPanel(
        audioOptions: audioOptions,
        activeIndex: _activeAudioIndex,
        onSelect: _onSelectAudio,
      );
    },
  );
}
</code></pre>
<hr/>
<p>目前只有三个数据，这里通过 <code>Column</code> 竖直排放即可，如果你想支持更多的选项，可以使用滑动列表(下篇介绍)。 另外，对于条目而言，Flutter 提供了一些通用的结构，比如这里可以使用 <code>ListTile</code> 组件，来构建左中右的视图。</p>
<p><img alt="image.png" src="assets/a20cf429c4a84854a659a77f4028eddd_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p><code>AudioOptionPanel</code> 界面构建逻辑如下，其中提供 <code>List.generate</code> 构造函数生成条目组件列表；每个条目由 <code>_buildByIndex</code> 方法根据 <code>index</code> 索引进行构建；构建的内容使用 <code>ListTile</code> 根据 <code>AudioOption</code> 数据进行展示。</p>
<blockquote>
<p>注: 这里 listA = [1,2,…listB] 表示在创建 listA 的过程中，将 listB 列表元素嵌入其中。</p>
</blockquote>
<pre><code class="language-php">---&gt;[muyu/options/select_audio.dart]---
class AudioOptionPanel extends StatelessWidget {
  final List&lt;AudioOption&gt; audioOptions;
  final ValueChanged&lt;int&gt; onSelect;
  final int activeIndex;

  const AudioOptionPanel({
    Key? key,
    required this.audioOptions,
    required this.activeIndex,
    required this.onSelect,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    const TextStyle labelStyle = TextStyle(fontSize: 16, fontWeight: FontWeight.bold);
    return Material(
      child: SizedBox(
        height: 300,
        child: Column(
          children: [
            Container(
                height: 46,
                alignment: Alignment.center,
                child: const Text("选择音效", style: labelStyle, )),
            ...List.generate(audioOptions.length, _buildByIndex)
          ],
        ),
      ),
    );
  }

  Widget _buildByIndex(int index) {
    bool active = index == activeIndex;
    return ListTile(
      selected: active,
      onTap: () =&gt; onSelect(index),
      title: Text(audioOptions[index].name),
      trailing: IconButton(
        splashRadius: 20,
        onPressed: ()=&gt; _tempPlay(audioOptions[index].src),
        icon: const Icon(
          Icons.record_voice_over_rounded,
          color: Colors.blue,
        ),
      ),
    );
  }

  void _tempPlay(String src) async{
    AudioPool pool = await FlameAudio.createPool(src, maxPlayers: 1);
    pool.start();
  }
}
</code></pre>
<hr/>
<p>最后，在 <code>_MuyuPageState</code> 中，选择音频回调时，根据激活索引，更新 <code>pool</code> 对象即可。这样在点击时就可以播放对应的音效。</p>
<pre><code class="language-ini">----&gt;[_MuyuPageState]----
String get activeAudio =&gt; audioOptions[_activeAudioIndex].src;

void _onSelectAudio(int value) async{
  Navigator.of(context).pop();
  if (value == _activeAudioIndex) return;
  _activeAudioIndex = value;
  pool = await FlameAudio.createPool(
    activeAudio,
    maxPlayers: 1,
  );
}
</code></pre>
<hr/>
<h4 id="4-本章小结">4.本章小结</h4>
<p>本章通过弹出框展示切换音效和木鱼样式，可以进一步理解数据和界面视图之间的关系：数据为界面提供内容信息、界面交互操作更改数据信息。</p>
<p>另外，两个选项的面板通过自定义组件进行封装隔离，面板在需要的数据通过构造函数传入、界面中的事件通过回调函数交由外界执行更新数据逻辑。也就是说，封装的 Widget 在意的是如何构建展示内容，专注于做一件事，与界面构建无关的任务，交由使用者处理。</p>
<p>到这里，本篇新增的两个功能就完成了，当前代码位置 <a href="https://github.com/toly1994328/flutter_first_station/tree/1893c43a9f1d4bbfec37c51a0afdd01439a899e6/lib/muyu" target="_blank">muyu</a> 。目前为止，木鱼项目的代码已经有一点点复杂了，大家可以结合源码，好好消化一下。下一篇将继续对木鱼项目进行功能拓展，并以此学习一下滑动列表。</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#046868683d3035353433446369656d682a676b69" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</hr></div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9359ee584adad6ec',t:'MTc0NTU0MzExNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>