<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="25 网络数据的访问" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>25 网络数据的访问 </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/01%20%e5%89%8d%e8%a8%80-%e6%95%99%e7%a8%8b%e5%86%85%e5%ae%b9%e5%af%bc%e8%af%bb.md.html" id="01 前言-教程内容导读.md.html">01 前言-教程内容导读.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/02%20Flutter%20%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e7%9a%84%e6%90%ad%e5%bb%ba.md.html" id="02 Flutter 开发环境的搭建.md.html">02 Flutter 开发环境的搭建.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/03%20%e6%96%b0%e6%89%8b%e6%9d%91%e5%9f%ba%e7%a1%80%20Dart%20%e8%af%ad%e6%b3%95%20%28%e4%b8%8a%29.md.html" id="03 新手村基础 Dart 语法 (上).md.html">03 新手村基础 Dart 语法 (上).md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/04%20%e6%96%b0%e6%89%8b%e6%9d%91%e5%9f%ba%e7%a1%80%20Dart%20%e8%af%ad%e6%b3%95%20%28%e4%b8%8b%29.md.html" id="04 新手村基础 Dart 语法 (下).md.html">04 新手村基础 Dart 语法 (下).md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/05%20Flutter%20%e8%ae%a1%e6%95%b0%e5%99%a8%e9%a1%b9%e7%9b%ae%e8%a7%a3%e8%af%bb.md.html" id="05 Flutter 计数器项目解读.md.html">05 Flutter 计数器项目解读.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/06%20%e7%8c%9c%e6%95%b0%e5%ad%97%e7%95%8c%e9%9d%a2%e4%ba%a4%e4%ba%92%e4%b8%8e%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90.md.html" id="06 猜数字界面交互与需求分析.md.html">06 猜数字界面交互与需求分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/07%20%e4%bd%bf%e7%94%a8%e7%bb%84%e4%bb%b6%e6%9e%84%e5%bb%ba%e9%9d%99%e6%80%81%e7%95%8c%e9%9d%a2.md.html" id="07 使用组件构建静态界面.md.html">07 使用组件构建静态界面.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/08%20%e7%8a%b6%e6%80%81%e6%95%b0%e6%8d%ae%e4%b8%8e%e7%95%8c%e9%9d%a2%e6%9b%b4%e6%96%b0.md.html" id="08 状态数据与界面更新.md.html">08 状态数据与界面更新.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/09%20%e6%a0%a1%e9%aa%8c%e7%bb%93%e6%9e%9c%e4%b8%8e%e6%8f%90%e7%a4%ba%e4%bf%a1%e6%81%af.md.html" id="09 校验结果与提示信息.md.html">09 校验结果与提示信息.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/10%20%e5%8a%a8%e7%94%bb%e4%bd%bf%e7%94%a8%e4%b8%8e%e7%8a%b6%e6%80%81%e5%91%a8%e6%9c%9f.md.html" id="10 动画使用与状态周期.md.html">10 动画使用与状态周期.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/11%20%e7%8c%9c%e6%95%b0%e5%ad%97%e6%95%b4%e7%90%86%e4%b8%8e%e6%80%bb%e7%bb%93.md.html" id="11 猜数字整理与总结.md.html">11 猜数字整理与总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/12%20%e7%94%b5%e5%ad%90%e6%9c%a8%e9%b1%bc%e7%95%8c%e9%9d%a2%e4%ba%a4%e4%ba%92%e4%b8%8e%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90.md.html" id="12 电子木鱼界面交互与需求分析.md.html">12 电子木鱼界面交互与需求分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/13%20%e7%94%b5%e5%ad%90%e6%9c%a8%e9%b1%bc%e9%9d%99%e6%80%81%e7%95%8c%e9%9d%a2%e6%9e%84%e5%bb%ba.md.html" id="13 电子木鱼静态界面构建.md.html">13 电子木鱼静态界面构建.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/14%20%e8%ae%a1%e6%95%b0%e5%8f%98%e5%8c%96%e4%b8%8e%e9%9f%b3%e6%95%88%e6%92%ad%e6%94%be.md.html" id="14 计数变化与音效播放.md.html">14 计数变化与音效播放.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/15%20%e5%bc%b9%e5%87%ba%e9%80%89%e9%a1%b9%e4%b8%8e%e5%88%87%e6%8d%a2%e7%8a%b6%e6%80%81.md.html" id="15 弹出选项与切换状态.md.html">15 弹出选项与切换状态.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/16%20%e7%94%a8%e6%bb%91%e5%8a%a8%e5%88%97%e8%a1%a8%e5%b1%95%e7%a4%ba%e8%ae%b0%e5%bd%95.md.html" id="16 用滑动列表展示记录.md.html">16 用滑动列表展示记录.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/17%20%e7%94%b5%e5%ad%90%e6%9c%a8%e9%b1%bc%e6%95%b4%e7%90%86%e4%b8%8e%e6%80%bb%e7%bb%93.md.html" id="17 电子木鱼整理与总结.md.html">17 电子木鱼整理与总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/18%20%e7%99%bd%e6%9d%bf%e7%bb%98%e5%88%b6%e7%95%8c%e9%9d%a2%e4%ba%a4%e4%ba%92%e4%b8%8e%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90.md.html" id="18 白板绘制界面交互与需求分析.md.html">18 白板绘制界面交互与需求分析.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/19%20%e8%ae%a4%e8%af%86%e8%87%aa%e5%ae%9a%e4%b9%89%e7%bb%98%e5%88%b6%e7%bb%84%e4%bb%b6.md.html" id="19 认识自定义绘制组件.md.html">19 认识自定义绘制组件.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/20%20%e9%80%9a%e8%bf%87%e6%89%8b%e5%8a%bf%e5%9c%a8%e7%99%bd%e6%9d%bf%e4%b8%8a%e7%bb%98%e5%88%b6.md.html" id="20 通过手势在白板上绘制.md.html">20 通过手势在白板上绘制.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/21%20%e7%99%bd%e6%9d%bf%e7%94%bb%e7%ac%94%e7%9a%84%e5%8f%82%e6%95%b0%e8%ae%be%e7%bd%ae.md.html" id="21 白板画笔的参数设置.md.html">21 白板画笔的参数设置.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/22%20%e6%92%a4%e9%94%80%e5%8a%9f%e8%83%bd%e4%b8%8e%e7%94%bb%e6%9d%bf%e4%bc%98%e5%8c%96.md.html" id="22 撤销功能与画板优化.md.html">22 撤销功能与画板优化.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/23%20%e5%ba%94%e7%94%a8%e7%95%8c%e9%9d%a2%e6%95%b4%e5%90%88.md.html" id="23 应用界面整合.md.html">23 应用界面整合.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/24%20%e6%95%b0%e6%8d%ae%e7%9a%84%e6%8c%81%e4%b9%85%e5%8c%96%e5%ad%98%e5%82%a8.md.html" id="24 数据的持久化存储.md.html">24 数据的持久化存储.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/25%20%e7%bd%91%e7%bb%9c%e6%95%b0%e6%8d%ae%e7%9a%84%e8%ae%bf%e9%97%ae.md.html" id="25 网络数据的访问.md.html">25 网络数据的访问.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Flutter%e5%85%a5%e9%97%a8%e6%95%99%e7%a8%8b/26%20%e6%95%99%e7%a8%8b%e6%80%bb%e7%bb%93%e4%b8%8e%e5%b1%95%e6%9c%9b.md.html" id="26 教程总结与展望.md.html">26 教程总结与展望.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="25 网络数据的访问" id="title">25 网络数据的访问</h1>
<div><h4 id="一-需求介绍和准备工作">一、需求介绍和准备工作</h4>
<p>上一章介绍了本地数据的持久化，它可以让应用退出后，仍可以在启动后通过读取数据，恢复状态数据。但如果手机丢了，或者本地数据被不小心清空了，应用就又会 <code>"失忆"</code> 。</p>
<h5 id="1-本章目的">1. 本章目的</h5>
<p>现在移动互联网已经极度成熟了，将数据存储在远程的服务器中，通过网络来访问、操作数据对于现在的人已经是家常便饭了。比如微信应用中的聊天记录、支付宝应用中的余额、美团应用中的店铺信息、游戏里的资源装备、抖音里的视频评论… 现在的网络数据已经无处不在了。所以对于应用开发者来说，网络请求的技能是必不可少的。</p>
<p>但是学习网络请求有个很大的问题，一般的网络接口都是肯定不会暴露给大众使用，而自己想要搭建一个后端提供网络接口又很麻烦。所以一般会使用开放 api ，我曾建议过掘金提供一套开放 api , 以便写网络相关的教程，但目前还没什么动静。这里就选用 wanandroid 的开发 api 接口来进行测试。</p>
<p>本章目的是完成一个简单的应用场景：从网络中加载文章列表数据，展示在界面中。点击条目时，可以跳转到详情页，并通过 WebView 展示网页。</p>
<table>
<thead>
<tr>
<th>文章列表</th>
<th>文章详情</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="3cce89fcfb694c872a91562898b9550.jpg" src="assets/ef49256e374e4b069ec913cffd3e7225_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
<td><img alt="a932c4a6694a9b2367b628ef32152af.jpg" src="assets/080c7aa086a2432b9935f29ae8a7d637_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
</tr>
</tbody>
</table>
<hr/>
<h5 id="2-界面准备">2. 界面准备</h5>
<p>现在想在底部栏添加一个网络文章的按钮，点击时切换到网络请求测试的界面。只需要在 <code>_AppNavigationState</code> 的 menus 增加一个 MenuData ：</p>
<p><img alt="image.png" src="assets/ae533b4ad59a4552b06939fa8495b874_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>然后在 PageView 内增加一个 NetArticlePage 组件，用于展示网络文章的测试界面：</p>
<p><img alt="image.png" src="assets/0a24d5ab803447dc828238c65af3f1da_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>新建一个 net_article 的文件夹用于盛放网络文章的相关代码，其中：</p>
<ul>
<li>views 文件夹盛放组件视图相关的文件，比如主页面、详情页等。</li>
<li>model 文件夹用于盛放数据模型，比如文章数据的封装类。</li>
<li>api 文件夹盛放网络数据请求的代码，在功能上相当于上一章的 storage , 负责读取和写入数据。只不过对于网络数据再说，是存储在服务器上的，需要提供接口来操作。</li>
</ul>
<p><img alt="image.png" src="assets/7a84d2f37db24d0e88ea1633b61d728f_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>NetArticlePage 组件现在先准备一下：通过 Scaffold 构建界面结构，由于之前已经提供了 AppBar 的主题，这里直接给个 title 即可，其他配置信息会默认跟随主题。接下来最重要的任务就是对 body 主体内容的构建。</p>
<pre><code class="language-dart">class NetArticlePage extends StatelessWidget {
  const NetArticlePage({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('网络请求测试'),
      ),
      body: Container(),
    );
  }
}
</code></pre>
<hr/>
<h5 id="3-接口介绍">3. 接口介绍</h5>
<p>这里只使用一个获取文章列表的如下接口，其中 0 是个可以改变的参数，表示文章的页数：</p>
<blockquote>
<p><a href="https://www.wanandroid.com/article/list/0/json" target="_blank">www.wanandroid.com/article/lis…</a></p>
</blockquote>
<p>通过浏览器可以直接看到接口提供的 json 数据：</p>
<p><img alt="image.png" src="assets/2e4216e6e2cc4355b40f509fbcd38f51_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>使用 json 美化工具可以看出如下的结构，主要的文章列表数据在 <code>data["datas"]</code> 中 :</p>
<p><img alt="image.png" src="assets/dc5582eee95c419383270bbeba41972a_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>每条记录的数据如下，其中数据有很多，不过没有必要全都使用。这里展示文章信息，只需要标题 title 、地址 link 、 时间 niceDate 即可。</p>
<pre><code class="language-json">{
  "adminAdd": false,
  "apkLink": "",
  "audit": 1,
  "author": "",
  "canEdit": false,
  "chapterId": 502,
  "chapterName": "自助",
  "collect": false,
  "courseId": 13,
  "desc": "",
  "descMd": "",
  "envelopePic": "",
  "fresh": true,
  "host": "",
  "id": 26411,
  "isAdminAdd": false,
  "link": "https://juejin.cn/post/7233067863500849209",
  "niceDate": "7小时前",
  "niceShareDate": "7小时前",
  "origin": "",
  "prefix": "",
  "projectLink": "",
  "publishTime": 1684220135000,
  "realSuperChapterId": 493,
  "route": false,
  "selfVisible": 0,
  "shareDate": 1684220135000,
  "shareUser": "张风捷特烈",
  "superChapterId": 494,
  "superChapterName": "广场Tab",
  "tags": [],
  "title": "Dart 3.0 语法新特性 | Records 记录类型 (元组)",
  "type": 0,
  "userId": 31634,
  "visible": 1,
  "zan": 0
}
</code></pre>
<hr/>
<h5 id="4-数据模型的封装">4.数据模型的封装</h5>
<p>这样，可以写出如下的 Article 类承载数据，并通过一个 formMap 构造通过 map 数据构造 Article 对象。</p>
<pre><code class="language-dart">class Article {
  final String title;
  final String url;
  final String time;

  const Article({
    required this.title,
    required this.time,
    required this.url,
  });

  factory Article.formMap(dynamic map) {
    return Article(
      title: map['title'] ?? '未知',
      url: map['link'] ?? '',
      time: map['niceDate'] ?? '',
    );
  }

  @override
  String toString() {
    return 'Article{title: $title, url: $url, time: $time}';
  }
}
</code></pre>
<hr/>
<h4 id="二-基础功能的实现">二、基础功能的实现</h4>
<p>俗话说巧妇难为无米之炊，如果说界面是一碗摆在台面上的饭，那数据就是生米，把生米煮成熟饭就是组件构建的过程。所以实现基础功能有两大步骤： 获取数据、构建界面。</p>
<h5 id="1-网络数据的请求">1. 网络数据的请求</h5>
<p>网络请求是非常通用的能力，开发者自己来写非常复杂，所以一般使用三方的依赖库。对于 Flutter 网络请求来说，最受欢迎的是 <a href="https://pub.flutter-io.cn/packages/dio" target="_blank">dio</a> , 使用前先添加依赖：</p>
<pre><code class="language-yaml">dependencies:
  ...
  dio: ^5.1.2
</code></pre>
<p><img alt="image.png" src="assets/47fe6fbd315e4362b0aa8bafe6581c8c_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<hr/>
<p>下面看一下最简单的使用，如下在 <code>ArticleApi</code> 中持有 <code>Dio</code> 类型的 <code>_client</code> 对象，构造时可以设置 baseUrl 。然后提供 loadArticles 方法，用于加载第 page 页的数据，其中的逻辑处理，就是加载网络数据的核心。</p>
<p>使用起来也很方便，提供 <code>Dio#get</code> 方法就可以异步获取数据，得到之后，从结果中拿到自己想要的数据，生成 Article 列表即可。</p>
<pre><code class="language-ini">class ArticleApi{

  static const String kBaseUrl = 'https://www.wanandroid.com';

  final Dio _client = Dio(BaseOptions(baseUrl: kBaseUrl));
  
  Future&lt;List&lt;Article&gt;&gt; loadArticles(int page) async {
    String path = '/article/list/$page/json';
    var rep = await _client.get(path);
    if (rep.statusCode == 200) {
      if(rep.data!=null){
        var data = rep.data['data']['datas'] as List;
        return data.map(Article.formMap).toList();
      }
    }
    return [];
  }
}
</code></pre>
<hr/>
<h5 id="2-文章内容界面展示">2. 文章内容界面展示</h5>
<p>这里单独创建一个 ArticleContent 组件负责展示主题内容，由于需要加载网络数据，加载成功后要更新界面，使用需要使用状态类来维护数据。所以让它继承自 StatefulWidget ：</p>
<pre><code class="language-dart">class ArticleContent extends StatefulWidget {
  const ArticleContent({Key? key}) : super(key: key);

  @override
  State&lt;ArticleContent&gt; createState() =&gt; _ArticleContentState();
}
</code></pre>
<p>对于状态类来说，最重要数据是 Article 列表，build 构建逻辑中通过 <code>ListView</code> 展示可滑动列表，其中构建条目时依赖列表中的数据：</p>
<pre><code class="language-dart">class _ArticleContentState extends State&lt;ArticleContent&gt; {
  List&lt;Article&gt; _articles = [];

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemExtent: 80,
      itemCount: _articles.length,
      itemBuilder: _buildItemByIndex,
    );
  }

  Widget _buildItemByIndex(BuildContext context, int index) {
    return ArticleItem(
      article: _articles[index],
      onTap: _jumpToPage,
    );
  }
}
</code></pre>
<p>另外这里单独封装了 <code>ArticleItem</code> 组件展示条目的单体，效果如下，大家可以自己处理一下，这里就不放代码了，处理不好的话可以参考源码。</p>
<p><img alt="image.png" src="assets/d38dc19a288e4d0bbcc6a7af20f85814_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>最后只要在 <code>initState</code> 回调中通过 ArticleApi 加载网络数据即可，加载完成后通过 setState 更新界面：</p>
<pre><code class="language-scss">  ArticleApi api = ArticleApi();

  @override
  void initState() {
    super.initState();
    _loadData();
  }

  void _loadData() async{
    _articles = await api.loadArticles(0);
    setState(() {

    });
  }
</code></pre>
<p>到这里，最基础版的网络请求数据，进行界面展示的功能就完成了。当然现在的代码还存在很大的问题，下面将逐步进行优化。</p>
<table>
<tbody>
<tr>
<td>————————————————————</td>
<td>————————————————————</td>
</tr>
<tr>
<td><img alt="6aac3aaccff127ace5793f2e27b8e89.jpg" src="assets/3452b972c29946f7bd46c820398f2abb_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
<td><img alt="bd5f937ab1874b8470673985f344ece.jpg" src="assets/d03dc70272104ad0955c55ac80afa468_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
</tr>
</tbody>
</table>
<hr/>
<h5 id="3-在应用中展示-web-界面">3. 在应用中展示 Web 界面</h5>
<p>文章数据中有一个链接地址，可以通过 WebView 来展示内容。同样也是使用三方的依赖库 <a href="https://pub.flutter-io.cn/packages/webview_flutter" target="_blank">webview_flutter</a> 。 使用前先添加依赖：</p>
<pre><code class="language-yaml">dependencies:
  ...
  webview_flutter: ^4.2.0
</code></pre>
<p><img alt="image.png" src="assets/7968ea17055c4e609a9c1a89a72f4c2d_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<hr/>
<p>使用起来来非常简单，创建 <code>WebViewController</code> 请求地址，然后使用 <code>WebViewWidget</code> 组件展示即可：</p>
<pre><code class="language-scala">class ArticleDetailPage extends StatefulWidget {
  final Article article;

  const ArticleDetailPage({Key? key, required this.article}) : super(key: key);

  @override
  State&lt;ArticleDetailPage&gt; createState() =&gt; _ArticleDetailPageState();
}

class _ArticleDetailPageState extends State&lt;ArticleDetailPage&gt; {
  late WebViewController controller;
  @override
  void initState() {
    super.initState();
    controller = WebViewController()
      ..setJavaScriptMode(JavaScriptMode.unrestricted)
      ..setBackgroundColor(const Color(0x00000000))
      ..loadRequest(Uri.parse(widget.article.url));
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(widget.article.title)),
      body: WebViewWidget(controller: controller),
    );
  }
}
</code></pre>
<p>最后，在列表界面点击时挑战到 ArticleDetailPage 即可。这样就完成了 Web 界面在应用中的展示，当前代码位置 <a href="https://github.com/toly1994328/flutter_first_station/tree/5c706fb9ae706d90a0227a99a0182f4d19ee654b/lib/net_article" target="_blank">net_article</a>：</p>
<pre><code class="language-scss">void _jumpToPage(Article article) {
  Navigator.of(context).push(
    MaterialPageRoute(
      builder: (_) =&gt; ArticleDetailPage(article: article),
    ),
  );
}
</code></pre>
<table>
<thead>
<tr>
<th>文章1</th>
<th>文章2</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="ed10737fbd6f011e5b9b764f22d7d36.jpg" src="assets/ffea4eb4207a46c5872dc6b6fdc600bc_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
<td><img alt="88be66a172eb0ea8e8f37f05ee8360d.jpg" src="assets/4eb457bc557f48d18ad2e8ebb3a363fc_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="三-功能优化">三、功能优化</h4>
<p>现在有三个值得优化的地方：</p>
<ul>
<li>网络加载数据的过程比较慢，加载成功之前文章列表是空的，界面展示空白页体验不好。可以在加载过程中展示 loading 界面。</li>
<li>当前加载数据完后，无法在重新加载，可以增加下拉刷新功能。</li>
<li>现在只能加载一页数据，可以在滑动到底部，加载下一页内容，也就是加载更多的功能。</li>
</ul>
<hr/>
<h5 id="1-增加-loading-状态">1. 增加 loading 状态</h5>
<p>如下左图在网络上请求时没有任何处理，会有有一段时间的白页；如右图所示，在加载过程中给出一些界面示意，在体验上会好很多。</p>
<table>
<thead>
<tr>
<th>无 loading 状态</th>
<th>有 loading 状态</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="120.gif" src="assets/2249a05115bf42ebb1855675cd146e97_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
<td><img alt="119.gif" src="assets/247b6e14da7040faa4870e6c7961c2c1_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></td>
</tr>
</tbody>
</table>
<p>其实处理起来也并不复杂，由于界面需要感知加载中的状态，示意需要增加一个状态数据用于控制。比如这里在状态类中提供 <code>_loading</code> 的布尔值来表示，该值的维修事件也很明确：加载数据前置为 true 、加载完后置为 false 。</p>
<pre><code class="language-ini">bool _loading = false;

void _loadData() async {
  _loading = true;
  setState(() {});
  _articles = await api.loadArticles(0);
  _loading = false;
  setState(() {});
}
</code></pre>
<hr/>
<p>上面是状态数据的逻辑处理，下面来看一下界面构建逻辑。只要在 <code>_loading</code> 为 true 时，返回加载中对应的组件即可。如果加载中的界面比较复杂，或想要在其他地方复用，也可以单独封装成一个组件来维护。</p>
<pre><code class="language-dart">@override
Widget build(BuildContext context) {
  if(_loading){
    return Center(
      child: Wrap(
        spacing: 10,
        direction: Axis.vertical,
        crossAxisAlignment: WrapCrossAlignment.center,
        children: const [
          CupertinoActivityIndicator(),
          Text("数据加载中，请稍后...",style: TextStyle(color: Colors.grey),)
        ],
      ),
    );
  }
  return ListView.builder(
    itemExtent: 80,
    itemCount: _articles.length,
    itemBuilder: _buildItemByIndex,
  );
}
</code></pre>
<p>这样，就完成了展示界面加载中的功能，当前代码位置 <a href="https://github.com/toly1994328/flutter_first_station/blob/5ee33527b1d8fa62e56ec8ed17403fef4e433ead/lib/net_article/views/article_content.dart" target="_blank">article_content.dart</a>。</p>
<hr/>
<h5 id="2-下拉刷新功能">2. 下拉刷新功能</h5>
<p>如下所示，在列表下拉时，头部只可以展示加载的信息，这种效果组件手写起来非常麻烦。</p>
<p><img alt="121.gif" src="assets/e752983876b24ddc936ab3c3b99595a1_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>这是一个通用的功能，好在我们可以依赖别人的代码，使用三方库来实现，这里用的是 <a href="https://pub.flutter-io.cn/packages/easy_refresh" target="_blank">easy_refresh</a>。使用前先添加依赖：</p>
<pre><code class="language-yaml">dependencies:
  ...
  easy_refresh: ^3.3.1+2
</code></pre>
<p><img alt="image.png" src="assets/3c813ea48ab74a3f929e7251d6e61b89_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<hr/>
<p>使用方式也非常简单，将 <code>EasyRefresh</code> 组件套在 <code>ListView</code> 上即可。在 header 中可以放入头部的配置信息，通过 onRefresh 参数设置下拉刷新的回调，也就是从网络加载数据，成功后更新界面。</p>
<p><img alt="image.png" src="assets/c15de5c24f124ecda1f54f9636d7d828_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<hr/>
<h5 id="3-加载更多功能">3. 加载更多功能</h5>
<p>上面只能展示一页的数据，如果需要展示多页怎么办? 一般来说应用在滑动到底部会加载更多，如下所示：</p>
<p><img alt="122.gif" src="assets/0f0ff762d0784a2c8f0c9249d7b4b93d_tplv-k3u1fbpfcp-jj-mark_1890_0_0_0_q75.awebp"/></p>
<p>实现起来也非常简单 EasyRefresh 的 onLoad 参数设置下拉回调，加载下一页数据，并加入 <code>_articles</code> 数据中即可。这里一页数据有 20 条，下一页也就是 <code>_articles.length ~/ 20</code> :</p>
<pre><code class="language-dart">void _onLoad() async{
    int nextPage = _articles.length ~/ 20;
    List&lt;Article&gt; newArticles = await api.loadArticles(nextPage);
    _articles = _articles + newArticles;
    setState(() {});
}
</code></pre>
<hr/>
<h4 id="四-本章小结">四、本章小结</h4>
<p>本章主要介绍了如何访问网络数据，实现了文章列表的展示，以及通过 WebView 在应用中展示网页内容，完成简单的文章查看功能。并且基于插件实现了下拉刷新、加载更多的功能。</p>
<p>到这里一个最基本的网络文章数据的展示就实现完成了, 当前代码位置 <a href="https://github.com/toly1994328/flutter_first_station/blob/2f025c5a2e89f9a08de5296427b4ce9058c610b8/lib/net_article/views/article_content.dart" target="_blank">article_content</a>。也标志着本系列教程进入了尾声，还有很多值得优化的地方，希望大家再以后的路途中可以自己思考和处理。</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#cea2a2a2f7fafffffef98ea9a3afa7a2e0ada1a3" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</hr></div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9359ef7b9d74080e',t:'MTc0NTU0MzE2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>