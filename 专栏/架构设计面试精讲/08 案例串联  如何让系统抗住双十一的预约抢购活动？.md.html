<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="08 案例串联  如何让系统抗住双十一的预约抢购活动？" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>08 案例串联  如何让系统抗住双十一的预约抢购活动？ </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%20%e4%b8%ad%e9%ab%98%e7%ba%a7%e7%a0%94%e5%8f%91%e9%9d%a2%e8%af%95%ef%bc%8c%e9%80%83%e4%b8%8d%e5%bc%80%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e8%bf%99%e4%b8%80%e7%8e%af.md.html" id="00 开篇词  中高级研发面试，逃不开架构设计这一环.md.html">00 开篇词  中高级研发面试，逃不开架构设计这一环.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/01%20%20%e7%a0%94%e5%8f%91%e5%b7%a5%e7%a8%8b%e5%b8%88%e6%83%b3%e6%8f%90%e5%8d%87%e9%9d%a2%e8%af%95%e7%ab%9e%e4%ba%89%e5%8a%9b%ef%bc%8c%e8%af%a5%e5%85%b7%e5%a4%87%e8%bf%99%e4%b8%89%e4%b8%aa%e6%8a%80%e6%9c%af%e8%ae%a4%e7%9f%a5.md.html" id="01  研发工程师想提升面试竞争力，该具备这三个技术认知.md.html">01  研发工程师想提升面试竞争力，该具备这三个技术认知.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/02%20%20%e7%a0%94%e5%8f%91%e5%b7%a5%e7%a8%8b%e5%b8%88%e5%a6%82%e4%bd%95%e7%94%a8%e6%9e%b6%e6%9e%84%e5%b8%88%e8%a7%86%e8%a7%92%e5%9b%9e%e7%ad%94%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e6%96%b9%e6%a1%88%ef%bc%9f.md.html" id="02  研发工程师如何用架构师视角回答架构设计方案？.md.html">02  研发工程师如何用架构师视角回答架构设计方案？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/03%20%20%e9%9d%a2%e8%af%95%e5%ae%98%e5%a6%82%e4%bd%95%e8%80%83%e5%af%9f%e4%b8%8e%20CAP%20%e6%9c%89%e5%85%b3%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e7%90%86%e8%ae%ba%ef%bc%9f.md.html" id="03  面试官如何考察与 CAP 有关的分布式理论？.md.html">03  面试官如何考察与 CAP 有关的分布式理论？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/04%20%20%e4%ba%bf%e7%ba%a7%e5%95%86%e5%93%81%e5%ad%98%e5%82%a8%e4%b8%8b%ef%bc%8c%e5%a6%82%e4%bd%95%e6%b7%b1%e5%ba%a6%e5%9b%9e%e7%ad%94%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%8e%9f%e7%90%86%e6%80%a7%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="04  亿级商品存储下，如何深度回答分布式系统的原理性问题？.md.html">04  亿级商品存储下，如何深度回答分布式系统的原理性问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/05%20%20%e6%b5%b7%e9%87%8f%e5%b9%b6%e5%8f%91%e5%9c%ba%e6%99%af%e4%b8%8b%ef%bc%8c%e5%a6%82%e4%bd%95%e5%9b%9e%e7%ad%94%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e4%b8%80%e8%87%b4%e6%80%a7%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="05  海量并发场景下，如何回答分布式事务一致性问题？.md.html">05  海量并发场景下，如何回答分布式事务一致性问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/06%20%20%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e4%b8%ad%ef%bc%8c%e5%a6%82%e4%bd%95%e5%9b%9e%e7%ad%94%e9%94%81%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%ef%bc%9f.md.html" id="06  分布式系统中，如何回答锁的实现原理？.md.html">06  分布式系统中，如何回答锁的实现原理？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/07%20%20RPC%ef%bc%9a%e5%a6%82%e4%bd%95%e5%9c%a8%e9%9d%a2%e8%af%95%e4%b8%ad%e5%b1%95%e7%8e%b0%e5%87%ba%e2%80%9c%e9%80%a0%e8%bd%ae%e5%ad%90%e2%80%9d%e7%9a%84%e8%83%bd%e5%8a%9b%ef%bc%9f.md.html" id="07  RPC：如何在面试中展现出“造轮子”的能力？.md.html">07  RPC：如何在面试中展现出“造轮子”的能力？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/08%20%20MQ%ef%bc%9a%e5%a6%82%e4%bd%95%e5%9b%9e%e7%ad%94%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e7%9a%84%e4%b8%a2%e5%a4%b1%e3%80%81%e9%87%8d%e5%a4%8d%e4%b8%8e%e7%a7%af%e5%8e%8b%e9%97%ae%e9%a2%98.md.html" id="08  MQ：如何回答消息队列的丢失、重复与积压问题.md.html">08  MQ：如何回答消息队列的丢失、重复与积压问题.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/08%20%e6%a1%88%e4%be%8b%e4%b8%b2%e8%81%94%20%20%e5%a6%82%e4%bd%95%e8%ae%a9%e7%b3%bb%e7%bb%9f%e6%8a%97%e4%bd%8f%e5%8f%8c%e5%8d%81%e4%b8%80%e7%9a%84%e9%a2%84%e7%ba%a6%e6%8a%a2%e8%b4%ad%e6%b4%bb%e5%8a%a8%ef%bc%9f.md.html" id="08 案例串联  如何让系统抗住双十一的预约抢购活动？.md.html">08 案例串联  如何让系统抗住双十一的预约抢购活动？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/09%20%20%e5%a6%82%e4%bd%95%e5%9b%9e%e7%ad%94%20MySQL%20%e7%9a%84%e7%b4%a2%e5%bc%95%e5%8e%9f%e7%90%86%e4%b8%8e%e4%bc%98%e5%8c%96%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="09  如何回答 MySQL 的索引原理与优化问题？.md.html">09  如何回答 MySQL 的索引原理与优化问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/10%20%20%e5%a6%82%e4%bd%95%e5%9b%9e%e7%ad%94%20MySQL%20%e7%9a%84%e4%ba%8b%e5%8a%a1%e9%9a%94%e7%a6%bb%e7%ba%a7%e5%88%ab%e5%92%8c%e9%94%81%e7%9a%84%e6%9c%ba%e5%88%b6%ef%bc%9f.md.html" id="10  如何回答 MySQL 的事务隔离级别和锁的机制？.md.html">10  如何回答 MySQL 的事务隔离级别和锁的机制？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/11%20%20%e8%af%bb%e5%a4%9a%e5%86%99%e5%b0%91%ef%bc%9aMySQL%20%e5%a6%82%e4%bd%95%e4%bc%98%e5%8c%96%e6%95%b0%e6%8d%ae%e6%9f%a5%e8%af%a2%e6%96%b9%e6%a1%88%ef%bc%9f.md.html" id="11  读多写少：MySQL 如何优化数据查询方案？.md.html">11  读多写少：MySQL 如何优化数据查询方案？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/12%20%20%e5%86%99%e5%a4%9a%e8%af%bb%e5%b0%91%ef%bc%9aMySQL%20%e5%a6%82%e4%bd%95%e4%bc%98%e5%8c%96%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8%e6%96%b9%e6%a1%88%ef%bc%9f.md.html" id="12  写多读少：MySQL 如何优化数据存储方案？.md.html">12  写多读少：MySQL 如何优化数据存储方案？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/13%20%20%e7%bc%93%e5%ad%98%e5%8e%9f%e7%90%86%ef%bc%9a%e5%ba%94%e5%af%b9%e9%9d%a2%e8%af%95%e4%bd%a0%e8%a6%81%e6%8e%8c%e6%8f%a1%20Redis%20%e5%93%aa%e4%ba%9b%e5%8e%9f%e7%90%86%ef%bc%9f.md.html" id="13  缓存原理：应对面试你要掌握 Redis 哪些原理？.md.html">13  缓存原理：应对面试你要掌握 Redis 哪些原理？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/14%20%20%e7%bc%93%e5%ad%98%e7%ad%96%e7%95%a5%ef%bc%9a%e9%9d%a2%e8%af%95%e4%b8%ad%e5%a6%82%e4%bd%95%e5%9b%9e%e7%ad%94%e7%bc%93%e5%ad%98%e7%a9%bf%e9%80%8f%e3%80%81%e9%9b%aa%e5%b4%a9%e7%ad%89%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="14  缓存策略：面试中如何回答缓存穿透、雪崩等问题？.md.html">14  缓存策略：面试中如何回答缓存穿透、雪崩等问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/15%20%20%e5%a6%82%e4%bd%95%e5%90%91%e9%9d%a2%e8%af%95%e5%ae%98%e8%af%81%e6%98%8e%e4%bd%a0%e5%81%9a%e7%9a%84%e7%b3%bb%e7%bb%9f%e6%98%af%e9%ab%98%e5%8f%af%e7%94%a8%e7%9a%84%ef%bc%9f.md.html" id="15  如何向面试官证明你做的系统是高可用的？.md.html">15  如何向面试官证明你做的系统是高可用的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/16%20%20%e5%a6%82%e4%bd%95%e4%bb%8e%e6%9e%b6%e6%9e%84%e5%b8%88%e8%a7%92%e5%ba%a6%e5%9b%9e%e7%ad%94%e7%b3%bb%e7%bb%9f%e5%ae%b9%e9%94%99%e3%80%81%e9%99%8d%e7%ba%a7%e7%ad%89%e9%ab%98%e5%8f%af%e7%94%a8%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="16  如何从架构师角度回答系统容错、降级等高可用问题？.md.html">16  如何从架构师角度回答系统容错、降级等高可用问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/17%20%20%e5%a6%82%e4%bd%95%e5%90%91%e9%9d%a2%e8%af%95%e5%ae%98%e8%af%81%e6%98%8e%e4%bd%a0%e5%81%9a%e7%9a%84%e7%b3%bb%e7%bb%9f%e6%98%af%e9%ab%98%e6%80%a7%e8%83%bd%e7%9a%84%ef%bc%9f.md.html" id="17  如何向面试官证明你做的系统是高性能的？.md.html">17  如何向面试官证明你做的系统是高性能的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/18%20%20%e5%a6%82%e4%bd%95%e4%bb%8e%e6%9e%b6%e6%9e%84%e5%b8%88%e8%a7%92%e5%ba%a6%e5%9b%9e%e7%ad%94%e6%80%8e%e4%b9%88%e5%ba%94%e5%af%b9%e5%8d%83%e4%b8%87%e7%ba%a7%e6%b5%81%e9%87%8f%e7%9a%84%e9%97%ae%e9%a2%98%ef%bc%9f.md.html" id="18  如何从架构师角度回答怎么应对千万级流量的问题？.md.html">18  如何从架构师角度回答怎么应对千万级流量的问题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/19%20%e5%bd%a9%e8%9b%8b%20%20%e4%ba%92%e8%81%94%e7%bd%91%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%ef%bc%8c%e4%bd%a0%e9%9c%80%e8%a6%81%e6%8e%8c%e6%8f%a1%e7%9a%84%e7%9f%a5%e8%af%86%e4%bd%93%e7%b3%bb.md.html" id="19 彩蛋  互联网架构设计面试，你需要掌握的知识体系.md.html">19 彩蛋  互联网架构设计面试，你需要掌握的知识体系.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e9%9d%a2%e8%af%95%e7%b2%be%e8%ae%b2/%e7%bb%93%e6%9d%9f%e8%af%ad%20%20%e7%a8%8b%e5%ba%8f%e5%91%98%e7%9a%84%e9%81%93%e3%80%81%e6%9c%af%e3%80%81%e5%8a%bf.md.html" id="结束语  程序员的道、术、势.md.html">结束语  程序员的道、术、势.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="08 案例串联  如何让系统抗住双十一的预约抢购活动？" id="title">08 案例串联  如何让系统抗住双十一的预约抢购活动？</h1>
<div><p>到目前为止，我们讨论了很多的面试思路，比如 02 讲中关于架构设计的“四步回答法”，不过大部分内容都是比较独立的知识点（比如分布式事务、分布式锁……）为了让你更深入掌握前几讲内容，把相对独立的知识串联起来，我们今天就来回顾、梳理近期学习的内容，通过“电商预约抢购”的场景，用前几讲内容，做一道完整的架构设计题。</p>
<h3 id="案例背景">案例背景</h3>
<p>在大促活动期间，“预约抢购”已经是各大电商平台的主要促销手段，京东自然也会和一些大的供应商合作，推出一些低价的爆款产品，比如 2019 年的 “1499 元抢购飞天茅台”活动，就让很多人每天准时准点拿着手机拼人品。</p>
<p>那这类电商领域的大促抢购场景涉及专栏的哪些内容呢？它们是怎么通过架构设计的方式组合在一起，实现一个完整的需求流程呢？这就是今天要讨论的话题。</p>
<p>我们先把需求梳理一下，总的来说，实现一个抢购系统大概可以分为四个阶段。</p>
<p><img alt="Drawing 0.png" src="assets/Ciqc1GAJU5eAH5_nAAPlPlxEHeY549.png"/></p>
<ul>
<li><strong>商品预约</strong>：用户进入商品详情页面，获取购买资格，并等待商品抢购倒计时。</li>
<li><strong>等待抢购</strong>：等待商品抢购倒计时，直到商品开放抢购。</li>
<li><strong>商品抢购</strong>：商品抢购倒计时结束，用户提交抢购订单，排队等待抢购结果，抢购成功后，扣减系统库存，生成抢购订单。</li>
<li><strong>订单支付</strong>：等待用户支付成功后，系统更新订单状态，通知用户购买成功。</li>
</ul>
<p>接下来，我们就针对各阶段容易出现的问题，来分析其中的技术考点和解决方案。</p>
<h3 id="商品预约阶段">商品预约阶段</h3>
<p>这几年，很多电商平台为了方便流量运营，改造了传统秒杀场景，通过先预约再抢购的方式预热商品，并根据预约量调整运营策略。而且在预约抢购的活动中，为了增加商品售卖量，会允许抢购前，预约资格超过实际的库存数量。</p>
<p>那么问题来了：如何在高并发量的情况下，让每个用户都能得到抢购资格呢？<strong>这是预约抢购场景第一个技术考察点。</strong> 那你可以基于“06 | 分布式系统中，如何回答锁的实现原理？”来控制抢购资格的发放。</p>
<p>我们基于 Redis 实现分布式锁（这是最常用的方式），在加锁的过程中，实际上是给 Key 键设置一个值，为避免死锁，还要给 Key 键设置一个过期时间。</p>
<pre><code>SET lock_key unique_value NX PX 10000
</code></pre>
<ul>
<li>lock_key 就是 key 键；</li>
<li>unique_value 是客户端生成的唯一的标识；</li>
<li>NX 代表只在 lock_key 不存在时，才对 lock_key 进行设置操作；</li>
<li>PX 10000 表示设置 lock_key 的过期时间为 10s，这是为了避免客户端发生异常而无法释放锁。</li>
</ul>
<p>而解锁的过程就是将 lock_key 键删除，但不能乱删，要保证执行操作的客户端就是加锁的客户端。而这个时候， unique_value 的作用就体现出来，你可以通过 Lua 脚本判断 unique_value 是否为加锁客户端。</p>
<p>选用 Lua 脚本是为了保证解锁操作的原子性。因为 Redis 在执行 Lua 脚本时，可以以原子性的方式执行，保证了锁释放操作的原子性。</p>
<pre><code>// 释放锁时，先比较 unique_value 是否相等，避免锁的误释放

if redis.call("get",KEYS[1]) == ARGV[1] then

    return redis.call("del",KEYS[1])

else

    return 0

end
</code></pre>
<p>这样一来，就通过使用 SET 命令和 Lua 脚本在 Redis 单节点上完成了分布式锁的加锁和解锁。但你要注意，此方案是基于单节点的 Redis 实例实现的，如果此时 Redis 实例发生故障宕机，那么锁变量就没有了，客户端也就无法进行锁操作，就会影响到业务的正常执行。
所以，基于 Redis 实现分布式锁时，你还要掌握如何保证锁的可靠性，也就是怎么基于多个 Redis 节点实现分布式锁（这部分也可以参考 06 讲中的内容）。</p>
<h3 id="等待抢购阶段">等待抢购阶段</h3>
<p>用户预约成功之后，在商品详情页面中，会存在一个抢购倒计时，这个倒计时的初始时间是从服务端获取的，用户点击购买按钮时，系统还会去服务端验证是否已经到了抢购时间。</p>
<p>在等待抢购阶段，流量突增，因为在抢购商品之前（尤其是临近开始抢购之前的一分钟内），大部分用户会频繁刷新商品详情页，<strong>商品详情页面的读请求量剧增，</strong> 如果商品详情页面没有做好流量控制，就容易成为整个预约抢购系统中的性能瓶颈点。</p>
<p>那么问题来了：如何解决等待抢购时间内的流量突增问题呢？有两个解决思路。</p>
<ul>
<li><strong>页面静态化</strong>：提前对抢购商品的详情页面做静态化，生成一个静态页面，再把页面放到距离用户最近的 CDN 节点中，这样一来，当浏览器访问页面时，就会自动缓存该页面的静态资源文件（对于静态化技术，很多页面端的模板引擎都支持这样的功能，我就不展开讲了）。</li>
<li><strong>服务端限流</strong>：对商品详情页中的动态请求接口设置最大并发访问数量（具体的数量根据上线前的性能压测为准），防止超出预期的请求集中访问系统，造成系统压力过载。操作上，你可以在商品详情页的后端系统入口层（如网关系统）中进行接口限流，如果使用 Nginx 来做反向代理，可以直接基于 Nginx 配置限流算法，比如 Nginx 的 ngx_http_limit_req_module（限制单位时间内所有 IP 的请求数量）和 ngx_stream_limit_conn_module（限制单位时间内单个 IP 的请求数量）两个模块就提供了限流控制的功能，所以你还要提前掌握限流策略的原理，如令牌桶算法的原理。</li>
</ul>
<h3 id="商品抢购阶段">商品抢购阶段</h3>
<p>在商品抢购阶段，用户会点击提交订单，这时，抢购系统会先校验库存，当库存足够时，系统会先扣减库存，然后再生成订单。在这个过程中，短时间之内提交订单的写流量非常高，所以为了做流量削峰，会将提单请求暂存在消息队列中，并提示用户“抢购排队中……”然后再由后端服务异步处理用户的请求。</p>
<p>而你可以基于数据库和缓存两种方式，来实现校验库存和扣减库存的操作。</p>
<p>但因为抢购场景的瞬时流量极高，一般不会直接基于数据库来实现（因为每次操作数据库，即使通过消息队列做了流量削峰，对数据库来说压力也很大，会产生性能瓶颈）。如果非要基于数据库的话，你要通过分布式锁来优化扣减库存的并发操作，但此阶段的分布式锁对可靠性的要求会极高（因为在大促抢购阶段，小的可用性故障，都可能造成大的线上事故），所以基于单节点 Redis 实现的分布式锁不合适，你要选择多节点 Redis 实现分布式锁，或者选型 ZooKeeper。</p>
<p>为了避免上述问题，我们一般基于缓存来存储库存，实现扣减库存的操作。这样在提交订单时，库存的查询和锁定就不会给数据库带来性能瓶颈。不过你仍要注意，基于缓存（如 Redis）的库存扣减操作，仍要考虑缓存系统的单点问题，就算是多节点存储库存，也要引入锁的策略，保证 Redis 实现库存的一致性。</p>
<p>实现了校验库存和扣减库存之后，最后一步是生成抢购订单。由于数据库表会承载订单数据，一旦出现瞬时流量，磁盘 I/O、数据库请求连接数等资源都会出现性能瓶颈，你可以考虑对订单表分库分表，通过对用户 ID 字段进行 Hash 取模，实现分库分表，提高系统的并发能力。</p>
<p>从“商品抢购阶段的架构设计”中我们可以总结出三个技术考点：<strong>流量削峰、扣减库存、分库分表。</strong></p>
<ul>
<li><strong>“流量削峰”的面试考点</strong></li>
</ul>
<p>流量削峰是由于正式抢购场景下，短时间内的提单请求非常高，所以引入消息队列做异步化，然后在抢购系统的后端服务中，启动若干个队列处理消息队列中的提单请求，再执行校验库存、下单等逻辑。</p>
<p>那么如何快速处理消息队列中的提单请求，避免出现大量的消息积压，就是本阶段的考点之一了，方案可以参考“08 | MQ：如何回答消息队列的丢失、重复与积压问题？”</p>
<ul>
<li><strong>“扣减库存”的面试考点</strong></li>
</ul>
<p>我刚刚提到，当基于 Redis 实现库存的扣减时，要考虑怎么解决 Redis 的单点问题。而如果基于 Redis 集群来实现扣减库存，还要解决 Redis 在哨兵模式部署的情况下，因为主从切换带来的数据不一致的问题。这就涉及“06 | 分布式系统中，如何回答锁的实现原理？”中的内容。</p>
<ul>
<li><strong>“分库分表”的面试考点</strong></li>
</ul>
<p>生成订单后如何实现分库分表？你可以参考“04 | 亿级商品存储下，如何深度回答分布式系统的原理性问题？”中的解决方案。</p>
<p>当然还有一个容易忽略的问题：带宽的影响。由于抢购入口的请求量会非常大，可能会占用大量带宽，为了不影响提交订单的请求，有时会从网络工程的角度解决，通过单独的子域名绑定独立的网络服务器，这里就会涉及 DNS 的设计与优化手段。</p>
<h3 id="订单支付阶段">订单支付阶段</h3>
<p>在用户支付订单完成之后，一般会由支付平台回调系统接口，更新订单状态。在支付回调成功之后，抢购系统还会通过异步通知的方式，实现订单更新之外的非核心业务处理，比如积分累计、短信通知等，此阶段可以基于 MQ 实现业务的异步操作。</p>
<p><img alt="已改拉勾_架构面试精讲-20210112" src="assets/CgpVE2AN_qGANrtxAABtOAVpLik784.png"/></p>
<p>订单支付后操作</p>
<p>不过针对服务的异常（如宕机），会存在请求数据丢失的可能，比如当支付回调系统后，修改订单状态成功了，但是在异步通知积分系统，更新用户累计积分时，订单系统挂掉了，此时 MQ 还没有收到这条消息，那么这条消息数据就无法还原了。</p>
<p><img alt="已改拉勾_架构面试精讲-20210112" src="assets/Cip5yGAN_ruAPSKGAACFk7CsEOk016.png"/></p>
<p>订单支付后操作（异常）</p>
<p>所以你还要考虑“05 | 海量并发场景下，如何回答分布式事务一致性问题？”中，可靠消息投递机制：先做消息的本地存储，再通过异步重试机制，来实现消息的补偿。比如当支付平台回调订单系统，然后在更新状态的同时，插入一个消息，之后再返回第三方支付操作成功的结果。最后，通过数据库中的这条消息，再异步推送其他系统，完成后续的工作。</p>
<p><img alt="已改拉勾_架构面试精讲-20210112" src="assets/CgpVE2AN_tGABacCAACGq-H_pKs054.png"/></p>
<p>订单支付后操作（新方案）</p>
<h3 id="总结">总结</h3>
<p>今天，我们用前几讲的内容实现了一个完整的预约抢购的系统设计，为了加深你的理解，我总结了每个阶段的注意点。</p>
<ul>
<li><strong>商品预约阶段</strong>：要掌握如何在高并发的场景下通过锁的方式，让每一个用户都获取到抢购资格，结合业务场景对于并发控制的需求诉求和成本的考虑，在商品预约阶段，你可以基于 Redis 来实现分布式锁。</li>
<li><strong>等待抢购阶段</strong>：此阶段对页面的查询请求会很高，尤其是临近抢购倒计时的流量突增，解决方案是做页面静态化和服务端限流。</li>
<li><strong>商品抢购阶段</strong>：商品抢购是整个流程中涉及技术点最多的阶段，瞬时流量会带来极大的压力，所以通过 MQ 做了同步转异步，实现对流量的削峰，从而让请求排队等待，然后有序且有限地进入到后端服务，而你必须掌握消息队列的丢失、重复和积压问题的解决方案；另外在扣减库存的时候，为了解决扣减存储不超售的问题，同样还需要引入锁的机制。</li>
<li><strong>订单支付阶段</strong>：在用户支付完成后，系统通常还需要处理一些非核心操作，你可以通过 MQ 通知的方式来实现系统间的解耦和异步通信，但依旧要保证消息的可靠性（当然也可以通过 RPC 同步调用的方式来实现），所以你也要掌握 RPC 和 MQ 的相关知识点。</li>
</ul>
<p>总的来说，互联网中大数据里的存储设计（如商品与订单数据的存储设计），你可以参考 04 讲；关于秒杀或抢购场景下的库存扣减设计，你可以参考 06 讲；分布式系统之间的事务一致性的架构设计，你可以参考 05 讲；关于架构设计中的服务强依赖的设计，一般会通过 RPC 远程同步调用的方式实现，你可以参考07讲；系统解耦，流量削峰的设计问题，你可以参考 08讲。</p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#dfb3b3b3e6ebeeeeefe89fb8b2beb6b3f1bcb0b2" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9359114789afc99d',t:'MTc0NTUzNDA2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>