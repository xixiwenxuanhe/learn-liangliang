<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="27 滚动更新：如何做到平滑的应用升级降级？" name="description"/>
<link href="/static/favicon.png" rel="icon"/>
<title>27 滚动更新：如何做到平滑的应用升级降级？ </title>
<link href="/static/index.css" rel="stylesheet"/>
<link href="/static/highlight.min.css" rel="stylesheet"/>
<script src="/static/highlight.min.js"></script>
<meta content="Hexo 4.2.0" name="generator"/>
<script data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" defer="" src="https://umami.lianglianglee.com/script.js"></script>
</head>
<body>
<div class="book-container">
<div class="book-sidebar">
<div class="book-brand">
<a href="/">
<img src="/static/favicon.png"/>
<span>技术文章摘抄</span>
</a>
</div>
<div class="book-menu uncollapsible">
<ul class="uncollapsible">
<li><a class="current-tab" href="/">首页</a></li>
<li><a href="../">上一级</a></li>
</ul>
<ul class="uncollapsible">
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/00%20%e5%bc%80%e7%af%87%e8%af%8d%20%e8%bf%8e%e9%9a%be%e8%80%8c%e4%b8%8a%ef%bc%8c%e5%81%9a%e4%ba%91%e5%8e%9f%e7%94%9f%e6%97%b6%e4%bb%a3%e7%9a%84%e5%bc%84%e6%bd%ae%e5%84%bf.md.html" id="00 开篇词 迎难而上，做云原生时代的弄潮儿.md.html">00 开篇词 迎难而上，做云原生时代的弄潮儿.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/00%20%e8%af%be%e5%89%8d%e5%87%86%e5%a4%87%20%e5%8a%a8%e6%89%8b%e5%ae%9e%e8%b7%b5%e6%89%8d%e6%98%af%e6%9c%80%e5%a5%bd%e7%9a%84%e5%ad%a6%e4%b9%a0%e6%96%b9%e5%bc%8f.md.html" id="00 课前准备 动手实践才是最好的学习方式.md.html">00 课前准备 动手实践才是最好的学习方式.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/01%20%e5%88%9d%e8%af%86%e5%ae%b9%e5%99%a8%ef%bc%9a%e4%b8%87%e4%ba%8b%e5%bc%80%e5%a4%b4%e9%9a%be.md.html" id="01 初识容器：万事开头难.md.html">01 初识容器：万事开头难.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/02%20%e8%a2%ab%e9%9a%94%e7%a6%bb%e7%9a%84%e8%bf%9b%e7%a8%8b%ef%bc%9a%e4%b8%80%e8%b5%b7%e6%9d%a5%e7%9c%8b%e7%9c%8b%e5%ae%b9%e5%99%a8%e7%9a%84%e6%9c%ac%e8%b4%a8.md.html" id="02 被隔离的进程：一起来看看容器的本质.md.html">02 被隔离的进程：一起来看看容器的本质.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/03%20%e5%ae%b9%e5%99%a8%e5%8c%96%e7%9a%84%e5%ba%94%e7%94%a8%ef%bc%9a%e4%bc%9a%e4%ba%86%e8%bf%99%e4%ba%9b%e4%bd%a0%e5%b0%b1%e6%98%afDocker%e9%ab%98%e6%89%8b.md.html" id="03 容器化的应用：会了这些你就是Docker高手.md.html">03 容器化的应用：会了这些你就是Docker高手.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/04%20%e5%88%9b%e5%bb%ba%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%ef%bc%9a%e5%a6%82%e4%bd%95%e7%bc%96%e5%86%99%e6%ad%a3%e7%a1%ae%e3%80%81%e9%ab%98%e6%95%88%e7%9a%84Dockerfile.md.html" id="04 创建容器镜像：如何编写正确、高效的Dockerfile.md.html">04 创建容器镜像：如何编写正确、高效的Dockerfile.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/05%20%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%ef%bc%9a%e8%af%a5%e6%80%8e%e6%a0%b7%e7%94%a8%e5%a5%bdDocker%20Hub%e8%bf%99%e4%b8%aa%e5%ae%9d%e8%97%8f.md.html" id="05 镜像仓库：该怎样用好Docker Hub这个宝藏.md.html">05 镜像仓库：该怎样用好Docker Hub这个宝藏.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/06%20%e6%89%93%e7%a0%b4%e6%ac%a1%e5%85%83%e5%a3%81%ef%bc%9a%e5%ae%b9%e5%99%a8%e8%af%a5%e5%a6%82%e4%bd%95%e4%b8%8e%e5%a4%96%e7%95%8c%e4%ba%92%e8%81%94%e4%ba%92%e9%80%9a.md.html" id="06 打破次元壁：容器该如何与外界互联互通.md.html">06 打破次元壁：容器该如何与外界互联互通.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/07%20%e5%ae%9e%e6%88%98%e6%bc%94%e7%bb%83%ef%bc%9a%e7%8e%a9%e8%bd%acDocker.md.html" id="07 实战演练：玩转Docker.md.html">07 实战演练：玩转Docker.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/08%20%e8%a7%86%e9%a2%91%ef%bc%9a%e5%85%a5%e9%97%a8%e7%af%87%e5%ae%9e%e6%93%8d%e6%80%bb%e7%bb%93.md.html" id="08 视频：入门篇实操总结.md.html">08 视频：入门篇实操总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/09%20%e8%b5%b0%e8%bf%91%e4%ba%91%e5%8e%9f%e7%94%9f%ef%bc%9a%e5%a6%82%e4%bd%95%e5%9c%a8%e6%9c%ac%e6%9c%ba%e6%90%ad%e5%bb%ba%e5%b0%8f%e5%b7%a7%e5%ae%8c%e5%a4%87%e7%9a%84Kubernetes%e7%8e%af%e5%a2%83.md.html" id="09 走近云原生：如何在本机搭建小巧完备的Kubernetes环境.md.html">09 走近云原生：如何在本机搭建小巧完备的Kubernetes环境.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/10%20%e8%87%aa%e5%8a%a8%e5%8c%96%e7%9a%84%e8%bf%90%e7%bb%b4%e7%ae%a1%e7%90%86%ef%bc%9a%e6%8e%a2%e7%a9%b6Kubernetes%e5%b7%a5%e4%bd%9c%e6%9c%ba%e5%88%b6%e7%9a%84%e5%a5%a5%e7%a7%98.md.html" id="10 自动化的运维管理：探究Kubernetes工作机制的奥秘.md.html">10 自动化的运维管理：探究Kubernetes工作机制的奥秘.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/11%20YAML%ef%bc%9aKubernetes%e4%b8%96%e7%95%8c%e9%87%8c%e7%9a%84%e9%80%9a%e7%94%a8%e8%af%ad.md.html" id="11 YAML：Kubernetes世界里的通用语.md.html">11 YAML：Kubernetes世界里的通用语.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/12%20Pod%ef%bc%9a%e5%a6%82%e4%bd%95%e7%90%86%e8%a7%a3%e8%bf%99%e4%b8%aaKubernetes%e9%87%8c%e6%9c%80%e6%a0%b8%e5%bf%83%e7%9a%84%e6%a6%82%e5%bf%b5%ef%bc%9f.md.html" id="12 Pod：如何理解这个Kubernetes里最核心的概念？.md.html">12 Pod：如何理解这个Kubernetes里最核心的概念？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/13%20Job_CronJob%ef%bc%9a%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e7%9b%b4%e6%8e%a5%e7%94%a8Pod%e6%9d%a5%e5%a4%84%e7%90%86%e4%b8%9a%e5%8a%a1%ef%bc%9f.md.html" id="13 Job_CronJob：为什么不直接用Pod来处理业务？.md.html">13 Job_CronJob：为什么不直接用Pod来处理业务？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/14%20ConfigMap_Secret%ef%bc%9a%e6%80%8e%e6%a0%b7%e9%85%8d%e7%bd%ae%e3%80%81%e5%ae%9a%e5%88%b6%e6%88%91%e7%9a%84%e5%ba%94%e7%94%a8.md.html" id="14 ConfigMap_Secret：怎样配置、定制我的应用.md.html">14 ConfigMap_Secret：怎样配置、定制我的应用.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/15%20%e5%ae%9e%e6%88%98%e6%bc%94%e7%bb%83%ef%bc%9a%e7%8e%a9%e8%bd%acKubernetes%ef%bc%881%ef%bc%89.md.html" id="15 实战演练：玩转Kubernetes（1）.md.html">15 实战演练：玩转Kubernetes（1）.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/16%20%e8%a7%86%e9%a2%91%ef%bc%9a%e5%88%9d%e7%ba%a7%e7%af%87%e5%ae%9e%e6%93%8d%e6%80%bb%e7%bb%93.md.html" id="16 视频：初级篇实操总结.md.html">16 视频：初级篇实操总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/17%20%e6%9b%b4%e7%9c%9f%e5%ae%9e%e7%9a%84%e4%ba%91%e5%8e%9f%e7%94%9f%ef%bc%9a%e5%ae%9e%e9%99%85%e6%90%ad%e5%bb%ba%e5%a4%9a%e8%8a%82%e7%82%b9%e7%9a%84Kubernetes%e9%9b%86%e7%be%a4.md.html" id="17 更真实的云原生：实际搭建多节点的Kubernetes集群.md.html">17 更真实的云原生：实际搭建多节点的Kubernetes集群.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/18%20Deployment%ef%bc%9a%e8%ae%a9%e5%ba%94%e7%94%a8%e6%b0%b8%e4%b8%8d%e5%ae%95%e6%9c%ba.md.html" id="18 Deployment：让应用永不宕机.md.html">18 Deployment：让应用永不宕机.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/19%20Daemonset%ef%bc%9a%e5%bf%a0%e5%ae%9e%e5%8f%af%e9%9d%a0%e7%9a%84%e7%9c%8b%e9%97%a8%e7%8b%97.md.html" id="19 Daemonset：忠实可靠的看门狗.md.html">19 Daemonset：忠实可靠的看门狗.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/20%20Service%ef%bc%9a%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%9e%b6%e6%9e%84%e7%9a%84%e5%ba%94%e5%af%b9%e4%b9%8b%e9%81%93.md.html" id="20 Service：微服务架构的应对之道.md.html">20 Service：微服务架构的应对之道.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/21%20Ingress%ef%bc%9a%e9%9b%86%e7%be%a4%e8%bf%9b%e5%87%ba%e6%b5%81%e9%87%8f%e7%9a%84%e6%80%bb%e7%ae%a1.md.html" id="21 Ingress：集群进出流量的总管.md.html">21 Ingress：集群进出流量的总管.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/22%20%e5%ae%9e%e6%88%98%e6%bc%94%e7%bb%83%ef%bc%9a%e7%8e%a9%e8%bd%acKubernetes%ef%bc%882%ef%bc%89.md.html" id="22 实战演练：玩转Kubernetes（2）.md.html">22 实战演练：玩转Kubernetes（2）.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/23%20%e8%a7%86%e9%a2%91%ef%bc%9a%e4%b8%ad%e7%ba%a7%e7%af%87%e5%ae%9e%e6%93%8d%e6%80%bb%e7%bb%93.md.html" id="23 视频：中级篇实操总结.md.html">23 视频：中级篇实操总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/24%20PersistentVolume%ef%bc%9a%e6%80%8e%e4%b9%88%e8%a7%a3%e5%86%b3%e6%95%b0%e6%8d%ae%e6%8c%81%e4%b9%85%e5%8c%96%e7%9a%84%e9%9a%be%e9%a2%98%ef%bc%9f.md.html" id="24 PersistentVolume：怎么解决数据持久化的难题？.md.html">24 PersistentVolume：怎么解决数据持久化的难题？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/25%20PersistentVolume%20+%20NFS%ef%bc%9a%e6%80%8e%e4%b9%88%e4%bd%bf%e7%94%a8%e7%bd%91%e7%bb%9c%e5%85%b1%e4%ba%ab%e5%ad%98%e5%82%a8%ef%bc%9f.md.html" id="25 PersistentVolume + NFS：怎么使用网络共享存储？.md.html">25 PersistentVolume + NFS：怎么使用网络共享存储？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/26%20StatefulSet%ef%bc%9a%e6%80%8e%e4%b9%88%e7%ae%a1%e7%90%86%e6%9c%89%e7%8a%b6%e6%80%81%e7%9a%84%e5%ba%94%e7%94%a8%ef%bc%9f.md.html" id="26 StatefulSet：怎么管理有状态的应用？.md.html">26 StatefulSet：怎么管理有状态的应用？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/27%20%e6%bb%9a%e5%8a%a8%e6%9b%b4%e6%96%b0%ef%bc%9a%e5%a6%82%e4%bd%95%e5%81%9a%e5%88%b0%e5%b9%b3%e6%bb%91%e7%9a%84%e5%ba%94%e7%94%a8%e5%8d%87%e7%ba%a7%e9%99%8d%e7%ba%a7%ef%bc%9f.md.html" id="27 滚动更新：如何做到平滑的应用升级降级？.md.html">27 滚动更新：如何做到平滑的应用升级降级？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/28%20%e5%ba%94%e7%94%a8%e4%bf%9d%e9%9a%9c%ef%bc%9a%e5%a6%82%e4%bd%95%e8%ae%a9Pod%e8%bf%90%e8%a1%8c%e5%be%97%e6%9b%b4%e5%81%a5%e5%ba%b7%ef%bc%9f.md.html" id="28 应用保障：如何让Pod运行得更健康？.md.html">28 应用保障：如何让Pod运行得更健康？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/29%20%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86%ef%bc%9a%e5%a6%82%e4%bd%95%e7%94%a8%e5%90%8d%e5%ad%97%e7%a9%ba%e9%97%b4%e5%88%86%e9%9a%94%e7%b3%bb%e7%bb%9f%e8%b5%84%e6%ba%90%ef%bc%9f.md.html" id="29 集群管理：如何用名字空间分隔系统资源？.md.html">29 集群管理：如何用名字空间分隔系统资源？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/30%20%e7%b3%bb%e7%bb%9f%e7%9b%91%e6%8e%a7%ef%bc%9a%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8Metrics%20Server%e5%92%8cPrometheus%ef%bc%9f.md.html" id="30 系统监控：如何使用Metrics Server和Prometheus？.md.html">30 系统监控：如何使用Metrics Server和Prometheus？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/31%20%e7%bd%91%e7%bb%9c%e9%80%9a%e4%bf%a1%ef%bc%9aCNI%e6%98%af%e6%80%8e%e4%b9%88%e5%9b%9e%e4%ba%8b%ef%bc%9f%e5%8f%88%e6%98%af%e6%80%8e%e4%b9%88%e5%b7%a5%e4%bd%9c%e7%9a%84%ef%bc%9f.md.html" id="31 网络通信：CNI是怎么回事？又是怎么工作的？.md.html">31 网络通信：CNI是怎么回事？又是怎么工作的？.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/32%20%e5%ae%9e%e6%88%98%e6%bc%94%e7%bb%83%ef%bc%9a%e7%8e%a9%e8%bd%acKubernetes%ef%bc%883%ef%bc%89.md.html" id="32 实战演练：玩转Kubernetes（3）.md.html">32 实战演练：玩转Kubernetes（3）.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/33%20%e8%a7%86%e9%a2%91%ef%bc%9a%e9%ab%98%e7%ba%a7%e7%af%87%e5%ae%9e%e6%93%8d%e6%80%bb%e7%bb%93.md.html" id="33 视频：高级篇实操总结.md.html">33 视频：高级篇实操总结.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/%e5%8a%a0%e9%a4%90%20docker-compose%ef%bc%9a%e5%8d%95%e6%9c%ba%e7%8e%af%e5%a2%83%e4%b8%8b%e7%9a%84%e5%ae%b9%e5%99%a8%e7%bc%96%e6%8e%92%e5%b7%a5%e5%85%b7.md.html" id="加餐 docker-compose：单机环境下的容器编排工具.md.html">加餐 docker-compose：单机环境下的容器编排工具.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/%e5%8a%a0%e9%a4%90%20%e8%b0%88%e8%b0%88Kong%20Ingress%20Controller.md.html" id="加餐 谈谈Kong Ingress Controller.md.html">加餐 谈谈Kong Ingress Controller.md.html</a>
</li>
<li>
<a class="menu-item" href="/%e4%b8%93%e6%a0%8f/Kubernetes%e5%85%a5%e9%97%a8%e5%ae%9e%e6%88%98%e8%af%be/%e7%bb%93%e6%9d%9f%e8%af%ad%20%e6%98%af%e7%bb%88%e7%82%b9%ef%bc%8c%e6%9b%b4%e6%98%af%e8%b5%b7%e7%82%b9.md.html" id="结束语 是终点，更是起点.md.html">结束语 是终点，更是起点.md.html</a>
</li>
<li><a href="/assets/捐赠.md.html">捐赠</a></li>
</ul>
</div>
</div>
<div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseleave="remove_inner()" onmouseover="add_inner()">
<div class="sidebar-toggle-inner"></div>
</div>
<div class="off-canvas-content">
<div class="columns">
<div class="column col-12 col-lg-12">
<div class="book-navbar">
<header class="navbar">
<section class="navbar-section">
<a onclick="open_sidebar()">
<i class="icon icon-menu"></i>
</a>
</section>
</header>
</div>
<div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
<div class="book-post">
<div align="center">因收到Google相关通知，网站将会择期关闭。<a href="https://lumendatabase.org/notices/44265620" target="_blank">相关通知内容</a><hr/></div>
<p align="center" id="tip"></p>
<h1 class="title" data-id="27 滚动更新：如何做到平滑的应用升级降级？" id="title">27 滚动更新：如何做到平滑的应用升级降级？</h1>
<div><p>你好，我是Chrono。</p>
<p>上次课里我们学习了管理有状态应用的对象StatefulSet，再加上管理无状态应用的Deployment和DaemonSet，我们就能在Kubernetes里部署任意形式的应用了。</p>
<p>不过，只是把应用发布到集群里是远远不够的，要让应用稳定可靠地运行，还需要有持续的运维工作。</p>
<p>如果你还记得在[第18节课]里，我们学过Deployment的“应用伸缩”功能就是一种常见的运维操作，在Kubernetes里，使用命令 <code>kubectl scale</code>，我们就可以轻松调整Deployment下属的Pod数量，因为StatefulSet是Deployment的一种特例，所以它也可以使用 <code>kubectl scale</code> 来实现“应用伸缩”。</p>
<p>除了“应用伸缩”，其他的运维操作比如应用更新、版本回退等工作，该怎么做呢？这些也是我们日常运维中经常会遇到的问题。</p>
<p>今天我就以Deployment为例，来讲讲Kubernetes在应用管理方面的高级操作：滚动更新，使用 <code>kubectl rollout</code> 实现用户无感知的应用升级和降级。</p>
<h2 id="kubernetes如何定义应用版本">Kubernetes如何定义应用版本</h2>
<p>应用的版本更新，大家都知道是怎么回事，比如我们发布了V1版，过了几天加了新功能，要发布V2版。</p>
<p>不过说起来简单，版本更新实际做起来是一个相当棘手的事。因为系统已经上线运行，必须要保证不间断地对外提供服务，通俗地说就是“给空中的飞机换引擎”。尤其在以前，需要开发、测试、运维、监控、网络等各个部门的一大堆人来协同工作，费时又费力。</p>
<p>但是，应用的版本更新其实是有章可循的，现在我们有了Kubernetes这个强大的自动化运维管理系统，就可以把它的过程抽象出来，让计算机去完成那些复杂繁琐的人工操作。</p>
<p>在Kubernetes里，版本更新使用的不是API对象，而是两个命令：<code>kubectl apply</code> 和 <code>kubectl rollout</code>，当然它们也要搭配部署应用所需要的Deployment、DaemonSet等YAML文件。</p>
<p>不过在我们信心满满开始操作之前，首先要理解在Kubernetes里，所谓的“版本”到底是什么？</p>
<p>我们常常会简单地认为“版本”就是应用程序的“版本号”，或者是容器镜像的“标签”，但不要忘了，在Kubernetes里应用都是以Pod的形式运行的，而Pod通常又会被Deployment等对象来管理，<strong>所以应用的“版本更新”实际上更新的是整个Pod</strong>。</p>
<p>那Pod又是由什么来决定的呢？</p>
<p>仔细回忆一下之前我们创建的那么多个对象，你就会发现，Pod是由YAML描述文件来确定的，更准确地说，是Deployment等对象里的字段 <code>template</code>。</p>
<p>所以，<strong>在Kubernetes里应用的版本变化就是 <code>template</code> 里Pod的变化</strong>，哪怕 <code>template</code> 里只变动了一个字段，那也会形成一个新的版本，也算是版本变化。</p>
<p>但 <code>template</code> 里的内容太多了，拿这么长的字符串来当做“版本号”不太现实，所以Kubernetes就使用了“摘要”功能，用摘要算法计算 <code>template</code> 的Hash值作为“版本号”，虽然不太方便识别，但是很实用。</p>
<p>我们就拿[第18讲]里的Nginx Deployment作为例子吧，创建对象之后，使用 <code>kubectl get</code> 来查看Pod的状态：</p>
<p><img alt="图片" src="assets/67bc5178acde882a57265d6413158a7b.png"/></p>
<p>Pod名字里的那串随机数“6796……”就是Pod模板的Hash值，也就是Pod的“版本号”。</p>
<p>如果你变动了Pod YAML描述，比如把镜像改成 <code>nginx:stable-alpine</code>，或者把容器名字改成 <code>nginx-test</code>，都会生成一个新的应用版本，<code>kubectl apply</code> 后就会重新创建Pod：</p>
<p><img alt="图片" src="assets/15e17760079a03f046aa67f6e34b511e.png"/></p>
<p>你可以看到，Pod名字里的Hash值变成了“7c6c……”，这就表示Pod的版本更新了。</p>
<h2 id="kubernetes如何实现应用更新">Kubernetes如何实现应用更新</h2>
<p>为了更仔细地研究Kubernetes的应用更新过程，让我们来略微改造一下Nginx Deployment对象，看看Kubernetes到底是怎么实现版本更新的。</p>
<p>首先修改ConfigMap，让它输出Nginx的版本号，方便我们用curl查看版本：</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: ngx-conf

data:
  default.conf: |
    server {
      listen 80;
      location / {
        default_type text/plain;
        return 200
          'ver : $nginx_version\nsrv : $server_addr:$server_port\nhost: $hostname\n';
      }
    }
</code></pre>
<p>然后我们修改Pod镜像，明确地指定版本号是 <code>1.21-alpine</code>，实例数设置为4个：</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: ngx-dep

spec:
  replicas: 4
  ... ...
      containers:
      - image: nginx:1.21-alpine
  ... ...
</code></pre>
<p>把它命名为 <code>ngx-v1.yml</code>，然后执行命令 <code>kubectl apply</code> 部署这个应用：</p>
<pre><code>kubectl apply -f ngx-v1.yml
</code></pre>
<p>我们还可以为它创建Service对象，再用 <code>kubectl port-forward</code> 转发请求来查看状态：</p>
<pre><code>kubectl port-forward svc/ngx-svc 8080:80 &amp;
curl 127.1:8080
</code></pre>
<p><img alt="图片" src="assets/20d23af1305e2d2b4f66b951c09dac52.png"/></p>
<p>从curl命令的输出中可以看到，现在应用的版本是 <code>1.21.6</code>。</p>
<p>现在，让我们编写一个新版本对象 <code>ngx-v2.yml</code>，把镜像升级到 <code>nginx:1.22-alpine</code>，其他的都不变。</p>
<p><strong>因为Kubernetes的动作太快了，为了能够观察到应用更新的过程，我们还需要添加一个字段 <code>minReadySeconds</code></strong>，让Kubernetes在更新过程中等待一点时间，确认Pod没问题才继续其余Pod的创建工作。</p>
<p>要提醒你注意的是，<code>minReadySeconds</code> 这个字段不属于Pod模板，所以它不会影响Pod版本：</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: ngx-dep

spec:
  minReadySeconds: 15      # 确认Pod就绪的等待时间 
  replicas: 4
  ... ...
      containers:
      - image: nginx:1.22-alpine
  ... ...
</code></pre>
<p>现在我们执行命令 <code>kubectl apply</code> 来更新应用，因为改动了镜像名，Pod模板变了，就会触发“版本更新”，然后用一个新命令：<code>kubectl rollout status</code>，来查看应用更新的状态：</p>
<pre><code>kubectl apply -f ngx-v2.yml
kubectl rollout status deployment ngx-dep
</code></pre>
<p><img alt="图片" src="assets/6d4023181fe180d50eb4cca7755a207f.png"/></p>
<p>更新完成后，你再执行 <code>kubectl get pod</code>，就会看到Pod已经全部替换成了新版本“d575……”，用curl访问Nginx，输出信息也变成了“1.22.0”：</p>
<p><img alt="图片" src="assets/6a1776c3yy1ec374510af9e560401064.png"/></p>
<p>仔细查看 <code>kubectl rollout status</code> 的输出信息，你可以发现，Kubernetes不是把旧Pod全部销毁再一次性创建出新Pod，而是在逐个地创建新Pod，同时也在销毁旧Pod，保证系统里始终有足够数量的Pod在运行，不会有“空窗期”中断服务。</p>
<p>新Pod数量增加的过程有点像是“滚雪球”，从零开始，越滚越大，所以这就是所谓的“<strong>滚动更新</strong>”（rolling update）。</p>
<p>使用命令 <code>kubectl describe</code> 可以更清楚地看到Pod的变化情况：</p>
<pre><code>kubectl describe deploy ngx-dep
</code></pre>
<p><img alt="图片" src="assets/3b88d6b0d609e3b99f33b4f8e997c3fa.png"/></p>
<ul>
<li>一开始的时候V1 Pod（即ngx-dep-54b865d75）的数量是4；</li>
<li>当“滚动更新”开始的时候，Kubernetes创建1个 V2 Pod（即ngx-dep-d575d5776），并且把V1 Pod数量减少到3；</li>
<li>接着再增加V2 Pod的数量到2，同时V1 Pod的数量变成了1；</li>
<li>最后V2 Pod的数量达到预期值4，V1 Pod的数量变成了0，整个更新过程就结束了。</li>
</ul>
<p>看到这里你是不是有点明白了呢，其实“滚动更新”就是由Deployment控制的两个同步进行的“应用伸缩”操作，老版本缩容到0，同时新版本扩容到指定值，是一个“此消彼长”的过程。</p>
<p>这个滚动更新的过程我画了一张图，你可以参考它来进一步体会：</p>
<p><img alt="图片" src="assets/b3abe70db73a9da71a1793722e743731.jpg"/></p>
<h2 id="kubernetes如何管理应用更新">Kubernetes如何管理应用更新</h2>
<p>Kubernetes的“滚动更新”功能确实非常方便，不需要任何人工干预就能简单地把应用升级到新版本，也不会中断服务，不过如果更新过程中发生了错误或者更新后发现有Bug该怎么办呢？</p>
<p>要解决这两个问题，我们还是要用 <code>kubectl rollout</code> 命令。</p>
<p>在应用更新的过程中，你可以随时使用 <code>kubectl rollout pause</code> 来暂停更新，检查、修改Pod，或者测试验证，如果确认没问题，再用 <code>kubectl rollout resume</code> 来继续更新。</p>
<p>这两个命令比较简单，我就不多做介绍了，要注意的是它们只支持Deployment，不能用在DaemonSet、StatefulSet上（最新的1.24支持了StatefulSet的滚动更新）。</p>
<p>对于更新后出现的问题，Kubernetes为我们提供了“后悔药”，也就是更新历史，你可以查看之前的每次更新记录，并且回退到任何位置，和我们开发常用的Git等版本控制软件非常类似。</p>
<p>查看更新历史使用的命令是 <code>kubectl rollout history</code>：</p>
<pre><code>kubectl rollout history deploy ngx-dep
</code></pre>
<p><img alt="图片" src="assets/7cc86862b28829c58c00eeb0fcdfbd09.png"/></p>
<p>它会输出一个版本列表，因为我们创建Nginx Deployment是一个版本，更新又是一个版本，所以这里就会有两条历史记录。</p>
<p>但 <code>kubectl rollout history</code> 的列表输出的有用信息太少，你可以<strong>在命令后加上参数 <code>--revision</code> 来查看每个版本的详细信息</strong>，包括标签、镜像名、环境变量、存储卷等等，通过这些就可以大致了解每次都变动了哪些关键字段：</p>
<pre><code>kubectl rollout history deploy --revision=2
</code></pre>
<p><img alt="图片" src="assets/0f8c4d0a230b97bb1a74d745c220677c.png"/></p>
<p>假设我们认为刚刚更新的 <code>nginx:1.22-alpine</code> 不好，<strong>想要回退到上一个版本，就可以使用命令 <code>kubectl rollout undo</code>，也可以加上参数 <code>--to-revision</code> 回退到任意一个历史版本</strong>：</p>
<pre><code>kubectl rollout undo deploy ngx-dep
</code></pre>
<p><img alt="图片" src="assets/149345b7df104ac70c23a6c877a9b1c7.png"/></p>
<p><code>kubectl rollout undo</code> 的操作过程其实和 <code>kubectl apply</code> 是一样的，执行的仍然是“滚动更新”，只不过使用的是旧版本Pod模板，把新版本Pod数量收缩到0，同时把老版本Pod扩展到指定值。</p>
<p>这个V2到V1的“版本降级”的过程我同样画了一张图，它和从V1到V2的“版本升级”过程是完全一样的，不同的只是版本号的变化方向：</p>
<p><img alt="图片" src="assets/0cbb6eec008546c4f5106de5ece20329.jpg"/></p>
<h2 id="kubernetes如何添加更新描述">Kubernetes如何添加更新描述</h2>
<p>讲到这里，Kubernetes里应用更新的功能就学得差不多了。</p>
<p>不过，你有没有觉得 <code>kubectl rollout history</code> 的版本列表好像有点太简单了呢？只有一个版本更新序号，而另一列 <code>CHANGE-CAUSE</code> 为什么总是显示成 <code>&lt;none&gt;</code> 呢？能不能像Git一样，每次更新也加上说明信息呢？</p>
<p><img alt="图片" src="assets/7cc86862b28829c58c00eeb0fcdfbd09.png"/></p>
<p>这当然是可以的，做法也很简单，我们<strong>只需要在Deployment的 <code>metadata</code> 里加上一个新的字段 <code>annotations</code></strong>。</p>
<p><code>annotations</code> 字段的含义是“注解”“注释”，形式上和 <code>labels</code> 一样，都是Key-Value，也都是给API对象附加一些额外的信息，但是用途上区别很大。</p>
<ul>
<li><code>annotations</code> 添加的信息一般是给Kubernetes内部的各种对象使用的，有点像是“扩展属性”；</li>
<li><code>labels</code> 主要面对的是Kubernetes外部的用户，用来筛选、过滤对象的。</li>
</ul>
<p>如果用一个简单的比喻来说呢，<strong><code>annotations</code> 就是包装盒里的产品说明书，而 <code>labels</code> 是包装盒外的标签贴纸</strong>。</p>
<p>借助 <code>annotations</code>，Kubernetes既不破坏对象的结构，也不用新增字段，就能够给API对象添加任意的附加信息，这就是面向对象设计中典型的OCP“开闭原则”，让对象更具扩展性和灵活性。</p>
<p><code>annotations</code> 里的值可以任意写，Kubernetes会自动忽略不理解的Key-Value，但要编写更新说明就需要使用特定的字段 <code>kubernetes.io/change-cause</code>。</p>
<p>下面来操作一下，我们创建3个版本的Nginx应用，同时添加更新说明：</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: ngx-dep
  annotations:
    kubernetes.io/change-cause: v1, ngx=1.21
... ...


apiVersion: apps/v1
kind: Deployment
metadata:
  name: ngx-dep
  annotations:
    kubernetes.io/change-cause: update to v2, ngx=1.22
... ...


apiVersion: apps/v1
kind: Deployment
metadata:
  name: ngx-dep
  annotations:
    kubernetes.io/change-cause: update to v3, change name
... ...
</code></pre>
<p>你需要注意YAML里的 <code>metadata</code> 部分，使用 <code>annotations.kubernetes.io/change-cause</code> 描述了版本更新的情况，相比 <code>kubectl rollout history --revision</code> 的罗列大量信息更容易理解。</p>
<p>依次使用 <code>kubectl apply</code> 创建并更新对象之后，我们再用 <code>kubectl rollout history</code> 来看一下更新历史：</p>
<p><img alt="图片" src="assets/74bcc2020yy6b121634b3cbf972fe669.png"/></p>
<p>这次显示的列表信息就好看多了，每个版本的主要变动情况列得非常清楚，和Git版本管理的感觉很像。</p>
<h2 id="小结">小结</h2>
<p>好，今天我们一起学习了Kubernetes里的高级应用管理功能：滚动更新，它会自动缩放新旧版本的Pod数量，能够在用户无感知的情况下实现服务升级或降级，让原本复杂棘手的运维工作变得简单又轻松。</p>
<p>再小结一下今天的要点：</p>
<ol>
<li>在Kubernetes里应用的版本不仅仅是容器镜像，而是整个Pod模板，为了便于处理使用了摘要算法，计算模板的Hash值作为版本号。</li>
<li>Kubernetes更新应用采用的是滚动更新策略，减少旧版本Pod的同时增加新版本Pod，保证在更新过程中服务始终可用。</li>
<li>管理应用更新使用的命令是 <code>kubectl rollout</code>，子命令有 <code>status</code>、<code>history</code>、<code>undo</code> 等。</li>
<li>Kubernetes会记录应用的更新历史，可以使用 <code>history --revision</code> 查看每个版本的详细信息，也可以在每次更新时添加注解 <code>kubernetes.io/change-cause</code>。</li>
</ol>
<p>另外，在Deployment里还有其他一些字段可以对滚动更新的过程做更细致的控制，它们都在 <code>spec.strategy.rollingUpdate</code> 里，比如 <code>maxSurge</code>、<code>maxUnavailable</code> 等字段，分别控制最多新增Pod数和最多不可用Pod数，一般用默认值就足够了，你如果感兴趣也可以查看Kubernetes文档进一步研究。</p>
<h2 id="课下作业">课下作业</h2>
<p>最后是课下作业时间，给你留两个思考题：</p>
<ol>
<li>今天学的Kubernetes的“滚动更新”，与我们常说的“灰度发布”有什么相同点和不同点？</li>
<li>直接部署旧版本的YAML也可以实现版本回退，<code>kubectl rollout undo</code> 命令的好处是什么？</li>
</ol>
<p>欢迎在留言区积极参与讨论。如果觉得今天的内容对你有帮助，也欢迎转发给身边的朋友一起讨论，我们下节课再见。</p>
<p><img alt="图片" src="assets/55154596ba524615a36601c7fdeb9af8.jpg"/></p>
</div>
</div>
<div>
<div id="prePage" style="float: left">
</div>
<div id="nextPage" style="float: right">
</div>
</div>
</div>
</div>
</div>
<div class="copyright">
<hr/>
<p>© 2019 - 2023 <a href="/cdn-cgi/l/email-protection#402c2c2c79747171707700272d21292c6e232f2d" target="_blank">Liangliang Lee</a>.
                    Powered by <a href="https://github.com/gin-gonic/gin" target="_blank">gin</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p>
</div>
</div>
<a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'935865ba8b3642bb',t:'MTc0NTUyNzAzNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script src="/static/index.js"></script>
</head></html>